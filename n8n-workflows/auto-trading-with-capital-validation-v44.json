{
  "name": "auto-trading-with-capital-validation-v44",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours"
            }
          ]
        }
      },
      "id": "0f63aa15-a61a-4ca4-bc4f-6290819beb42",
      "name": "1 Hour Interval Trigger",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        -1600,
        112
      ]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "SUPABASE_URL",
              "value": "={{$env.SUPABASE_URL || 'https://hznkyaomtrpzcayayayh.supabase.co'}}"
            },
            {
              "name": "SUPABASE_SERVICE_ROLE_KEY",
              "value": "={{$env.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "KIWOOM_APP_KEY",
              "value": "S0FEQ8I3UYwgcEPepJrfO6NteTCziz4540NljbYIASU"
            },
            {
              "name": "KIWOOM_APP_SECRET",
              "value": "tBh2TG4i0nwvKMC5s_DCVSlnWec3pgvLEmxIqL2RDsA"
            },
            {
              "name": "DEBUG_INFO",
              "value": "v44: Hardcoded Keys + Mock API (mockapi.kiwoom.com)"
            }
          ]
        },
        "options": {}
      },
      "id": "dc6caa47-df12-4158-ad3e-a87ce3b0b3eb",
      "name": "Env Config",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        -1408,
        112
      ]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{new Date().getHours()}}",
              "operation": "largerEqual",
              "value2": 9
            },
            {
              "value1": "={{new Date().getHours()}}",
              "operation": "smallerEqual",
              "value2": 15
            },
            {
              "value1": "={{new Date().getDay()}}",
              "operation": "largerEqual",
              "value2": 1
            },
            {
              "value1": "={{new Date().getDay()}}",
              "operation": "smallerEqual",
              "value2": 5
            }
          ]
        }
      },
      "id": "07c68e92-046e-46fa-858a-87fdc78b89c9",
      "name": "ì¥ì‹œê°„ ì²´í¬ (09:00~15:30, ì›”~ê¸ˆ)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        -1200,
        112
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mockapi.kiwoom.com/oauth2/token",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json;charset=UTF-8"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"grant_type\": \"client_credentials\",\n  \"appkey\": \"{{$('Env Config').first().json[\"KIWOOM_APP_KEY\"]}}\",\n  \"secretkey\": \"{{$('Env Config').first().json[\"KIWOOM_APP_SECRET\"]}}\"\n}",
        "options": {}
      },
      "id": "5f11526c-1710-415d-80f4-35bbe959b958",
      "name": "í‚¤ì›€ í† í° ë°œê¸‰",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -992,
        96
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Env Config').first().json[\"SUPABASE_URL\"] + '/rest/v1/rpc/get_active_strategies_with_universe' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$('Env Config').first().json[\"SUPABASE_SERVICE_ROLE_KEY\"]}}"
            },
            {
              "name": "Authorization",
              "value": "={{'Bearer ' + $('Env Config').first().json[\"SUPABASE_SERVICE_ROLE_KEY\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{}",
        "options": {}
      },
      "id": "ad60c24f-58de-4e19-9905-a5b8be8237c5",
      "name": "ìë™ë§¤ë§¤ ì „ëµ ì¡°íšŒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -800,
        112
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst envVars = $('Env Config').first().json;\nconst tokenData = $('í‚¤ì›€ í† í° ë°œê¸‰').first().json;\n\nconst results = [];\n\nfor (const item of items) {\n  const strategy = item.json;\n  let stockCodes = [];\n\n  if (strategy.filtered_stocks) {\n    if (Array.isArray(strategy.filtered_stocks)) {\n      stockCodes = strategy.filtered_stocks.filter(code => code && typeof code === 'string');\n    } else if (typeof strategy.filtered_stocks === 'object') {\n      stockCodes = Object.values(strategy.filtered_stocks).filter(code => code && typeof code === 'string');\n    }\n  }\n\n  stockCodes.forEach((stockCode, index) => {\n    results.push({\n      json: {\n        stock_code: stockCode,\n        index: index,\n        total: stockCodes.length,\n        strategy_id: strategy.strategy_id,\n        strategy_name: strategy.strategy_name,\n        access_token: tokenData.access_token || tokenData.token,\n        debug_token_response: tokenData,\n        SUPABASE_URL: envVars.SUPABASE_URL,\n        SUPABASE_SERVICE_ROLE_KEY: envVars.SUPABASE_SERVICE_ROLE_KEY\n      }\n    });\n  });\n}\n\nconsole.log(`ğŸ“Š Total stocks to process: ${results.length}`);\nreturn results;"
      },
      "id": "f7cad130-1fdb-43e6-8c4d-2d6f7efd74d1",
      "name": "ì¢…ëª© ì½”ë“œ ì¶”ì¶œ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -608,
        112
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mockapi.kiwoom.com/api/dostk/mrkcond",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json;charset=UTF-8"
            },
            {
              "name": "authorization",
              "value": "={{'Bearer ' + $json.access_token}}"
            },
            {
              "name": "cont-yn",
              "value": "N"
            },
            {
              "name": "next-key"
            },
            {
              "name": "api-id",
              "value": "ka10004"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"stk_cd\": \"{{$json.stock_code}}\"}",
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1,
              "batchInterval": 60000
            }
          },
          "response": {
            "response": {}
          }
        }
      },
      "id": "923a0041-0e75-4cd3-b575-eff505881b22",
      "name": "í‚¤ì›€ í˜¸ê°€ ì¡°íšŒ (60ì´ˆ ê°„ê²©)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        -400,
        112
      ]
    },
    {
      "parameters": {
        "jsCode": "// HTTP RequestëŠ” ì‘ë‹µë§Œ ë°˜í™˜í•˜ë¯€ë¡œ, ì…ë ¥ ë°ì´í„°ë¥¼ ë³µì›\nconst kiwoomResponses = $input.all();\nconst originalInputs = $('ì¢…ëª© ì½”ë“œ ì¶”ì¶œ').all();\n\nconst results = [];\n\n// ëª¨ë“  í•­ëª© ì²˜ë¦¬\nfor (let i = 0; i < kiwoomResponses.length; i++) {\n  const kiwoomResponse = kiwoomResponses[i].json;\n  const original = originalInputs[i];\n\n  if (!original) {\n    console.error(`Cannot find original data for item ${i}`);\n    continue;\n  }\n\n  console.log(`Processing: ${original.json.stock_code} (${i + 1}/${originalInputs.length})`);\n\n  results.push({\n    json: {\n      ...original.json,\n      kiwoom_data: kiwoomResponse\n    }\n  });\n}\n\nreturn results;"
      },
      "id": "d1359c2a-199b-408b-8109-3d6564c77b4f",
      "name": "ì›ë³¸ ë°ì´í„° ë³‘í•©",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -208,
        112
      ]
    },
    {
      "parameters": {
        "url": "={{$('Env Config').first().json[\"SUPABASE_URL\"]}}/rest/v1/stock_metadata?stock_code=eq.{{$json.stock_code}}&select=stock_name,stock_code",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$('Env Config').first().json[\"SUPABASE_SERVICE_ROLE_KEY\"]}}"
            },
            {
              "name": "Authorization",
              "value": "={{'Bearer ' + $('Env Config').first().json[\"SUPABASE_SERVICE_ROLE_KEY\"]}}"
            }
          ]
        },
        "options": {}
      },
      "id": "555afdec-901b-4da1-923a-8e0abf28f35f",
      "name": "ì¢…ëª©ëª… ì¡°íšŒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        0,
        0
      ]
    },
    {
      "parameters": {
        "url": "={{$('Env Config').first().json[\"SUPABASE_URL\"]}}/rest/v1/kw_price_daily?stock_code=eq.{{$json.stock_code}}&select=close&order=trade_date.desc&limit=1",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$('Env Config').first().json[\"SUPABASE_SERVICE_ROLE_KEY\"]}}"
            },
            {
              "name": "Authorization",
              "value": "={{'Bearer ' + $('Env Config').first().json[\"SUPABASE_SERVICE_ROLE_KEY\"]}}"
            }
          ]
        },
        "options": {}
      },
      "id": "c24d1f59-8b65-4f03-85ca-d3bbc61a6930",
      "name": "ì „ì¼ì¢…ê°€ ì¡°íšŒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        200,
        112
      ]
    },
    {
      "parameters": {
        "jsCode": "// ëª¨ë“  ì…ë ¥ ì•„ì´í…œ ì²˜ë¦¬\nconst mergedData = $('ì›ë³¸ ë°ì´í„° ë³‘í•©').all();\nconst stockNameResults = $('ì¢…ëª©ëª… ì¡°íšŒ').all();\nconst prevCloseResults = $('ì „ì¼ì¢…ê°€ ì¡°íšŒ').all();\n\nconst results = [];\n\nfor (let i = 0; i < mergedData.length; i++) {\n  const stockData = mergedData[i].json;\n  const kiwoomPrice = stockData.kiwoom_data;\n  \n  // Supabase ì‘ë‹µì€ ë°°ì—´ í˜•íƒœ [ { ... } ] ì´ë¯€ë¡œ ì²« ë²ˆì§¸ ìš”ì†Œë¥¼ ê°€ì ¸ì˜´\n  const stockNameArr = stockNameResults[i]?.json;\n  const prevCloseArr = prevCloseResults[i]?.json;\n  \n  // ë°°ì—´ì¸ì§€ í™•ì¸ í›„ ë°ì´í„° ì¶”ì¶œ\n  const stockNameObj = Array.isArray(stockNameArr) ? stockNameArr[0] : stockNameArr;\n  const prevCloseObj = Array.isArray(prevCloseArr) ? prevCloseArr[0] : prevCloseArr;\n\n  // ë””ë²„ê¹…\n  // console.log(`[${i}] stockNameObj:`, JSON.stringify(stockNameObj));\n  \n  let stockName = stockData.stock_code; // ê¸°ë³¸ê°’\n  \n  if (stockNameObj && stockNameObj.stock_name) {\n    stockName = stockNameObj.stock_name;\n  }\n\n  const previousClose = (prevCloseObj && prevCloseObj.close) \n    ? parseFloat(prevCloseObj.close) \n    : 0;\n\n  const parsePrice = (price) => {\n    if (!price) return 0;\n    return parseFloat(String(price).replace(/[+\\-]/g, ''));\n  };\n\n  const selPrice = parsePrice(kiwoomPrice.sel_fpr_bid);\n  const buyPrice = parsePrice(kiwoomPrice.buy_fpr_bid);\n  const estimatedPrice = (selPrice + buyPrice) / 2;\n\n  // âš ï¸ ê°€ê²© ê²€ì¦ (ë””ë²„ê¹…ì„ ìœ„í•´ ì£¼ì„ ì²˜ë¦¬)\n  // if (estimatedPrice === 0 || selPrice === 0 || buyPrice === 0) {\n  //   continue;\n  // }\n\n  const changePrice = previousClose > 0 ? estimatedPrice - previousClose : 0;\n  const changeRate = previousClose > 0 ? ((changePrice / previousClose) * 100) : 0;\n\n  // if (changeRate === -100 || changeRate < -50) {\n  //   continue;\n  // }\n\n  const selVolume = parseInt(String(kiwoomPrice.sel_fpr_req || 0).replace(/[+\\-]/g, '')) || 0;\n  const buyVolume = parseInt(String(kiwoomPrice.buy_fpr_req || 0).replace(/[+\\-]/g, '')) || 0;\n\n  const result = {\n    stock_code: stockData.stock_code,\n    stock_name: stockName,\n    current_price: estimatedPrice,\n    change_price: changePrice,\n    change_rate: changeRate,\n    volume: selVolume + buyVolume,\n    sel_price: selPrice,\n    buy_price: buyPrice,\n    SUPABASE_URL: stockData.SUPABASE_URL,\n    SUPABASE_SERVICE_ROLE_KEY: stockData.SUPABASE_SERVICE_ROLE_KEY,\n    index: i,\n    total: mergedData.length,\n    debug_kiwoom: kiwoomPrice,\n    debug_prev_close: prevCloseObj,\n    debug_token_used: stockData.access_token,\n    debug_token_response: stockData.debug_token_response\n  };\n\n  results.push({ json: result });\n}\n\nreturn results;"
      },
      "id": "2792b5aa-ccc1-4be3-92d2-6a238ca03667",
      "name": "ìµœì¢… ê³„ì‚° + ê°€ê²© ê²€ì¦",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        112
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$('Env Config').first().json[\"SUPABASE_URL\"]}}/rest/v1/kw_stock_master?on_conflict=stock_code",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$('Env Config').first().json[\"SUPABASE_SERVICE_ROLE_KEY\"]}}"
            },
            {
              "name": "Authorization",
              "value": "={{'Bearer ' + $('Env Config').first().json[\"SUPABASE_SERVICE_ROLE_KEY\"]}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates,return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"stock_code\": {{JSON.stringify($json.stock_code)}}, \"stock_name\": {{JSON.stringify($json.stock_name)}}, \"market\": \"KOSPI\"}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "d32a46f1-51c9-46fa-895e-38de62b666c4",
      "name": "ì¢…ëª© ë§ˆìŠ¤í„° ì €ì¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        600,
        112
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$('Env Config').first().json[\"SUPABASE_URL\"]}}/rest/v1/kw_price_current?on_conflict=stock_code",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$('Env Config').first().json[\"SUPABASE_SERVICE_ROLE_KEY\"]}}"
            },
            {
              "name": "Authorization",
              "value": "={{'Bearer ' + $('Env Config').first().json[\"SUPABASE_SERVICE_ROLE_KEY\"]}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates,return=representation"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"stock_code\": {{JSON.stringify($('ìµœì¢… ê³„ì‚° + ê°€ê²© ê²€ì¦').item.json.stock_code)}}, \"stock_name\": {{JSON.stringify($('ìµœì¢… ê³„ì‚° + ê°€ê²© ê²€ì¦').item.json.stock_name)}}, \"current_price\": {{$('ìµœì¢… ê³„ì‚° + ê°€ê²© ê²€ì¦').item.json.current_price}}, \"change_price\": {{$('ìµœì¢… ê³„ì‚° + ê°€ê²© ê²€ì¦').item.json.change_price}}, \"change_rate\": {{$('ìµœì¢… ê³„ì‚° + ê°€ê²© ê²€ì¦').item.json.change_rate}}, \"volume\": {{$('ìµœì¢… ê³„ì‚° + ê°€ê²© ê²€ì¦').item.json.volume}}, \"high_52w\": {{$('ìµœì¢… ê³„ì‚° + ê°€ê²© ê²€ì¦').item.json.sel_price}}, \"low_52w\": {{$('ìµœì¢… ê³„ì‚° + ê°€ê²© ê²€ì¦').item.json.buy_price}}, \"market_cap\": 0, \"updated_at\": \"now()\"}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "d1762f07-69e5-478e-ad12-7912d1e47ad9",
      "name": "í˜„ì¬ê°€ ì €ì¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        800,
        112
      ]
    }
  ],
  "pinData": {},
  "connections": {
    "1 Hour Interval Trigger": {
      "main": [
        [
          {
            "node": "Env Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Env Config": {
      "main": [
        [
          {
            "node": "ì¥ì‹œê°„ ì²´í¬ (09:00~15:30, ì›”~ê¸ˆ)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì¥ì‹œê°„ ì²´í¬ (09:00~15:30, ì›”~ê¸ˆ)": {
      "main": [
        [
          {
            "node": "í‚¤ì›€ í† í° ë°œê¸‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "í‚¤ì›€ í† í° ë°œê¸‰": {
      "main": [
        [
          {
            "node": "ìë™ë§¤ë§¤ ì „ëµ ì¡°íšŒ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ìë™ë§¤ë§¤ ì „ëµ ì¡°íšŒ": {
      "main": [
        [
          {
            "node": "ì¢…ëª© ì½”ë“œ ì¶”ì¶œ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì¢…ëª© ì½”ë“œ ì¶”ì¶œ": {
      "main": [
        [
          {
            "node": "í‚¤ì›€ í˜¸ê°€ ì¡°íšŒ (60ì´ˆ ê°„ê²©)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "í‚¤ì›€ í˜¸ê°€ ì¡°íšŒ (60ì´ˆ ê°„ê²©)": {
      "main": [
        [
          {
            "node": "ì›ë³¸ ë°ì´í„° ë³‘í•©",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì›ë³¸ ë°ì´í„° ë³‘í•©": {
      "main": [
        [
          {
            "node": "ì¢…ëª©ëª… ì¡°íšŒ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì¢…ëª©ëª… ì¡°íšŒ": {
      "main": [
        [
          {
            "node": "ì „ì¼ì¢…ê°€ ì¡°íšŒ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì „ì¼ì¢…ê°€ ì¡°íšŒ": {
      "main": [
        [
          {
            "node": "ìµœì¢… ê³„ì‚° + ê°€ê²© ê²€ì¦",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ìµœì¢… ê³„ì‚° + ê°€ê²© ê²€ì¦": {
      "main": [
        [
          {
            "node": "ì¢…ëª© ë§ˆìŠ¤í„° ì €ì¥",
            "type": "main",
            "index": 0
          },
          {
            "node": "í˜„ì¬ê°€ ì €ì¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "f2868469-8260-496e-953a-c8e8880e038e",
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "6a964998707168341e30932026857643b22b72445e994e6377e87042013895e6"
  }
}
