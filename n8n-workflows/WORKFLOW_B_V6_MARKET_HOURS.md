# 워크플로우 B v6 - 시장 운영시간 체크 추가

## 📋 업데이트 내용

v6 워크플로우에 **시장 운영시간 체크** 노드를 추가하여 주식 장이 열린 시간에만 자동매매가 실행되도록 개선했습니다.

## 🎯 목적

자동매매 워크플로우는 주식시장이 열려있을 때만 의미가 있으므로:
- ⏸️ **주말**: 토요일, 일요일에는 실행하지 않음
- ⏸️ **장 시작 전**: 09:00 이전에는 실행하지 않음
- ⏸️ **장 마감 후**: 15:30 이후에는 실행하지 않음
- ✅ **장 운영시간**: 평일 09:00 ~ 15:30에만 실행

## 🔧 추가된 노드

### 시장 운영시간 체크 (Code Node)

**위치**: "5분마다 실행" 트리거 바로 다음

**동작**:
```
5분마다 실행 → 시장 운영시간 체크 → 환경변수 설정 → ...
```

**코드 로직**:

```javascript
// 한국 시간으로 현재 시간 가져오기
const now = new Date();
const koreaTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));

const hour = koreaTime.getHours();
const minute = koreaTime.getMinutes();
const day = koreaTime.getDay(); // 0=일요일, 6=토요일

console.log(`🕐 현재 한국 시간: ${koreaTime.toLocaleString('ko-KR')} (${hour}시 ${minute}분, 요일: ${day})`);

// 1. 주말 체크
if (day === 0 || day === 6) {
  console.log('⏸️ 주말 - 워크플로우 중단');
  return [];  // 빈 배열 반환 = 워크플로우 중단
}

// 2. 장 운영시간 체크 (09:00 ~ 15:30)
const totalMinutes = hour * 60 + minute;
const marketOpen = 9 * 60;      // 09:00 = 540분
const marketClose = 15 * 60 + 30; // 15:30 = 930분

if (totalMinutes < marketOpen) {
  console.log(`⏸️ 장 시작 전 (${hour}:${minute}) - 워크플로우 중단`);
  return [];
}

if (totalMinutes >= marketClose) {
  console.log(`⏸️ 장 마감 후 (${hour}:${minute}) - 워크플로우 중단`);
  return [];
}

// 3. 장 운영시간 - 계속 진행
console.log(`✅ 장 운영시간 (${hour}:${minute}) - 워크플로우 계속 진행`);
return [{ json: { market_open: true, current_time: koreaTime.toISOString() } }];
```

## 📊 시간대별 동작

### 평일 09:00 이전

```
08:55 - 5분 트리거 실행
  ↓
시장 운영시간 체크
  ↓
⏸️ 장 시작 전 - 워크플로우 중단
  ↓
(이후 노드 실행 안 됨)
```

**로그**:
```
🕐 현재 한국 시간: 2025-01-13 08:55 (8시 55분, 요일: 1)
⏸️ 장 시작 전 (8:55) - 워크플로우 중단
```

### 평일 09:00 ~ 15:30 (장 운영시간)

```
10:00 - 5분 트리거 실행
  ↓
시장 운영시간 체크
  ↓
✅ 장 운영시간 - 계속 진행
  ↓
환경변수 설정 → 전략 조회 → ... (정상 실행)
```

**로그**:
```
🕐 현재 한국 시간: 2025-01-13 10:00 (10시 0분, 요일: 1)
✅ 장 운영시간 (10:00) - 워크플로우 계속 진행
```

### 평일 15:30 이후

```
15:35 - 5분 트리거 실행
  ↓
시장 운영시간 체크
  ↓
⏸️ 장 마감 후 - 워크플로우 중단
  ↓
(이후 노드 실행 안 됨)
```

**로그**:
```
🕐 현재 한국 시간: 2025-01-13 15:35 (15시 35분, 요일: 1)
⏸️ 장 마감 후 (15:35) - 워크플로우 중단
```

### 주말 (토요일, 일요일)

```
10:00 - 5분 트리거 실행 (토요일)
  ↓
시장 운영시간 체크
  ↓
⏸️ 주말 - 워크플로우 중단
  ↓
(이후 노드 실행 안 됨)
```

**로그**:
```
🕐 현재 한국 시간: 2025-01-18 10:00 (10시 0분, 요일: 6)
⏸️ 주말 - 워크플로우 중단
```

## 🔄 워크플로우 구조 변경

### 수정 전
```
5분마다 실행 → 환경변수 설정 → 활성 전략 조회 → ...
```

### 수정 후
```
5분마다 실행 → 시장 운영시간 체크 → 환경변수 설정 → 활성 전략 조회 → ...
                      ↓
                  (장외 시간)
                  워크플로우 중단
```

## 💡 장점

### 1. API 호출 절약
- 장외 시간에는 Supabase, 키움 API를 전혀 호출하지 않음
- 불필요한 비용 절감

### 2. 리소스 효율성
- n8n 서버 리소스 절약
- 데이터베이스 부하 감소

### 3. 로그 가독성
- 장외 시간에는 간단한 로그만 출력
- 실제 매매 로그와 분리되어 디버깅 용이

### 4. 의미 없는 주문 방지
- 주말이나 장 마감 후 주문 생성 방지
- 데이터 정합성 유지

## 🧪 테스트 방법

### 1. 주말 테스트

n8n UI에서 "5분마다 실행" 노드를 수동 실행 (토요일 또는 일요일):

**예상 결과**:
```
🕐 현재 한국 시간: 2025-01-18 14:30 (14시 30분, 요일: 6)
⏸️ 주말 - 워크플로우 중단
```

노드는 녹색 체크마크가 되지만, 다음 노드로 진행하지 않음 (빈 배열 반환).

### 2. 장 시작 전 테스트

평일 08:00 ~ 09:00 사이 수동 실행:

**예상 결과**:
```
🕐 현재 한국 시간: 2025-01-13 08:30 (8시 30분, 요일: 1)
⏸️ 장 시작 전 (8:30) - 워크플로우 중단
```

### 3. 장 운영시간 테스트

평일 09:00 ~ 15:30 사이 수동 실행:

**예상 결과**:
```
🕐 현재 한국 시간: 2025-01-13 10:00 (10시 0분, 요일: 1)
✅ 장 운영시간 (10:00) - 워크플로우 계속 진행
```

"환경변수 설정" 노드로 진행하여 전체 워크플로우 실행.

### 4. 장 마감 후 테스트

평일 15:30 이후 수동 실행:

**예상 결과**:
```
🕐 현재 한국 시간: 2025-01-13 16:00 (16시 0분, 요일: 1)
⏸️ 장 마감 후 (16:00) - 워크플로우 중단
```

## 📈 실제 운영 시나리오

### 평일 하루 일과

```
08:00 - 워크플로우 중단 (장 시작 전)
08:05 - 워크플로우 중단
...
08:55 - 워크플로우 중단

09:00 - ✅ 워크플로우 실행 시작!
09:05 - ✅ 워크플로우 실행
09:10 - ✅ 워크플로우 실행
...
15:25 - ✅ 워크플로우 실행

15:30 - ⏸️ 워크플로우 중단 (장 마감)
15:35 - 워크플로우 중단
...
```

**실제 실행 횟수**:
- 09:00 ~ 15:30 = 6.5시간 = 390분
- 5분마다 실행 = 390 / 5 = **78회 실행**

### 주말

```
토요일/일요일:
00:00 ~ 23:55 - 모든 시간대에서 워크플로우 중단
```

**실행 횟수**: **0회**

## 🔧 커스터마이징

### 1. 장 운영시간 변경

예: 15:20까지만 실행하고 싶은 경우

```javascript
const marketClose = 15 * 60 + 20; // 15:20 = 920분
```

### 2. 점심시간 제외

예: 12:00 ~ 13:00 점심시간 제외

```javascript
// 점심시간 체크 추가
const lunchStart = 12 * 60;      // 12:00
const lunchEnd = 13 * 60;        // 13:00

if (totalMinutes >= lunchStart && totalMinutes < lunchEnd) {
  console.log(`⏸️ 점심시간 (${hour}:${minute}) - 워크플로우 중단`);
  return [];
}
```

### 3. 공휴일 추가

예: 특정 날짜를 공휴일로 지정

```javascript
// 공휴일 체크
const holidays = [
  '2025-01-01',  // 신정
  '2025-01-29',  // 설날 연휴
  '2025-03-01',  // 삼일절
  // ... 더 추가
];

const today = koreaTime.toISOString().split('T')[0];
if (holidays.includes(today)) {
  console.log(`⏸️ 공휴일 (${today}) - 워크플로우 중단`);
  return [];
}
```

## 🎉 결론

시장 운영시간 체크 기능을 추가하여:

1. ✅ **효율성**: 장외 시간 API 호출 0회
2. ✅ **비용 절감**: 불필요한 리소스 사용 방지
3. ✅ **안정성**: 의미 없는 주문 생성 방지
4. ✅ **유지보수성**: 로그 가독성 향상

워크플로우 B v6가 더욱 완성도 높은 자동매매 시스템이 되었습니다! 🚀
