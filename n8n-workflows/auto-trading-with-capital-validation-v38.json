{
  "name": "?êÎèôÎß§Îß§ Î™®Îãà?∞ÎßÅ v38 (Stock Name Fix)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 1
            }
          ]
        }
      },
      "id": "schedule-1",
      "name": "1?úÍ∞ÑÎßàÎã§ ?§Ìñâ",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        250,
        300
      ]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "SUPABASE_URL",
              "value": "https://hznkyaomtrpzcayayayh.supabase.co"
            },
            {
              "name": "SUPABASE_SERVICE_ROLE_KEY",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "KIWOOM_APP_KEY",
              "value": "S0FEQ8I3UYwgcEPepJrfO6NteTCziz4540NljbYIASU"
            },
            {
              "name": "KIWOOM_APP_SECRET",
              "value": "tBh2TG4i0nwvKMC5s_DCVSlnWec3pgvLEmxIqL2RDsA"
            }
          ]
        }
      },
      "id": "set-env-1",
      "name": "?òÍ≤ΩÎ≥Ä???§Ï†ï",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        450,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{1}}",
              "operation": "equal",
              "value2": 1
            }
          ]
        }
      },
      "id": "market-check-1",
      "name": "?•ÏãúÍ∞?Ï≤¥ÌÅ¨ (?åÏä§??Î™®Îìú)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        650,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mockapi.kiwoom.com/oauth2/token",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"grant_type\": \"client_credentials\",\n  \"appkey\": \"{{$node[\"?òÍ≤ΩÎ≥Ä???§Ï†ï\"].json[\"KIWOOM_APP_KEY\"]}}\",\n  \"secretkey\": \"{{$node[\"?òÍ≤ΩÎ≥Ä???§Ï†ï\"].json[\"KIWOOM_APP_SECRET\"]}}\"\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json;charset=UTF-8"
            }
          ]
        }
      },
      "id": "get-token-1",
      "name": "?§Ï? ?†ÌÅ∞ Î∞úÍ∏â",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        850,
        300
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{$node[\"?òÍ≤ΩÎ≥Ä???§Ï†ï\"].json[\"SUPABASE_URL\"]}}/rest/v1/rpc/get_active_strategies_with_universe",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "authorization",
              "value": "={{\"Bearer \" + $node[\"?òÍ≤ΩÎ≥Ä???§Ï†ï\"].json[\"SUPABASE_SERVICE_ROLE_KEY\"]}}"
            },
            {
              "name": "apikey",
              "value": "={{$node[\"?òÍ≤ΩÎ≥Ä???§Ï†ï\"].json[\"SUPABASE_SERVICE_ROLE_KEY\"]}}"
            }
          ]
        }
      },
      "id": "get-strategies-1",
      "name": "?êÎèôÎß§Îß§ ?ÑÎûµ Ï°∞Ìöå",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1050,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst envVars = $('?òÍ≤ΩÎ≥Ä???§Ï†ï').first().json;\nconst tokenData = $('?§Ï? ?†ÌÅ∞ Î∞úÍ∏â').first().json;\n\nconst results = [];\n\nfor (const item of items) {\n  const strategy = item.json;\n  let stockCodes = [];\n\n  if (strategy.filtered_stocks) {\n    if (Array.isArray(strategy.filtered_stocks)) {\n      stockCodes = strategy.filtered_stocks.filter(code => code && typeof code === 'string');\n    } else if (typeof strategy.filtered_stocks === 'object') {\n      stockCodes = Object.values(strategy.filtered_stocks).filter(code => code && typeof code === 'string');\n    }\n  }\n\n  stockCodes.forEach((stockCode, index) => {\n    results.push({\n      json: {\n        stock_code: stockCode,\n        index: index,\n        total: stockCodes.length,\n        strategy_id: strategy.strategy_id,\n        strategy_name: strategy.strategy_name,\n        access_token: tokenData.token,\n        SUPABASE_URL: envVars.SUPABASE_URL,\n        SUPABASE_SERVICE_ROLE_KEY: envVars.SUPABASE_SERVICE_ROLE_KEY\n      }\n    });\n  });\n}\n\nconsole.log(`?ìä Total stocks to process: ${results.length}`);\nreturn results;"
      },
      "id": "extract-stocks-1",
      "name": "Ï¢ÖÎ™© ÏΩîÎìú Ï∂îÏ∂ú",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1250,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mockapi.kiwoom.com/api/dostk/mrkcond",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"stk_cd\": \"{{$json.stock_code}}\"}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json;charset=UTF-8"
            },
            {
              "name": "authorization",
              "value": "={{\"Bearer \" + $json.access_token}}"
            },
            {
              "name": "cont-yn",
              "value": "N"
            },
            {
              "name": "next-key",
              "value": ""
            },
            {
              "name": "api-id",
              "value": "ka10004"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1,
              "batchInterval": 60000
            }
          },
          "response": {
            "response": {
              "fullResponse": false,
              "neverError": false,
              "responseFormat": "autodetect"
            }
          }
        }
      },
      "id": "get-price-1",
      "name": "?§Ï? ?∏Í? Ï°∞Ìöå (60Ï¥?Í∞ÑÍ≤©)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1450,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// HTTP Request???ëÎãµÎß?Î∞òÌôò?òÎ?Î°? ?ÖÎ†• ?∞Ïù¥?∞Î? Î≥µÏõê\nconst kiwoomResponses = $input.all();\nconst originalInputs = $('Ï¢ÖÎ™© ÏΩîÎìú Ï∂îÏ∂ú').all();\n\nconst results = [];\n\n// Î™®Îì† ??™© Ï≤òÎ¶¨\nfor (let i = 0; i < kiwoomResponses.length; i++) {\n  const kiwoomResponse = kiwoomResponses[i].json;\n  const original = originalInputs[i];\n\n  if (!original) {\n    console.error(`Cannot find original data for item ${i}`);\n    continue;\n  }\n\n  console.log(`Processing: ${original.json.stock_code} (${i + 1}/${originalInputs.length})`);\n\n  results.push({\n    json: {\n      ...original.json,\n      kiwoom_data: kiwoomResponse\n    }\n  });\n}\n\nreturn results;"
      },
      "id": "merge-orig-data",
      "name": "?êÎ≥∏ ?∞Ïù¥??Î≥ëÌï©",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1650,
        300
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{$json.SUPABASE_URL}}/rest/v1/stock_metadata?stock_code=eq.{{$json.stock_code}}&select=stock_name",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$json.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "={{\"Bearer \" + $json.SUPABASE_SERVICE_ROLE_KEY}}"
            }
          ]
        }
      },
      "id": "get-stock-name",
      "name": "Ï¢ÖÎ™©Î™?Ï°∞Ìöå",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1850,
        200
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{$('?êÎ≥∏ ?∞Ïù¥??Î≥ëÌï©').item.json.SUPABASE_URL}}/rest/v1/kw_price_daily?stock_code=eq.{{$('?êÎ≥∏ ?∞Ïù¥??Î≥ëÌï©').item.json.stock_code}}&select=close&order=trade_date.desc&limit=1",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$('?êÎ≥∏ ?∞Ïù¥??Î≥ëÌï©').item.json.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "={{\"Bearer \" + $('?êÎ≥∏ ?∞Ïù¥??Î≥ëÌï©').item.json.SUPABASE_SERVICE_ROLE_KEY}}"
            }
          ]
        }
      },
      "id": "get-prev-close",
      "name": "?ÑÏùºÏ¢ÖÍ? Ï°∞Ìöå",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1850,
        400
      ]
    },
    {
      "parameters": {
        "jsCode": "// Î™®Îì† ?ÖÎ†• ?ÑÏù¥??Ï≤òÎ¶¨\nconst mergedData = $('?êÎ≥∏ ?∞Ïù¥??Î≥ëÌï©').all();\nconst stockNameResults = $('Ï¢ÖÎ™©Î™?Ï°∞Ìöå').all();\nconst prevCloseResults = $('?ÑÏùºÏ¢ÖÍ? Ï°∞Ìöå').all();\n\nconst results = [];\n\nfor (let i = 0; i < mergedData.length; i++) {\n  const stockData = mergedData[i].json;\n  const kiwoomPrice = stockData.kiwoom_data;\n  \n  // n8n HTTP Request ?∏Îìú??Supabase Î∞∞Ïó¥ ?ëÎãµ??Í∞úÎ≥Ñ ?ÑÏù¥?úÏúºÎ°?Î∂ÑÎ¶¨??n  const stockNameData = stockNameResults[i]?.json;\n  const prevCloseData = prevCloseResults[i]?.json;\n\n  // ?îÎ≤ÑÍπ?n  console.log(`[${i}] stockNameData:`, JSON.stringify(stockNameData));\n  \n  // HTTP Request ?∏ÎìúÍ∞Ä Î∞∞Ïó¥???Ä?¥ÏÑú Î∞òÌôò?òÎ?Î°?ÏßÅÏ†ë ?ëÍ∑º\n  let stockName = stockData.stock_code; // Í∏∞Î≥∏Í∞?n  \n  if (stockNameData && stockNameData.stock_name) {\n    stockName = stockNameData.stock_name;\n    console.log(`[${i}] Found stock_name: ${stockName}`);\n  } else {\n    console.log(`[${i}] stockNameData not found or invalid:`, JSON.stringify(stockNameData));\n  }\n\n  const previousClose = (prevCloseData && prevCloseData.close) \n    ? parseFloat(prevCloseData.close) \n    : 0;\n\n  const parsePrice = (price) => {\n    if (!price) return 0;\n    return parseFloat(String(price).replace(/[+\\-]/g, ''));\n  };\n\n  const selPrice = parsePrice(kiwoomPrice.sel_fpr_bid);\n  const buyPrice = parsePrice(kiwoomPrice.buy_fpr_bid);\n  const estimatedPrice = (selPrice + buyPrice) / 2;\n\n  const changePrice = previousClose > 0 ? estimatedPrice - previousClose : 0;\n  const changeRate = previousClose > 0 ? ((changePrice / previousClose) * 100) : 0;\n\n  const selVolume = parseInt(String(kiwoomPrice.sel_fpr_req || 0).replace(/[+\\-]/g, '')) || 0;\n  const buyVolume = parseInt(String(kiwoomPrice.buy_fpr_req || 0).replace(/[+\\-]/g, '')) || 0;\n\n  const result = {\n    stock_code: stockData.stock_code,\n    stock_name: stockName,\n    current_price: estimatedPrice,\n    change_price: changePrice,\n    change_rate: changeRate,\n    volume: selVolume + buyVolume,\n    sel_price: selPrice,\n    buy_price: buyPrice,\n    SUPABASE_URL: stockData.SUPABASE_URL,\n    SUPABASE_SERVICE_ROLE_KEY: stockData.SUPABASE_SERVICE_ROLE_KEY,\n    index: i,\n    total: mergedData.length\n  };\n\n  console.log(`[${i + 1}/${mergedData.length}] ${result.stock_code} (${result.stock_name}): ${result.current_price.toLocaleString()}??);\n\n  results.push({ json: result });\n}\n\nreturn results;"
      },
      "id": "calc-final",
      "name": "ÏµúÏ¢Ö Í≥ÑÏÇ∞",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2050,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$json.SUPABASE_URL}}/rest/v1/kw_stock_master?on_conflict=stock_code",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"stock_code\": {{JSON.stringify($json.stock_code)}}, \"stock_name\": {{JSON.stringify($json.stock_name)}}, \"market\": \"KOSPI\"}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$json.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "={{\"Bearer \" + $json.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates,return=representation"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "save-master",
      "name": "Ï¢ÖÎ™© ÎßàÏä§???Ä??,
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        2250,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$('ÏµúÏ¢Ö Í≥ÑÏÇ∞').item.json.SUPABASE_URL}}/rest/v1/kw_price_current?on_conflict=stock_code",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"stock_code\": {{JSON.stringify($('ÏµúÏ¢Ö Í≥ÑÏÇ∞').item.json.stock_code)}}, \"stock_name\": {{JSON.stringify($('ÏµúÏ¢Ö Í≥ÑÏÇ∞').item.json.stock_name)}}, \"current_price\": {{$('ÏµúÏ¢Ö Í≥ÑÏÇ∞').item.json.current_price}}, \"change_price\": {{$('ÏµúÏ¢Ö Í≥ÑÏÇ∞').item.json.change_price}}, \"change_rate\": {{$('ÏµúÏ¢Ö Í≥ÑÏÇ∞').item.json.change_rate}}, \"volume\": {{$('ÏµúÏ¢Ö Í≥ÑÏÇ∞').item.json.volume}}, \"high_52w\": {{$('ÏµúÏ¢Ö Í≥ÑÏÇ∞').item.json.sel_price}}, \"low_52w\": {{$('ÏµúÏ¢Ö Í≥ÑÏÇ∞').item.json.buy_price}}, \"market_cap\": 0, \"updated_at\": \"now()\"}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$('ÏµúÏ¢Ö Í≥ÑÏÇ∞').item.json.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "={{\"Bearer \" + $('ÏµúÏ¢Ö Í≥ÑÏÇ∞').item.json.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates,return=representation"
            }
          ]
        },
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "save-current",
      "name": "?ÑÏû¨Í∞Ä ?Ä??,
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        2450,
        300
      ]
    }
  ],
  "connections": {
    "1?úÍ∞ÑÎßàÎã§ ?§Ìñâ": {
      "main": [
        [
          {
            "node": "?òÍ≤ΩÎ≥Ä???§Ï†ï",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "?òÍ≤ΩÎ≥Ä???§Ï†ï": {
      "main": [
        [
          {
            "node": "?•ÏãúÍ∞?Ï≤¥ÌÅ¨ (?åÏä§??Î™®Îìú)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "?•ÏãúÍ∞?Ï≤¥ÌÅ¨ (?åÏä§??Î™®Îìú)": {
      "main": [
        [
          {
            "node": "?§Ï? ?†ÌÅ∞ Î∞úÍ∏â",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "?§Ï? ?†ÌÅ∞ Î∞úÍ∏â": {
      "main": [
        [
          {
            "node": "?êÎèôÎß§Îß§ ?ÑÎûµ Ï°∞Ìöå",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "?êÎèôÎß§Îß§ ?ÑÎûµ Ï°∞Ìöå": {
      "main": [
        [
          {
            "node": "Ï¢ÖÎ™© ÏΩîÎìú Ï∂îÏ∂ú",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ï¢ÖÎ™© ÏΩîÎìú Ï∂îÏ∂ú": {
      "main": [
        [
          {
            "node": "?§Ï? ?∏Í? Ï°∞Ìöå (60Ï¥?Í∞ÑÍ≤©)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "?§Ï? ?∏Í? Ï°∞Ìöå (60Ï¥?Í∞ÑÍ≤©)": {
      "main": [
        [
          {
            "node": "?êÎ≥∏ ?∞Ïù¥??Î≥ëÌï©",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "?êÎ≥∏ ?∞Ïù¥??Î≥ëÌï©": {
      "main": [
        [
          {
            "node": "Ï¢ÖÎ™©Î™?Ï°∞Ìöå",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ï¢ÖÎ™©Î™?Ï°∞Ìöå": {
      "main": [
        [
          {
            "node": "?ÑÏùºÏ¢ÖÍ? Ï°∞Ìöå",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "?ÑÏùºÏ¢ÖÍ? Ï°∞Ìöå": {
      "main": [
        [
          {
            "node": "ÏµúÏ¢Ö Í≥ÑÏÇ∞",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÏµúÏ¢Ö Í≥ÑÏÇ∞": {
      "main": [
        [
          {
            "node": "Ï¢ÖÎ™© ÎßàÏä§???Ä??,
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ï¢ÖÎ™© ÎßàÏä§???Ä??: {
      "main": [
        [
          {
            "node": "?ÑÏû¨Í∞Ä ?Ä??,
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveExecutionProgress": true,
    "executionTimeout": 3600
  }
}
