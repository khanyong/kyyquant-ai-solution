{
  "name": "AWS - ì‹œì¥ í˜„ì¬ê°€ ì—…ë°ì´íŠ¸ V4-1 (ëª¨ì˜íˆ¬ììš©)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 10
            }
          ]
        }
      },
      "id": "trigger",
      "name": "1ë¶„ë§ˆë‹¤ ì‹¤í–‰",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "SUPABASE_URL",
              "value": "={{$env.SUPABASE_URL || 'https://hznkyaomtrpzcayayayh.supabase.co'}}"
            },
            {
              "name": "SUPABASE_SERVICE_ROLE_KEY",
              "value": "={{$env.SUPABASE_SERVICE_KEY}}"
            },
            {
              "name": "SUPABASE_ANON_KEY",
              "value": "={{$env.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "KIWOOM_APP_KEY",
              "value": "={{$env.KIWOOM_APP_KEY}}"
            },
            {
              "name": "KIWOOM_APP_SECRET",
              "value": "={{$env.KIWOOM_APP_SECRET}}"
            },
            {
              "name": "BACKEND_API_URL",
              "value": "http://auto-stock-backend:8001"
            }
          ]
        },
        "options": {}
      },
      "id": "env-config",
      "name": "Env Config",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $('Env Config').first().json[\"BACKEND_API_URL\"] + '/api/market/market-status' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "id": "check-market-status",
      "name": "ì¥ ìš´ì˜ ìƒíƒœ ì¡°íšŒ (API)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ $json.is_open }}",
              "value2": true
            }
          ]
        }
      },
      "id": "if-market-open",
      "name": "ì¥ ì—´ë¦¼ ì—¬ë¶€ í™•ì¸",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mockapi.kiwoom.com/oauth2/token",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json;charset=UTF-8"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"grant_type\": \"client_credentials\",\n  \"appkey\": \"{{$('Env Config').first().json[\"KIWOOM_APP_KEY\"]}}\",\n  \"secretkey\": \"{{$('Env Config').first().json[\"KIWOOM_APP_SECRET\"]}}\"\n}",
        "options": {}
      },
      "id": "get-token",
      "name": "í‚¤ì›€ í† í° ë°œê¸‰",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $('Env Config').first().json[\"SUPABASE_URL\"] + '/rest/v1/rpc/get_active_strategies_with_universe' }}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$('Env Config').first().json[\"SUPABASE_SERVICE_ROLE_KEY\"]}}"
            },
            {
              "name": "Authorization",
              "value": "={{'Bearer ' + $('Env Config').first().json[\"SUPABASE_SERVICE_ROLE_KEY\"]}}"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{}",
        "options": {}
      },
      "id": "get-active-strategies",
      "name": "ìë™ë§¤ë§¤ ì „ëµ ì¡°íšŒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst envVars = $('Env Config').first().json;\nconst tokenData = $('í‚¤ì›€ í† í° ë°œê¸‰').first().json;\n\n// v44 ë¡œì§ ê·¸ëŒ€ë¡œ: ì¤‘ë³µ ì œê±° ë¡œì§ ì¶”ê°€\nconst uniqueStocks = new Set();\n\nfor (const item of items) {\n  const strategy = item.json;\n  let stockCodes = [];\n\n  if (strategy.filtered_stocks) {\n    if (Array.isArray(strategy.filtered_stocks)) {\n      stockCodes = strategy.filtered_stocks.filter(code => code && typeof code === 'string');\n    } else if (typeof strategy.filtered_stocks === 'object') {\n      stockCodes = Object.values(strategy.filtered_stocks).filter(code => code && typeof code === 'string');\n    }\n  }\n\n  stockCodes.forEach(code => uniqueStocks.add(code));\n}\n\n// v44ì™€ ë™ì¼í•œ êµ¬ì¡°ë¡œ ê²°ê³¼ ìƒì„±\nconst results = Array.from(uniqueStocks).map((stockCode, index) => ({\n  json: {\n    stock_code: stockCode,\n    index: index,\n    total: uniqueStocks.size,\n    access_token: tokenData.access_token || tokenData.token,\n    SUPABASE_URL: envVars.SUPABASE_URL,\n    SUPABASE_SERVICE_ROLE_KEY: envVars.SUPABASE_SERVICE_ROLE_KEY\n  }\n}));\n\nconsole.log(`ğŸ“Š Total unique stocks to process: ${results.length}`);\nreturn results;"
      },
      "id": "extract-stocks",
      "name": "ì¢…ëª© ì½”ë“œ ì¶”ì¶œ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mockapi.kiwoom.com/api/dostk/mrkcond",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json;charset=UTF-8"
            },
            {
              "name": "authorization",
              "value": "={{'Bearer ' + $json.access_token}}"
            },
            {
              "name": "cont-yn",
              "value": "N"
            },
            {
              "name": "api-id",
              "value": "ka10004"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"stk_cd\": \"{{$json.stock_code}}\"}",
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1,
              "batchInterval": 2000
            }
          }
        }
      },
      "id": "get-price",
      "name": "í‚¤ì›€ í˜¸ê°€ ì¡°íšŒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1650, 300]
    },
    {
      "parameters": {
        "jsCode": "// v44 'ì›ë³¸ ë°ì´í„° ë³‘í•©' + 'ë°ì´í„° íŒŒì‹±' í†µí•©\n// HTTP Request ë…¸ë“œ(í‚¤ì›€ í˜¸ê°€ ì¡°íšŒ)ì˜ ì¶œë ¥ê³¼ ê·¸ ì´ì „ ë…¸ë“œ(ì¢…ëª© ì½”ë“œ ì¶”ì¶œ)ì˜ ì¶œë ¥ì„ ë§¤í•‘\n\nconst kiwoomResponses = $input.all();\n// 'ì¢…ëª© ì½”ë“œ ì¶”ì¶œ' ë…¸ë“œì˜ ë°ì´í„°ê°€ í•„ìš”í•¨. \n// n8nì—ì„œëŠ” ë…¸ë“œ ì´ë¦„ìœ¼ë¡œ ì§ì ‘ ì°¸ì¡° ê°€ëŠ¥.\nconst originalInputs = $('ì¢…ëª© ì½”ë“œ ì¶”ì¶œ').all();\n\nconst results = [];\n\nfor (let i = 0; i < kiwoomResponses.length; i++) {\n  const kiwoomResponse = kiwoomResponses[i].json;\n  // ìˆœì„œê°€ ë³´ì¥ëœë‹¤ê³  ê°€ì • (batchingì„ ì¨ë„ ìˆœì°¨ ì‹¤í–‰ì´ë¯€ë¡œ)\n  const original = originalInputs[i];\n\n  if (!original) continue;\n\n  const parsePrice = (price) => {\n    if (!price) return 0;\n    return parseFloat(String(price).replace(/[+\\-]/g, ''));\n  };\n\n  const selPrice = parsePrice(kiwoomResponse.sel_fpr_bid);\n  const buyPrice = parsePrice(kiwoomResponse.buy_fpr_bid);\n  const estimatedPrice = (selPrice + buyPrice) / 2;\n\n  const selVolume = parseInt(String(kiwoomResponse.sel_fpr_req || 0).replace(/[+\\-]/g, '')) || 0;\n  const buyVolume = parseInt(String(kiwoomResponse.buy_fpr_req || 0).replace(/[+\\-]/g, '')) || 0;\n\n  results.push({\n    json: {\n      stock_code: original.json.stock_code,\n      current_price: estimatedPrice,\n      change_price: 0,\n      change_rate: 0,\n      volume: selVolume + buyVolume,\n      high_52w: selPrice,\n      low_52w: buyPrice,\n      updated_at: new Date().toISOString()\n    }\n  });\n}\n\nreturn results;"
      },
      "id": "parse-data",
      "name": "ë°ì´í„° íŒŒì‹± ë° ë³‘í•©",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1850, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$('Env Config').first().json.SUPABASE_URL}}/rest/v1/kw_price_current",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"stock_code\": \"{{$json.stock_code}}\",\n  \"current_price\": {{$json.current_price}},\n  \"volume\": {{$json.volume}},\n  \"high_52w\": {{$json.high_52w}},\n  \"low_52w\": {{$json.low_52w}},\n  \"updated_at\": \"{{$json.updated_at}}\"\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$('Env Config').first().json.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "={{'Bearer ' + $('Env Config').first().json.SUPABASE_SERVICE_ROLE_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates, return=representation"
            }
          ]
        },
        "options": {}
      },
      "id": "upsert",
      "name": "Supabase UPSERT",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2050, 300]
    }
  ],
  "connections": {
    "1ë¶„ë§ˆë‹¤ ì‹¤í–‰": {
      "main": [
        [
          {
            "node": "Env Config",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Env Config": {
      "main": [
        [
          {
            "node": "ì¥ ìš´ì˜ ìƒíƒœ ì¡°íšŒ (API)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì¥ ìš´ì˜ ìƒíƒœ ì¡°íšŒ (API)": {
      "main": [
        [
          {
            "node": "ì¥ ì—´ë¦¼ ì—¬ë¶€ í™•ì¸",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì¥ ì—´ë¦¼ ì—¬ë¶€ í™•ì¸": {
      "main": [
        [
          {
            "node": "í‚¤ì›€ í† í° ë°œê¸‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "í‚¤ì›€ í† í° ë°œê¸‰": {
      "main": [
        [
          {
            "node": "ìë™ë§¤ë§¤ ì „ëµ ì¡°íšŒ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ìë™ë§¤ë§¤ ì „ëµ ì¡°íšŒ": {
      "main": [
        [
          {
            "node": "ì¢…ëª© ì½”ë“œ ì¶”ì¶œ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì¢…ëª© ì½”ë“œ ì¶”ì¶œ": {
      "main": [
        [
          {
            "node": "í‚¤ì›€ í˜¸ê°€ ì¡°íšŒ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "í‚¤ì›€ í˜¸ê°€ ì¡°íšŒ": {
      "main": [
        [
          {
            "node": "ë°ì´í„° íŒŒì‹± ë° ë³‘í•©",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ë°ì´í„° íŒŒì‹± ë° ë³‘í•©": {
      "main": [
        [
          {
            "node": "Supabase UPSERT",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": true
}
