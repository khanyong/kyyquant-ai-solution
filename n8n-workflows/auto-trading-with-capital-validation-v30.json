{
  "name": "ìë™ë§¤ë§¤ ëª¨ë‹ˆí„°ë§ v30 (Loop Branch ìˆ˜ì •)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 1
            }
          ]
        }
      },
      "id": "schedule-1",
      "name": "1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "SUPABASE_URL",
              "value": "https://hznkyaomtrpzcayayayh.supabase.co"
            },
            {
              "name": "SUPABASE_ANON_KEY",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "KIWOOM_APP_KEY",
              "value": "S0FEQ8I3UYwgcEPepJrfO6NteTCziz4540NljbYIASU"
            },
            {
              "name": "KIWOOM_APP_SECRET",
              "value": "tBh2TG4i0nwvKMC5s_DCVSlnWec3pgvLEmxIqL2RDsA"
            },
            {
              "name": "BACKEND_URL",
              "value": "http://192.168.50.150:8000"
            }
          ]
        }
      },
      "id": "set-env-1",
      "name": "í™˜ê²½ë³€ìˆ˜ ì„¤ì •",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{new Date().getHours()}}",
              "operation": "largerEqual",
              "value2": 9
            },
            {
              "value1": "={{new Date().getHours()}}",
              "operation": "smallerEqual",
              "value2": 15
            },
            {
              "value1": "={{new Date().getDay()}}",
              "operation": "largerEqual",
              "value2": 1
            },
            {
              "value1": "={{new Date().getDay()}}",
              "operation": "smallerEqual",
              "value2": 5
            }
          ]
        }
      },
      "id": "market-check-1",
      "name": "ì¥ì‹œê°„ ì²´í¬",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mockapi.kiwoom.com/oauth2/token",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"grant_type\": \"client_credentials\",\n  \"appkey\": \"{{$node[\"í™˜ê²½ë³€ìˆ˜ ì„¤ì •\"].json[\"KIWOOM_APP_KEY\"]}}\",\n  \"secretkey\": \"{{$node[\"í™˜ê²½ë³€ìˆ˜ ì„¤ì •\"].json[\"KIWOOM_APP_SECRET\"]}}\"\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json;charset=UTF-8"
            }
          ]
        }
      },
      "id": "get-token-1",
      "name": "í‚¤ì›€ í† í° ë°œê¸‰",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{$node[\"í™˜ê²½ë³€ìˆ˜ ì„¤ì •\"].json[\"SUPABASE_URL\"]}}/rest/v1/rpc/get_active_strategies_with_universe",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "authorization",
              "value": "={{\"Bearer \" + $node[\"í™˜ê²½ë³€ìˆ˜ ì„¤ì •\"].json[\"SUPABASE_ANON_KEY\"]}}"
            },
            {
              "name": "apikey",
              "value": "={{$node[\"í™˜ê²½ë³€ìˆ˜ ì„¤ì •\"].json[\"SUPABASE_ANON_KEY\"]}}"
            }
          ]
        }
      },
      "id": "get-strategies-1",
      "name": "ìë™ë§¤ë§¤ ì „ëµ ì¡°íšŒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst results = [];\n\nconst envVars = $('í™˜ê²½ë³€ìˆ˜ ì„¤ì •').first().json;\nconst tokenData = $('í‚¤ì›€ í† í° ë°œê¸‰').first().json;\n\nfor (const item of items) {\n  const strategy = item.json;\n  let stockCodes = [];\n\n  if (strategy.filtered_stocks) {\n    if (Array.isArray(strategy.filtered_stocks)) {\n      stockCodes = strategy.filtered_stocks.filter(code => code && typeof code === 'string');\n    } else if (typeof strategy.filtered_stocks === 'object') {\n      stockCodes = Object.values(strategy.filtered_stocks).filter(code => code && typeof code === 'string');\n    }\n  }\n\n  console.log(`ğŸ“Š Strategy: ${strategy.strategy_name}, Stock count: ${stockCodes.length}`);\n\n  stockCodes.forEach(stockCode => {\n    results.push({\n      json: {\n        strategy_id: strategy.strategy_id,\n        strategy_name: strategy.strategy_name,\n        entry_conditions: strategy.entry_conditions,\n        exit_conditions: strategy.exit_conditions,\n        stock_code: stockCode,\n        access_token: tokenData.token,\n        KIWOOM_APP_KEY: envVars.KIWOOM_APP_KEY,\n        KIWOOM_APP_SECRET: envVars.KIWOOM_APP_SECRET,\n        SUPABASE_URL: envVars.SUPABASE_URL,\n        SUPABASE_ANON_KEY: envVars.SUPABASE_ANON_KEY,\n        BACKEND_URL: envVars.BACKEND_URL\n      }\n    });\n  });\n}\n\nconsole.log(`âœ… Total items created: ${results.length}`);\nreturn results;"
      },
      "id": "extract-stocks-1",
      "name": "ì¢…ëª© ì½”ë“œ ì¶”ì¶œ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "loop-stocks",
      "name": "ì¢…ëª©ë³„ ë£¨í”„",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "jsCode": "// 60ì´ˆ ëŒ€ê¸°\nconsole.log('â±ï¸ 60ì´ˆ ëŒ€ê¸° ì¤‘...');\nawait new Promise(resolve => setTimeout(resolve, 60000));\nconsole.log('âœ… ëŒ€ê¸° ì™„ë£Œ');\n\nreturn $input.all();"
      },
      "id": "wait-60s",
      "name": "60ì´ˆ ëŒ€ê¸°",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mockapi.kiwoom.com/api/dostk/mrkcond",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"stk_cd\": \"{{$json.stock_code}}\"\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json;charset=UTF-8"
            },
            {
              "name": "authorization",
              "value": "={{\"Bearer \" + $json.access_token}}"
            },
            {
              "name": "cont-yn",
              "value": "N"
            },
            {
              "name": "next-key",
              "value": ""
            },
            {
              "name": "api-id",
              "value": "ka10004"
            }
          ]
        },
        "options": {}
      },
      "id": "get-price-1",
      "name": "í‚¤ì›€ í˜¸ê°€ ì¡°íšŒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1850, 200]
    },
    {
      "parameters": {
        "jsCode": "const kiwoomData = $input.first().json;\nconst loopItem = $('ì¢…ëª©ë³„ ë£¨í”„').item.json;\n\nconsole.log('ğŸ”„ ë°ì´í„° ë³‘í•©');\nconsole.log('ğŸ“‹ ì¢…ëª© ì½”ë“œ:', loopItem.stock_code);\n\nconst mergedData = {\n  _original_stock_code: loopItem.stock_code,\n  _original_strategy_id: loopItem.strategy_id,\n  _original_strategy_name: loopItem.strategy_name,\n  _original_entry_conditions: loopItem.entry_conditions,\n  _original_exit_conditions: loopItem.exit_conditions,\n  _original_SUPABASE_URL: loopItem.SUPABASE_URL,\n  _original_SUPABASE_ANON_KEY: loopItem.SUPABASE_ANON_KEY,\n  _original_BACKEND_URL: loopItem.BACKEND_URL,\n  stk_cd: loopItem.stock_code,\n  ...kiwoomData\n};\n\nconsole.log('âœ… ë³‘í•© ì™„ë£Œ:', mergedData._original_stock_code);\n\nreturn mergedData;"
      },
      "id": "merge-data-1",
      "name": "ë°ì´í„° ë³‘í•©",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2050, 200]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.item.json;\nconst kiwoomData = item;\nconst envVars = $('í™˜ê²½ë³€ìˆ˜ ì„¤ì •').first().json;\n\nconst strategy_id = kiwoomData._original_strategy_id || '';\nconst strategy_name = kiwoomData._original_strategy_name || '';\nconst stockCode = kiwoomData._original_stock_code || '';\nconst SUPABASE_URL = kiwoomData._original_SUPABASE_URL || envVars.SUPABASE_URL;\nconst SUPABASE_ANON_KEY = kiwoomData._original_SUPABASE_ANON_KEY || envVars.SUPABASE_ANON_KEY;\nconst BACKEND_URL = kiwoomData._original_BACKEND_URL || envVars.BACKEND_URL;\n\nconst parsePrice = (price) => {\n  if (!price) return 0;\n  return parseFloat(String(price).replace(/[+\\-]/g, ''));\n};\n\nconst selPrice = parsePrice(kiwoomData.sel_fpr_bid);\nconst buyPrice = parsePrice(kiwoomData.buy_fpr_bid);\nconst estimatedPrice = (selPrice + buyPrice) / 2;\n\nlet stockName = stockCode;\n\ntry {\n  const response = await fetch(\n    `${SUPABASE_URL}/rest/v1/stock_metadata?stock_code=eq.${stockCode}&select=stock_name`,\n    {\n      headers: {\n        'apikey': SUPABASE_ANON_KEY,\n        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`\n      }\n    }\n  );\n\n  const data = await response.json();\n  if (data && data.length > 0 && data[0].stock_name) {\n    stockName = data[0].stock_name;\n  }\n} catch (error) {\n  console.error('Failed to fetch stock name:', error);\n}\n\nconst selVolume = parseInt(String(kiwoomData.sel_fpr_req || 0).replace(/[+\\-]/g, '')) || 0;\nconst buyVolume = parseInt(String(kiwoomData.buy_fpr_req || 0).replace(/[+\\-]/g, '')) || 0;\n\nconst indicators = {\n  close: estimatedPrice,\n  sel_price: selPrice,\n  buy_price: buyPrice,\n  volume: selVolume + buyVolume\n};\n\nreturn {\n  strategy_id: strategy_id,\n  strategy_name: strategy_name,\n  stock_code: stockCode,\n  stock_name: stockName,\n  current_price: estimatedPrice,\n  indicators: indicators,\n  buy_signal: false,\n  sell_signal: false,\n  signal_type: 'NONE',\n  signal_strength: 0,\n  timestamp: new Date().toISOString(),\n  SUPABASE_URL: SUPABASE_URL,\n  SUPABASE_ANON_KEY: SUPABASE_ANON_KEY,\n  BACKEND_URL: BACKEND_URL,\n  sel_price: selPrice,\n  buy_price: buyPrice,\n  volume: indicators.volume\n};"
      },
      "id": "check-conditions-1",
      "name": "ì¡°ê±´ ì²´í¬ ë° ì‹ í˜¸ ìƒì„±",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2250, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$json.SUPABASE_URL}}/rest/v1/kw_stock_master",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"stock_code\": {{JSON.stringify($json.stock_code)}},\n  \"stock_name\": {{JSON.stringify($json.stock_name)}},\n  \"market\": \"KOSPI\"\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$json.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "={{\"Bearer \" + $json.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates"
            }
          ]
        },
        "options": {}
      },
      "id": "save-stock-master",
      "name": "ì¢…ëª© ë§ˆìŠ¤í„° ì €ì¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2350, 400]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.item.json;\nconst stockCode = item.stock_code;\nconst currentPrice = item.current_price;\nconst supabaseUrl = item.SUPABASE_URL;\nconst supabaseKey = item.SUPABASE_ANON_KEY;\n\ntry {\n  const response = await fetch(\n    `${supabaseUrl}/rest/v1/kw_price_daily?stock_code=eq.${stockCode}&select=close&order=trade_date.desc&limit=1`,\n    {\n      headers: {\n        'apikey': supabaseKey,\n        'Authorization': `Bearer ${supabaseKey}`\n      }\n    }\n  );\n  \n  const data = await response.json();\n  const previousClose = data && data.length > 0 ? parseFloat(data[0].close) : currentPrice;\n  const changePrice = currentPrice - previousClose;\n  const changeRate = previousClose > 0 ? ((changePrice / previousClose) * 100) : 0;\n  \n  return {\n    ...item,\n    previous_close: previousClose,\n    change_price: changePrice,\n    change_rate: changeRate\n  };\n} catch (error) {\n  return {\n    ...item,\n    previous_close: currentPrice,\n    change_price: 0,\n    change_rate: 0\n  };\n}"
      },
      "id": "calc-price-change",
      "name": "ë“±ë½ê°€/ë¥  ê³„ì‚°",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2450, 200]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$json.SUPABASE_URL}}/rest/v1/kw_price_current",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"stock_code\": {{JSON.stringify($json.stock_code)}},\n  \"stock_name\": {{JSON.stringify($json.stock_name || $json.stock_code)}},\n  \"current_price\": {{$json.current_price}},\n  \"change_price\": {{$json.change_price}},\n  \"change_rate\": {{$json.change_rate}},\n  \"volume\": {{$json.volume || 0}},\n  \"high_52w\": {{$json.sel_price || 0}},\n  \"low_52w\": {{$json.buy_price || 0}},\n  \"market_cap\": 0\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$json.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "={{\"Bearer \" + $json.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates"
            }
          ]
        },
        "options": {}
      },
      "id": "save-market-data",
      "name": "ì‹œì¥ ë°ì´í„° ì €ì¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [2650, 200]
    },
    {
      "parameters": {},
      "id": "loop-completion",
      "name": "ì™„ë£Œ",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1650, 400]
    }
  ],
  "connections": {
    "1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰": {
      "main": [[{"node": "í™˜ê²½ë³€ìˆ˜ ì„¤ì •", "type": "main", "index": 0}]]
    },
    "í™˜ê²½ë³€ìˆ˜ ì„¤ì •": {
      "main": [[{"node": "ì¥ì‹œê°„ ì²´í¬", "type": "main", "index": 0}]]
    },
    "ì¥ì‹œê°„ ì²´í¬": {
      "main": [[{"node": "í‚¤ì›€ í† í° ë°œê¸‰", "type": "main", "index": 0}]]
    },
    "í‚¤ì›€ í† í° ë°œê¸‰": {
      "main": [[{"node": "ìë™ë§¤ë§¤ ì „ëµ ì¡°íšŒ", "type": "main", "index": 0}]]
    },
    "ìë™ë§¤ë§¤ ì „ëµ ì¡°íšŒ": {
      "main": [[{"node": "ì¢…ëª© ì½”ë“œ ì¶”ì¶œ", "type": "main", "index": 0}]]
    },
    "ì¢…ëª© ì½”ë“œ ì¶”ì¶œ": {
      "main": [[{"node": "ì¢…ëª©ë³„ ë£¨í”„", "type": "main", "index": 0}]]
    },
    "ì¢…ëª©ë³„ ë£¨í”„": {
      "main": [
        [{"node": "60ì´ˆ ëŒ€ê¸°", "type": "main", "index": 0}],
        [{"node": "ì™„ë£Œ", "type": "main", "index": 0}]
      ]
    },
    "60ì´ˆ ëŒ€ê¸°": {
      "main": [[{"node": "í‚¤ì›€ í˜¸ê°€ ì¡°íšŒ", "type": "main", "index": 0}]]
    },
    "í‚¤ì›€ í˜¸ê°€ ì¡°íšŒ": {
      "main": [[{"node": "ë°ì´í„° ë³‘í•©", "type": "main", "index": 0}]]
    },
    "ë°ì´í„° ë³‘í•©": {
      "main": [[{"node": "ì¡°ê±´ ì²´í¬ ë° ì‹ í˜¸ ìƒì„±", "type": "main", "index": 0}]]
    },
    "ì¡°ê±´ ì²´í¬ ë° ì‹ í˜¸ ìƒì„±": {
      "main": [[
        {"node": "ì¢…ëª© ë§ˆìŠ¤í„° ì €ì¥", "type": "main", "index": 0},
        {"node": "ë“±ë½ê°€/ë¥  ê³„ì‚°", "type": "main", "index": 0}
      ]]
    },
    "ì¢…ëª© ë§ˆìŠ¤í„° ì €ì¥": {
      "main": [[]]
    },
    "ë“±ë½ê°€/ë¥  ê³„ì‚°": {
      "main": [[{"node": "ì‹œì¥ ë°ì´í„° ì €ì¥", "type": "main", "index": 0}]]
    },
    "ì‹œì¥ ë°ì´í„° ì €ì¥": {
      "main": [[{"node": "ì¢…ëª©ë³„ ë£¨í”„", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveExecutionProgress": true,
    "executionTimeout": 3600
  }
}
