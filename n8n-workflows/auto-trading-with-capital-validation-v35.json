{
  "name": "ìë™ë§¤ë§¤ ëª¨ë‹ˆí„°ë§ v35 (fetch â†’ $http ë³€ê²½)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 1
            }
          ]
        }
      },
      "id": "schedule-1",
      "name": "1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "SUPABASE_URL",
              "value": "https://hznkyaomtrpzcayayayh.supabase.co"
            },
            {
              "name": "SUPABASE_ANON_KEY",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "KIWOOM_APP_KEY",
              "value": "S0FEQ8I3UYwgcEPepJrfO6NteTCziz4540NljbYIASU"
            },
            {
              "name": "KIWOOM_APP_SECRET",
              "value": "tBh2TG4i0nwvKMC5s_DCVSlnWec3pgvLEmxIqL2RDsA"
            },
            {
              "name": "BACKEND_URL",
              "value": "http://192.168.50.150:8000"
            },
            {
              "name": "BATCH_SIZE",
              "value": "4"
            },
            {
              "name": "WAIT_SECONDS",
              "value": "60"
            }
          ]
        }
      },
      "id": "set-env-1",
      "name": "í™˜ê²½ë³€ìˆ˜ ì„¤ì •",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{new Date().getHours()}}",
              "operation": "largerEqual",
              "value2": 9
            },
            {
              "value1": "={{new Date().getHours()}}",
              "operation": "smallerEqual",
              "value2": 15
            },
            {
              "value1": "={{new Date().getDay()}}",
              "operation": "largerEqual",
              "value2": 1
            },
            {
              "value1": "={{new Date().getDay()}}",
              "operation": "smallerEqual",
              "value2": 5
            }
          ]
        }
      },
      "id": "market-check-1",
      "name": "ì¥ì‹œê°„ ì²´í¬",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mockapi.kiwoom.com/oauth2/token",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"grant_type\": \"client_credentials\",\n  \"appkey\": \"{{$node[\"í™˜ê²½ë³€ìˆ˜ ì„¤ì •\"].json[\"KIWOOM_APP_KEY\"]}}\",\n  \"secretkey\": \"{{$node[\"í™˜ê²½ë³€ìˆ˜ ì„¤ì •\"].json[\"KIWOOM_APP_SECRET\"]}}\"\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json;charset=UTF-8"
            }
          ]
        }
      },
      "id": "get-token-1",
      "name": "í‚¤ì›€ í† í° ë°œê¸‰",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{$node[\"í™˜ê²½ë³€ìˆ˜ ì„¤ì •\"].json[\"SUPABASE_URL\"]}}/rest/v1/rpc/get_active_strategies_with_universe",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "authorization",
              "value": "={{\"Bearer \" + $node[\"í™˜ê²½ë³€ìˆ˜ ì„¤ì •\"].json[\"SUPABASE_ANON_KEY\"]}}"
            },
            {
              "name": "apikey",
              "value": "={{$node[\"í™˜ê²½ë³€ìˆ˜ ì„¤ì •\"].json[\"SUPABASE_ANON_KEY\"]}}"
            }
          ]
        }
      },
      "id": "get-strategies-1",
      "name": "ìë™ë§¤ë§¤ ì „ëµ ì¡°íšŒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// ì „ì²´ ì¢…ëª© ë°°ì¹˜ ì²˜ë¦¬ v35 (fetch â†’ $http.request ë³€ê²½)\n// - n8n ë‚´ì¥ $http í—¬í¼ ì‚¬ìš©ìœ¼ë¡œ fetch ì—ëŸ¬ í•´ê²°\n// - BATCH_SIZE: í™˜ê²½ë³€ìˆ˜ë¡œ ì¡°ì • ê°€ëŠ¥ (ê¸°ë³¸ 4ê°œ)\n// - WAIT_SECONDS: ëŒ€ê¸° ì‹œê°„ ì¡°ì • ê°€ëŠ¥ (ê¸°ë³¸ 60ì´ˆ)\n// ============================================================================\n\nconst items = $input.all();\nconst envVars = $('í™˜ê²½ë³€ìˆ˜ ì„¤ì •').first().json;\nconst tokenData = $('í‚¤ì›€ í† í° ë°œê¸‰').first().json;\n\nconst batchSize = parseInt(envVars.BATCH_SIZE || '4');\nconst waitSeconds = parseInt(envVars.WAIT_SECONDS || '60');\nconst waitMs = waitSeconds * 1000;\n\nconst allResults = [];\n\nfor (const item of items) {\n  const strategy = item.json;\n  let stockCodes = [];\n\n  if (strategy.filtered_stocks) {\n    if (Array.isArray(strategy.filtered_stocks)) {\n      stockCodes = strategy.filtered_stocks.filter(code => code && typeof code === 'string');\n    } else if (typeof strategy.filtered_stocks === 'object') {\n      stockCodes = Object.values(strategy.filtered_stocks).filter(code => code && typeof code === 'string');\n    }\n  }\n\n  const totalBatches = Math.ceil(stockCodes.length / batchSize);\n  \n  console.log(`\\n${'='.repeat(80)}`);\n  console.log(`ğŸ¯ Strategy: ${strategy.strategy_name}`);\n  console.log(`ğŸ“¦ Total stocks: ${stockCodes.length}`);\n  console.log(`ğŸ“¦ Total batches: ${totalBatches}`);\n  console.log(`âš™ï¸ Batch size: ${batchSize}, Wait time: ${waitSeconds}s`);\n  console.log(`${'='.repeat(80)}`);\n\n  // ë°°ì¹˜ë³„ ì²˜ë¦¬\n  for (let batchIndex = 0; batchIndex < totalBatches; batchIndex++) {\n    const batchStart = batchIndex * batchSize;\n    const batchEnd = Math.min(batchStart + batchSize, stockCodes.length);\n    const batch = stockCodes.slice(batchStart, batchEnd);\n\n    console.log(`\\n${'='.repeat(80)}`);\n    console.log(`ğŸ“¦ ë°°ì¹˜ ${batchIndex + 1}/${totalBatches} ì²˜ë¦¬ ì‹œì‘`);\n    console.log(`ğŸ“Š ì¢…ëª©: ${batchStart + 1}-${batchEnd} / ${stockCodes.length} (${batch.length}ê°œ)`);\n    console.log(`${'='.repeat(80)}`);\n\n    // ë°°ì¹˜ ë‚´ ì¢…ëª© ìˆœì°¨ ì²˜ë¦¬\n    for (let i = 0; i < batch.length; i++) {\n      const stockCode = batch[i];\n      const globalIndex = batchStart + i + 1;\n      \n      // ì²« ë²ˆì§¸ ì¢…ëª©ì´ ì•„ë‹ˆë©´ ëŒ€ê¸°\n      if (globalIndex > 1) {\n        console.log(`â±ï¸ ${waitSeconds}ì´ˆ ëŒ€ê¸° ì¤‘...`);\n        await new Promise(resolve => setTimeout(resolve, waitMs));\n      }\n\n      console.log(`\\nğŸ” [${globalIndex}/${stockCodes.length}] ${stockCode} ì¡°íšŒ ì¤‘...`);\n\n      try {\n        // í‚¤ì›€ í˜¸ê°€ ì¡°íšŒ ($http.request ì‚¬ìš©)\n        const kiwoomResponse = await $http.request({\n          method: 'POST',\n          url: 'https://mockapi.kiwoom.com/api/dostk/mrkcond',\n          headers: {\n            'Content-Type': 'application/json;charset=UTF-8',\n            'authorization': `Bearer ${tokenData.token}`,\n            'cont-yn': 'N',\n            'next-key': '',\n            'api-id': 'ka10004',\n            'accept': 'application/json'\n          },\n          body: { stk_cd: stockCode },\n          json: true\n        });\n\n        const kiwoomData = kiwoomResponse;\n\n        const parsePrice = (price) => {\n          if (!price) return 0;\n          return parseFloat(String(price).replace(/[+\\-]/g, ''));\n        };\n\n        const selPrice = parsePrice(kiwoomData.sel_fpr_bid);\n        const buyPrice = parsePrice(kiwoomData.buy_fpr_bid);\n        const estimatedPrice = (selPrice + buyPrice) / 2;\n\n        if (estimatedPrice === 0) {\n          throw new Error('Invalid price data');\n        }\n\n        // ì¢…ëª©ëª… ì¡°íšŒ\n        let stockName = stockCode;\n        try {\n          const metaResponse = await $http.request({\n            method: 'GET',\n            url: `${envVars.SUPABASE_URL}/rest/v1/stock_metadata?stock_code=eq.${stockCode}&select=stock_name`,\n            headers: {\n              'apikey': envVars.SUPABASE_ANON_KEY,\n              'Authorization': `Bearer ${envVars.SUPABASE_ANON_KEY}`\n            },\n            json: true\n          });\n          if (metaResponse && metaResponse.length > 0 && metaResponse[0].stock_name) {\n            stockName = metaResponse[0].stock_name;\n          }\n        } catch (error) {\n          console.log('  âš ï¸ ì¢…ëª©ëª… ì¡°íšŒ ì‹¤íŒ¨, ì¢…ëª©ì½”ë“œ ì‚¬ìš©');\n        }\n\n        // ì „ì¼ ì¢…ê°€ ì¡°íšŒ\n        let previousClose = estimatedPrice;\n        try {\n          const priceResponse = await $http.request({\n            method: 'GET',\n            url: `${envVars.SUPABASE_URL}/rest/v1/kw_price_daily?stock_code=eq.${stockCode}&select=close&order=trade_date.desc&limit=1`,\n            headers: {\n              'apikey': envVars.SUPABASE_ANON_KEY,\n              'Authorization': `Bearer ${envVars.SUPABASE_ANON_KEY}`\n            },\n            json: true\n          });\n          if (priceResponse && priceResponse.length > 0) {\n            previousClose = parseFloat(priceResponse[0].close);\n          }\n        } catch (error) {\n          console.log('  âš ï¸ ì „ì¼ ì¢…ê°€ ì¡°íšŒ ì‹¤íŒ¨, í˜„ì¬ê°€ ì‚¬ìš©');\n        }\n\n        const changePrice = estimatedPrice - previousClose;\n        const changeRate = previousClose > 0 ? ((changePrice / previousClose) * 100) : 0;\n\n        const selVolume = parseInt(String(kiwoomData.sel_fpr_req || 0).replace(/[+\\-]/g, '')) || 0;\n        const buyVolume = parseInt(String(kiwoomData.buy_fpr_req || 0).replace(/[+\\-]/g, '')) || 0;\n\n        // ì¢…ëª© ë§ˆìŠ¤í„° ì €ì¥\n        try {\n          await $http.request({\n            method: 'POST',\n            url: `${envVars.SUPABASE_URL}/rest/v1/kw_stock_master`,\n            headers: {\n              'apikey': envVars.SUPABASE_ANON_KEY,\n              'Authorization': `Bearer ${envVars.SUPABASE_ANON_KEY}`,\n              'Content-Type': 'application/json',\n              'Prefer': 'resolution=merge-duplicates'\n            },\n            body: {\n              stock_code: stockCode,\n              stock_name: stockName,\n              market: 'KOSPI'\n            },\n            json: true\n          });\n        } catch (error) {\n          console.log('  âš ï¸ ì¢…ëª© ë§ˆìŠ¤í„° ì €ì¥ ì‹¤íŒ¨');\n        }\n\n        // í˜„ì¬ê°€ ì €ì¥\n        await $http.request({\n          method: 'POST',\n          url: `${envVars.SUPABASE_URL}/rest/v1/kw_price_current`,\n          headers: {\n            'apikey': envVars.SUPABASE_ANON_KEY,\n            'Authorization': `Bearer ${envVars.SUPABASE_ANON_KEY}`,\n            'Content-Type': 'application/json',\n            'Prefer': 'resolution=merge-duplicates'\n          },\n          body: {\n            stock_code: stockCode,\n            stock_name: stockName,\n            current_price: estimatedPrice,\n            change_price: changePrice,\n            change_rate: changeRate,\n            volume: selVolume + buyVolume,\n            high_52w: selPrice,\n            low_52w: buyPrice,\n            market_cap: 0\n          },\n          json: true\n        });\n\n        allResults.push({\n          json: {\n            stock_code: stockCode,\n            stock_name: stockName,\n            current_price: estimatedPrice,\n            change_rate: changeRate,\n            success: true,\n            batch_index: batchIndex,\n            global_index: globalIndex\n          }\n        });\n\n        const arrow = changeRate > 0 ? 'â–²' : changeRate < 0 ? 'â–¼' : 'â”';\n        console.log(`âœ… ${stockCode} (${stockName})`);\n        console.log(`   ê°€ê²©: ${estimatedPrice.toLocaleString()}ì› ${arrow} ${changeRate.toFixed(2)}%`);\n\n      } catch (error) {\n        console.error(`âŒ ${stockCode} ì²˜ë¦¬ ì‹¤íŒ¨: ${error.message}`);\n        allResults.push({\n          json: {\n            stock_code: stockCode,\n            error: error.message,\n            success: false,\n            batch_index: batchIndex,\n            global_index: globalIndex\n          }\n        });\n      }\n    }\n\n    const batchSuccessCount = allResults.filter(r => \n      r.json.batch_index === batchIndex && r.json.success\n    ).length;\n    console.log(`\\nâœ… ë°°ì¹˜ ${batchIndex + 1}/${totalBatches} ì™„ë£Œ: ${batchSuccessCount}/${batch.length}ê°œ ì„±ê³µ`);\n    console.log(`${'='.repeat(80)}\\n`);\n  }\n\n  const totalSuccess = allResults.filter(r => r.json.success).length;\n  console.log(`\\n${'='.repeat(80)}`);\n  console.log(`âœ… ì „ì²´ ì²˜ë¦¬ ì™„ë£Œ`);\n  console.log(`ğŸ“Š ì„±ê³µ: ${totalSuccess}/${stockCodes.length}ê°œ`);\n  console.log(`âŒ ì‹¤íŒ¨: ${stockCodes.length - totalSuccess}ê°œ`);\n  console.log(`${'='.repeat(80)}\\n`);\n}\n\nreturn allResults.length > 0 ? allResults : [{ json: { message: 'ì²˜ë¦¬í•  ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤' } }];"
      },
      "id": "process-all",
      "name": "ì „ì²´ ì¢…ëª© ë°°ì¹˜ ì²˜ë¦¬",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 300]
    }
  ],
  "connections": {
    "1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰": {
      "main": [[{"node": "í™˜ê²½ë³€ìˆ˜ ì„¤ì •", "type": "main", "index": 0}]]
    },
    "í™˜ê²½ë³€ìˆ˜ ì„¤ì •": {
      "main": [[{"node": "ì¥ì‹œê°„ ì²´í¬", "type": "main", "index": 0}]]
    },
    "ì¥ì‹œê°„ ì²´í¬": {
      "main": [[{"node": "í‚¤ì›€ í† í° ë°œê¸‰", "type": "main", "index": 0}]]
    },
    "í‚¤ì›€ í† í° ë°œê¸‰": {
      "main": [[{"node": "ìë™ë§¤ë§¤ ì „ëµ ì¡°íšŒ", "type": "main", "index": 0}]]
    },
    "ìë™ë§¤ë§¤ ì „ëµ ì¡°íšŒ": {
      "main": [[{"node": "ì „ì²´ ì¢…ëª© ë°°ì¹˜ ì²˜ë¦¬", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveExecutionProgress": true,
    "executionTimeout": 3600
  }
}
