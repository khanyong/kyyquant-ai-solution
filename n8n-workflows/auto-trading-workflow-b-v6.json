{
  "name": "ì›Œí¬í”Œë¡œìš° B: ìë™ ë§¤ë§¤ ì‹¤í–‰ v6 (5ë¶„ ì‚¬ì´í´ ì „ëµ)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 5
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "5ë¶„ë§ˆë‹¤ ì‹¤í–‰",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [250, 300]
    },
    {
      "parameters": {
        "jsCode": "// í•œêµ­ ì‹œê°„ìœ¼ë¡œ í˜„ì¬ ì‹œê°„ ê°€ì ¸ì˜¤ê¸°\nconst now = new Date();\nconst koreaTime = new Date(now.toLocaleString('en-US', { timeZone: 'Asia/Seoul' }));\n\nconst hour = koreaTime.getHours();\nconst minute = koreaTime.getMinutes();\nconst day = koreaTime.getDay(); // 0=ì¼ìš”ì¼, 6=í† ìš”ì¼\n\nconsole.log(`ğŸ• í˜„ì¬ í•œêµ­ ì‹œê°„: ${koreaTime.toLocaleString('ko-KR')} (${hour}ì‹œ ${minute}ë¶„, ìš”ì¼: ${day})`);\n\n// ì£¼ë§ ì²´í¬ (í† ìš”ì¼=6, ì¼ìš”ì¼=0)\nif (day === 0 || day === 6) {\n  console.log('â¸ï¸ ì£¼ë§ - ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨');\n  return [];\n}\n\n// ì¥ ìš´ì˜ì‹œê°„ ì²´í¬ (09:00 ~ 15:30)\nconst totalMinutes = hour * 60 + minute;\nconst marketOpen = 9 * 60;      // 09:00 = 540ë¶„\nconst marketClose = 15 * 60 + 30; // 15:30 = 930ë¶„\n\nif (totalMinutes < marketOpen) {\n  console.log(`â¸ï¸ ì¥ ì‹œì‘ ì „ (${hour}:${String(minute).padStart(2, '0')}) - ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨`);\n  return [];\n}\n\nif (totalMinutes >= marketClose) {\n  console.log(`â¸ï¸ ì¥ ë§ˆê° í›„ (${hour}:${String(minute).padStart(2, '0')}) - ì›Œí¬í”Œë¡œìš° ì¤‘ë‹¨`);\n  return [];\n}\n\nconsole.log(`âœ… ì¥ ìš´ì˜ì‹œê°„ (${hour}:${String(minute).padStart(2, '0')}) - ì›Œí¬í”Œë¡œìš° ê³„ì† ì§„í–‰`);\n\nreturn [{ json: { market_open: true, current_time: koreaTime.toISOString() } }];"
      },
      "id": "check-market-hours",
      "name": "ì‹œì¥ ìš´ì˜ì‹œê°„ ì²´í¬",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [350, 300]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "SUPABASE_URL",
              "value": "https://hznkyaomtrpzcayayayh.supabase.co"
            },
            {
              "name": "SUPABASE_ANON_KEY",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "KIWOOM_APP_KEY",
              "value": "={{$env.KIWOOM_APP_KEY || 'S0FEQ8I3UYwgcEPepJrfO6NteTCziz4540NljbYIASU'}}"
            },
            {
              "name": "KIWOOM_APP_SECRET",
              "value": "={{$env.KIWOOM_APP_SECRET || 'tBh2TG4i0nwvKMC5s_DCVSlnWec3pgvLEmxIqL2RDsA'}}"
            },
            {
              "name": "KIWOOM_ACCOUNT_NO",
              "value": "={{$env.KIWOOM_ACCOUNT_NO || '81101350-01'}}"
            }
          ]
        }
      },
      "id": "env-vars",
      "name": "í™˜ê²½ë³€ìˆ˜ ì„¤ì •",
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [550, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hznkyaomtrpzcayayayh.supabase.co/rest/v1/rpc/get_active_strategies_with_universe",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {}
      },
      "id": "get-strategies",
      "name": "í™œì„± ì „ëµ ì¡°íšŒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [750, 300]
    },
    {
      "parameters": {
        "jsCode": "const strategies = $input.all();\nconst envVars = $('í™˜ê²½ë³€ìˆ˜ ì„¤ì •').first().json;\n\n// ëª¨ë“  ì „ëµì˜ ì¢…ëª©ì„ ìˆ˜ì§‘ (ì¤‘ë³µ ì œê±°í•˜ì§€ ì•ŠìŒ - ì „ëµë³„ë¡œ ë‹¤ë¥¸ ì¡°ê±´)\nconst results = [];\n\nfor (const item of strategies) {\n  const strategy = item.json;\n\n  if (!strategy.filtered_stocks || !Array.isArray(strategy.filtered_stocks)) {\n    continue;\n  }\n\n  // ê° ì¢…ëª©ì— ëŒ€í•´ ì „ëµ ì •ë³´ í¬í•¨\n  strategy.filtered_stocks.forEach(stockCode => {\n    results.push({\n      json: {\n        stock_code: stockCode,\n        strategy_id: strategy.strategy_id,\n        strategy_name: strategy.strategy_name,\n        entry_conditions: strategy.entry_conditions,\n        exit_conditions: strategy.exit_conditions,\n        order_price_strategy: strategy.order_price_strategy || {\n          buy: { type: 'best_ask', offset: 10 },\n          sell: { type: 'best_bid', offset: -10 }\n        },\n        allocated_capital: strategy.allocated_capital,\n        SUPABASE_URL: envVars.SUPABASE_URL,\n        SUPABASE_ANON_KEY: envVars.SUPABASE_ANON_KEY\n      }\n    });\n  });\n}\n\nconsole.log(`ğŸ“Š ì´ ${results.length}ê°œ ì¢…ëª©Ã—ì „ëµ ì¡°í•© ì²˜ë¦¬`);\nreturn results;"
      },
      "id": "extract-stocks",
      "name": "ìœ ë‹ˆë²„ìŠ¤ ì¢…ëª© ì¶”ì¶œ",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [850, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://hznkyaomtrpzcayayayh.supabase.co/rest/v1/positions?stock_code=in.({{$('ìœ ë‹ˆë²„ìŠ¤ ì¢…ëª© ì¶”ì¶œ').all().map(item => item.json.stock_code).join(',')}})",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            }
          ]
        },
        "options": {}
      },
      "id": "check-positions",
      "name": "í¬ì§€ì…˜ í™•ì¸",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://hznkyaomtrpzcayayayh.supabase.co/rest/v1/kw_price_current?stock_code=in.({{$('ìœ ë‹ˆë²„ìŠ¤ ì¢…ëª© ì¶”ì¶œ').all().map(item => item.json.stock_code).join(',')}})",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            }
          ]
        },
        "options": {}
      },
      "id": "get-prices",
      "name": "í˜„ì¬ê°€ ì¡°íšŒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1050, 450]
    },
    {
      "parameters": {
        "jsCode": "const strategyData = $('ìœ ë‹ˆë²„ìŠ¤ ì¢…ëª© ì¶”ì¶œ').all();\nconst positionData = $('í¬ì§€ì…˜ í™•ì¸').all();\nconst priceData = $('í˜„ì¬ê°€ ì¡°íšŒ').all();\n\nconsole.log(`ğŸ“¥ ì „ëµ: ${strategyData.length}, í¬ì§€ì…˜: ${positionData.length}, í˜„ì¬ê°€: ${priceData.length}`);\n\nconst results = [];\n\n// í¬ì§€ì…˜ ë§µ ìƒì„± (ì´ë¯¸ ë³´ìœ ì¤‘ì¸ ì¢…ëª© í™•ì¸ìš©)\nconst positionMap = {};\nfor (const item of positionData) {\n  const position = item.json;\n  if (Array.isArray(position)) {\n    position.forEach(p => {\n      if (p && p.stock_code) {\n        positionMap[p.stock_code] = p;\n      }\n    });\n  } else if (position && position.stock_code) {\n    positionMap[position.stock_code] = position;\n  }\n}\n\n// í˜„ì¬ê°€ ë§µ ìƒì„±\nconst priceMap = {};\nfor (const item of priceData) {\n  const price = item.json;\n  if (Array.isArray(price)) {\n    price.forEach(p => {\n      if (p && p.stock_code) {\n        priceMap[p.stock_code] = p;\n      }\n    });\n  } else if (price && price.stock_code) {\n    priceMap[price.stock_code] = price;\n  }\n}\n\nconsole.log(`ğŸ“Š í¬ì§€ì…˜: ${Object.keys(positionMap).length}ê°œ, í˜„ì¬ê°€: ${Object.keys(priceMap).length}ê°œ`);\n\nfor (const item of strategyData) {\n  const strategy = item.json;\n  const priceInfo = priceMap[strategy.stock_code];\n  const existingPosition = positionMap[strategy.stock_code];\n\n  // âœ… v6: ì´ë¯¸ í¬ì§€ì…˜ì´ ìˆìœ¼ë©´ ìŠ¤í‚µ (ì²´ê²°ëœ ê²½ìš°)\n  if (existingPosition && existingPosition.quantity > 0) {\n    console.log(`â­ï¸ ${strategy.stock_code}: ì´ë¯¸ ë³´ìœ ì¤‘ (ìˆ˜ëŸ‰: ${existingPosition.quantity}) - ì£¼ë¬¸ ìŠ¤í‚µ`);\n    continue;\n  }\n\n  if (!priceInfo) {\n    console.log(`âš ï¸ ${strategy.stock_code}: í˜„ì¬ê°€ ë°ì´í„° ì—†ìŒ`);\n    continue;\n  }\n\n  if (!priceInfo.current_price) {\n    console.log(`âš ï¸ ${strategy.stock_code}: ìœ íš¨í•œ í˜„ì¬ê°€ ì—†ìŒ`);\n    continue;\n  }\n\n  console.log(`âœ… ${strategy.stock_code}: í¬ì§€ì…˜ ì—†ìŒ - ì£¼ë¬¸ ì§„í–‰`);\n\n  results.push({\n    json: {\n      ...strategy,\n      stock_name: priceInfo.stock_name || strategy.stock_code,\n      current_price: priceInfo.current_price,\n      change_rate: priceInfo.change_rate || 0,\n      volume: priceInfo.volume || 0,\n      sell_price: priceInfo.current_price,\n      buy_price: priceInfo.current_price,\n      updated_at: priceInfo.updated_at\n    }\n  });\n}\n\nconsole.log(`âœ… ${results.length}ê°œ ì¢…ëª© ë³‘í•© ì™„ë£Œ (í¬ì§€ì…˜ í•„í„°ë§ í›„)`);\n\nif (results.length === 0) {\n  console.log(`â¹ï¸ ëª¨ë“  ì¢…ëª©ì´ ì´ë¯¸ ë³´ìœ ì¤‘ì´ê±°ë‚˜ ë°ì´í„° ì—†ìŒ - ì£¼ë¬¸ ìŠ¤í‚µ`);\n  return [];\n}\n\nreturn results;"
      },
      "id": "merge-data",
      "name": "ë°ì´í„° ë³‘í•© ë° í•„í„°ë§",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst signals = [];\n\nfor (const item of items) {\n  const data = item.json;\n\n  // ë§¤ìˆ˜ ì¡°ê±´ í™•ì¸\n  const buyConditions = data.entry_conditions?.buy || [];\n  let buySignal = false;\n\n  // TODO: ì‹¤ì œ ì§€í‘œ ê¸°ë°˜ ì¡°ê±´ í™•ì¸ (í˜„ì¬ëŠ” ê°„ë‹¨í•œ ì˜ˆì‹œ)\n  // ì‹¤ì œë¡œëŠ” RSI, MACD ë“± ê³„ì‚° í•„ìš”\n  if (buyConditions.length > 0) {\n    // ì˜ˆ: 3% ì´ìƒ í•˜ë½ ì‹œ ë§¤ìˆ˜\n    if (data.change_rate < -3) {\n      buySignal = true;\n    }\n  }\n\n  // ë§¤ë„ ì¡°ê±´ í™•ì¸ (ë³´ìœ  ì¢…ëª©ë§Œ)\n  const sellConditions = data.exit_conditions?.sell || [];\n  let sellSignal = false;\n\n  if (sellConditions.length > 0) {\n    // ì˜ˆ: 5% ì´ìƒ ìƒìŠ¹ ì‹œ ë§¤ë„\n    if (data.change_rate > 5) {\n      sellSignal = true;\n    }\n  }\n\n  // ì‹ í˜¸ ìƒì„±\n  if (buySignal) {\n    signals.push({\n      json: {\n        signal_type: 'buy',\n        ...data\n      }\n    });\n  }\n\n  if (sellSignal) {\n    signals.push({\n      json: {\n        signal_type: 'sell',\n        ...data\n      }\n    });\n  }\n}\n\nconsole.log(`ğŸ“Š ${signals.length}ê°œ ë§¤ë§¤ ì‹ í˜¸ ìƒì„±`);\nreturn signals;"
      },
      "id": "generate-signals",
      "name": "ë§¤ìˆ˜ë§¤ë„ ì‹ í˜¸ ìƒì„±",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "=https://hznkyaomtrpzcayayayh.supabase.co/rest/v1/orders?stock_code=eq.{{$json.stock_code}}&status=eq.PENDING&select=id,stock_code,status",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            }
          ]
        },
        "options": {}
      },
      "id": "check-pending-orders",
      "name": "ê¸°ì¡´ ëŒ€ê¸° ì£¼ë¬¸ í™•ì¸",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [1650, 300]
    },
    {
      "parameters": {
        "jsCode": "const signalData = $('ë§¤ìˆ˜ë§¤ë„ ì‹ í˜¸ ìƒì„±').first().json;\nconst pendingOrdersResponse = $input.first().json;\n\n// SupabaseëŠ” ë°°ì—´ë¡œ ë°˜í™˜\nconst pendingOrders = Array.isArray(pendingOrdersResponse) ? pendingOrdersResponse : [];\n\nconsole.log(`ğŸ“‹ ${signalData.stock_code}: ëŒ€ê¸°ì¤‘ì¸ ì£¼ë¬¸ ${pendingOrders.length}ê°œ ë°œê²¬`);\n\nif (pendingOrders.length > 0) {\n  console.log(`ğŸ—‘ï¸ ì´ì „ ì£¼ë¬¸ ì·¨ì†Œ í•„ìš”: ${pendingOrders.map(o => o.id).join(', ')}`);\n}\n\nreturn [{\n  json: {\n    ...signalData,\n    pending_orders: pendingOrders,\n    has_pending_orders: pendingOrders.length > 0\n  }\n}];"
      },
      "id": "prepare-cancel-data",
      "name": "ì·¨ì†Œ ë°ì´í„° ì¤€ë¹„",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1850, 300]
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "has-pending",
              "leftValue": "={{$json.has_pending_orders}}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-has-pending",
      "name": "ì´ì „ ì£¼ë¬¸ ìˆëŠ”ì§€ í™•ì¸",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [2050, 300]
    },
    {
      "parameters": {
        "jsCode": "const data = $input.first().json;\nconst pendingOrders = data.pending_orders || [];\n\nconst results = [];\n\nfor (const order of pendingOrders) {\n  results.push({\n    json: {\n      ...data,\n      cancel_order_id: order.id\n    }\n  });\n}\n\nconsole.log(`ğŸ“¤ ${results.length}ê°œ ì£¼ë¬¸ ì·¨ì†Œ ì¤€ë¹„`);\nreturn results;"
      },
      "id": "split-cancel-orders",
      "name": "ì·¨ì†Œí•  ì£¼ë¬¸ ë¶„ë¦¬",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2250, 200]
    },
    {
      "parameters": {
        "method": "PATCH",
        "url": "=https://hznkyaomtrpzcayayayh.supabase.co/rest/v1/orders?id=eq.{{$json.cancel_order_id}}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"status\": \"CANCELLED\", \"cancelled_at\": {{JSON.stringify(new Date().toISOString())}}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1,
              "batchInterval": 1000
            }
          }
        }
      },
      "id": "cancel-order",
      "name": "ì£¼ë¬¸ ì·¨ì†Œ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2450, 200]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst results = [];\n\nfor (const item of items) {\n  const signal = item.json;\n\n  // ì£¼ë¬¸ ê°€ê²© ì „ëµ\n  const strategy = signal.order_price_strategy[signal.signal_type];\n\n  // ê¸°ì¤€ ê°€ê²© ì„ íƒ\n  let basePrice = 0;\n\n  switch (strategy.type) {\n    case 'best_ask':\n      basePrice = signal.sell_price;\n      break;\n    case 'best_bid':\n      basePrice = signal.buy_price;\n      break;\n    case 'mid_price':\n      basePrice = signal.current_price;\n      break;\n    case 'market':\n      basePrice = null;\n      break;\n    default:\n      basePrice = signal.signal_type === 'buy' ? signal.sell_price : signal.buy_price;\n  }\n\n  // offset ì ìš©\n  const orderPrice = basePrice ? Math.round(basePrice + (strategy.offset || 0)) : null;\n  const orderMethod = basePrice === null ? 'MARKET' : 'LIMIT';\n\n  console.log(`[${signal.signal_type}] ${signal.stock_code}: ê¸°ì¤€=${basePrice}, offset=${strategy.offset}, ì£¼ë¬¸ê°€=${orderPrice}`);\n\n  results.push({\n    json: {\n      ...signal,\n      order_price: orderPrice,\n      order_method: orderMethod\n    }\n  });\n}\n\nreturn results;"
      },
      "id": "calc-price",
      "name": "ì£¼ë¬¸ ê°€ê²© ê³„ì‚°",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [2650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hznkyaomtrpzcayayayh.supabase.co/rest/v1/trading_signals",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\"stock_code\": {{JSON.stringify($json.stock_code)}}, \"stock_name\": {{JSON.stringify($json.stock_name || $json.stock_code)}}, \"signal_type\": {{JSON.stringify($json.signal_type)}}, \"strategy_id\": {{JSON.stringify($json.strategy_id)}}, \"current_price\": {{$json.current_price}}, \"change_rate\": {{$json.change_rate}}, \"volume\": {{$json.volume || 0}}, \"signal_strength\": 75, \"processed\": false}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "options": {}
      },
      "id": "save-signal",
      "name": "ì‹ í˜¸ ì €ì¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [2850, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mockapi.kiwoom.com/oauth2/token",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "{\n  \"grant_type\": \"client_credentials\",\n  \"appkey\": \"S0FEQ8I3UYwgcEPepJrfO6NteTCziz4540NljbYIASU\",\n  \"secretkey\": \"tBh2TG4i0nwvKMC5s_DCVSlnWec3pgvLEmxIqL2RDsA\"\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json;charset=UTF-8"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1,
              "batchInterval": 3000
            }
          }
        }
      },
      "id": "get-token",
      "name": "í‚¤ì›€ í† í° ë°œê¸‰",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [3050, 300]
    },
    {
      "parameters": {
        "jsCode": "const tokenData = $input.first().json;\nconst signalData = $('ì‹ í˜¸ ì €ì¥').first().json;\nconst priceCalcData = $('ì£¼ë¬¸ ê°€ê²© ê³„ì‚°').first().json;\n\nreturn {\n  json: {\n    ...signalData,\n    ...priceCalcData,\n    token: tokenData.token\n  }\n};"
      },
      "id": "merge-data-for-order",
      "name": "ë°ì´í„° ë³‘í•© (ì£¼ë¬¸ìš©)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3150, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mockapi.kiwoom.com/api/dostk/ordr",
        "sendBody": true,
        "specifyBody": "keypair",
        "bodyParameters": {
          "parameters": [
            {
              "name": "dmst_stex_tp",
              "value": "KRX"
            },
            {
              "name": "stk_cd",
              "value": "={{$json.stock_code}}"
            },
            {
              "name": "ord_qty",
              "value": "10"
            },
            {
              "name": "ord_uv",
              "value": ""
            },
            {
              "name": "trde_tp",
              "value": "3"
            },
            {
              "name": "cond_uv",
              "value": ""
            }
          ]
        },
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json;charset=UTF-8"
            },
            {
              "name": "authorization",
              "value": "={{\"Bearer \" + $json.token}}"
            },
            {
              "name": "cont-yn",
              "value": "N"
            },
            {
              "name": "next-key",
              "value": ""
            },
            {
              "name": "api-id",
              "value": "kt10000"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1,
              "batchInterval": 2000
            }
          }
        }
      },
      "id": "execute-order",
      "name": "ì£¼ë¬¸ ì‹¤í–‰",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [3250, 300]
    },
    {
      "parameters": {
        "jsCode": "// ì£¼ë¬¸ ì‹¤í–‰ ê²°ê³¼ (í‚¤ì›€ API ì‘ë‹µ)\nconst orderApiResponse = $input.first().json;\n\n// ì‹ í˜¸ ë°ì´í„° (ID í•„ìš”)\nconst signalData = $('ì‹ í˜¸ ì €ì¥').first().json;\n\n// ë³‘í•©ëœ ë°ì´í„° (ì£¼ë¬¸ ì •ë³´ í¬í•¨)\nconst mergedData = $('ë°ì´í„° ë³‘í•© (ì£¼ë¬¸ìš©)').first().json;\n\nreturn {\n  json: {\n    signal_id: signalData.id,\n    strategy_id: mergedData.strategy_id,\n    stock_code: mergedData.stock_code,\n    stock_name: mergedData.stock_name || mergedData.stock_code,\n    order_type: mergedData.signal_type.toUpperCase(),\n    order_method: mergedData.order_method,\n    quantity: 10,\n    order_price: mergedData.order_price || 0,\n    status: 'PENDING',\n    api_response: JSON.stringify(orderApiResponse)\n  }\n};"
      },
      "id": "prepare-order-data",
      "name": "ì£¼ë¬¸ ë°ì´í„° ì¤€ë¹„",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [3450, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://hznkyaomtrpzcayayayh.supabase.co/rest/v1/orders",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{JSON.stringify($json)}}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "Authorization",
              "value": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        },
        "options": {}
      },
      "id": "save-order",
      "name": "ì£¼ë¬¸ ê²°ê³¼ ì €ì¥",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [3650, 300]
    }
  ],
  "connections": {
    "5ë¶„ë§ˆë‹¤ ì‹¤í–‰": {
      "main": [
        [
          {
            "node": "ì‹œì¥ ìš´ì˜ì‹œê°„ ì²´í¬",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì‹œì¥ ìš´ì˜ì‹œê°„ ì²´í¬": {
      "main": [
        [
          {
            "node": "í™˜ê²½ë³€ìˆ˜ ì„¤ì •",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "í™˜ê²½ë³€ìˆ˜ ì„¤ì •": {
      "main": [
        [
          {
            "node": "í™œì„± ì „ëµ ì¡°íšŒ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "í™œì„± ì „ëµ ì¡°íšŒ": {
      "main": [
        [
          {
            "node": "ìœ ë‹ˆë²„ìŠ¤ ì¢…ëª© ì¶”ì¶œ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ìœ ë‹ˆë²„ìŠ¤ ì¢…ëª© ì¶”ì¶œ": {
      "main": [
        [
          {
            "node": "í¬ì§€ì…˜ í™•ì¸",
            "type": "main",
            "index": 0
          },
          {
            "node": "í˜„ì¬ê°€ ì¡°íšŒ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "í¬ì§€ì…˜ í™•ì¸": {
      "main": [
        [
          {
            "node": "ë°ì´í„° ë³‘í•© ë° í•„í„°ë§",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "í˜„ì¬ê°€ ì¡°íšŒ": {
      "main": [
        [
          {
            "node": "ë°ì´í„° ë³‘í•© ë° í•„í„°ë§",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "ë°ì´í„° ë³‘í•© ë° í•„í„°ë§": {
      "main": [
        [
          {
            "node": "ë§¤ìˆ˜ë§¤ë„ ì‹ í˜¸ ìƒì„±",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ë§¤ìˆ˜ë§¤ë„ ì‹ í˜¸ ìƒì„±": {
      "main": [
        [
          {
            "node": "ê¸°ì¡´ ëŒ€ê¸° ì£¼ë¬¸ í™•ì¸",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ê¸°ì¡´ ëŒ€ê¸° ì£¼ë¬¸ í™•ì¸": {
      "main": [
        [
          {
            "node": "ì·¨ì†Œ ë°ì´í„° ì¤€ë¹„",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì·¨ì†Œ ë°ì´í„° ì¤€ë¹„": {
      "main": [
        [
          {
            "node": "ì´ì „ ì£¼ë¬¸ ìˆëŠ”ì§€ í™•ì¸",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì´ì „ ì£¼ë¬¸ ìˆëŠ”ì§€ í™•ì¸": {
      "main": [
        [
          {
            "node": "ì·¨ì†Œí•  ì£¼ë¬¸ ë¶„ë¦¬",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "ì£¼ë¬¸ ê°€ê²© ê³„ì‚°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì·¨ì†Œí•  ì£¼ë¬¸ ë¶„ë¦¬": {
      "main": [
        [
          {
            "node": "ì£¼ë¬¸ ì·¨ì†Œ",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì£¼ë¬¸ ì·¨ì†Œ": {
      "main": [
        [
          {
            "node": "ì£¼ë¬¸ ê°€ê²© ê³„ì‚°",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì£¼ë¬¸ ê°€ê²© ê³„ì‚°": {
      "main": [
        [
          {
            "node": "ì‹ í˜¸ ì €ì¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì‹ í˜¸ ì €ì¥": {
      "main": [
        [
          {
            "node": "í‚¤ì›€ í† í° ë°œê¸‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "í‚¤ì›€ í† í° ë°œê¸‰": {
      "main": [
        [
          {
            "node": "ë°ì´í„° ë³‘í•© (ì£¼ë¬¸ìš©)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ë°ì´í„° ë³‘í•© (ì£¼ë¬¸ìš©)": {
      "main": [
        [
          {
            "node": "ì£¼ë¬¸ ì‹¤í–‰",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì£¼ë¬¸ ì‹¤í–‰": {
      "main": [
        [
          {
            "node": "ì£¼ë¬¸ ë°ì´í„° ì¤€ë¹„",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ì£¼ë¬¸ ë°ì´í„° ì¤€ë¹„": {
      "main": [
        [
          {
            "node": "ì£¼ë¬¸ ê²°ê³¼ ì €ì¥",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [],
  "triggerCount": 1,
  "updatedAt": "2025-01-13T00:00:00.000Z",
  "versionId": "6"
}
