{
  "name": "ìë™ë§¤ë§¤ ëª¨ë‹ˆí„°ë§ v32 (ë°°ì¹˜ ì²˜ë¦¬ 5ê°œì”©)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "hours",
              "hoursInterval": 1
            }
          ]
        }
      },
      "id": "schedule-1",
      "name": "1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "SUPABASE_URL",
              "value": "https://hznkyaomtrpzcayayayh.supabase.co"
            },
            {
              "name": "SUPABASE_ANON_KEY",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "KIWOOM_APP_KEY",
              "value": "S0FEQ8I3UYwgcEPepJrfO6NteTCziz4540NljbYIASU"
            },
            {
              "name": "KIWOOM_APP_SECRET",
              "value": "tBh2TG4i0nwvKMC5s_DCVSlnWec3pgvLEmxIqL2RDsA"
            },
            {
              "name": "BACKEND_URL",
              "value": "http://192.168.50.150:8000"
            }
          ]
        }
      },
      "id": "set-env-1",
      "name": "í™˜ê²½ë³€ìˆ˜ ì„¤ì •",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [450, 300]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{new Date().getHours()}}",
              "operation": "largerEqual",
              "value2": 9
            },
            {
              "value1": "={{new Date().getHours()}}",
              "operation": "smallerEqual",
              "value2": 15
            },
            {
              "value1": "={{new Date().getDay()}}",
              "operation": "largerEqual",
              "value2": 1
            },
            {
              "value1": "={{new Date().getDay()}}",
              "operation": "smallerEqual",
              "value2": 5
            }
          ]
        }
      },
      "id": "market-check-1",
      "name": "ì¥ì‹œê°„ ì²´í¬",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [650, 300]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mockapi.kiwoom.com/oauth2/token",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"grant_type\": \"client_credentials\",\n  \"appkey\": \"{{$node[\"í™˜ê²½ë³€ìˆ˜ ì„¤ì •\"].json[\"KIWOOM_APP_KEY\"]}}\",\n  \"secretkey\": \"{{$node[\"í™˜ê²½ë³€ìˆ˜ ì„¤ì •\"].json[\"KIWOOM_APP_SECRET\"]}}\"\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json;charset=UTF-8"
            }
          ]
        }
      },
      "id": "get-token-1",
      "name": "í‚¤ì›€ í† í° ë°œê¸‰",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{$node[\"í™˜ê²½ë³€ìˆ˜ ì„¤ì •\"].json[\"SUPABASE_URL\"]}}/rest/v1/rpc/get_active_strategies_with_universe",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "authorization",
              "value": "={{\"Bearer \" + $node[\"í™˜ê²½ë³€ìˆ˜ ì„¤ì •\"].json[\"SUPABASE_ANON_KEY\"]}}"
            },
            {
              "name": "apikey",
              "value": "={{$node[\"í™˜ê²½ë³€ìˆ˜ ì„¤ì •\"].json[\"SUPABASE_ANON_KEY\"]}}"
            }
          ]
        }
      },
      "id": "get-strategies-1",
      "name": "ìë™ë§¤ë§¤ ì „ëµ ì¡°íšŒ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 300]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst envVars = $('í™˜ê²½ë³€ìˆ˜ ì„¤ì •').first().json;\nconst tokenData = $('í‚¤ì›€ í† í° ë°œê¸‰').first().json;\n\nconst results = [];\n\nfor (const item of items) {\n  const strategy = item.json;\n  let stockCodes = [];\n\n  if (strategy.filtered_stocks) {\n    if (Array.isArray(strategy.filtered_stocks)) {\n      stockCodes = strategy.filtered_stocks.filter(code => code && typeof code === 'string');\n    } else if (typeof strategy.filtered_stocks === 'object') {\n      stockCodes = Object.values(strategy.filtered_stocks).filter(code => code && typeof code === 'string');\n    }\n  }\n\n  console.log(`ğŸ“Š Strategy: ${strategy.strategy_name}, Stock count: ${stockCodes.length}`);\n\n  // 5ê°œì”© ë°°ì¹˜ë¡œ ë‚˜ëˆ„ê¸°\n  const batchSize = 5;\n  for (let batchIndex = 0; batchIndex < Math.ceil(stockCodes.length / batchSize); batchIndex++) {\n    const batchStart = batchIndex * batchSize;\n    const batchEnd = Math.min(batchStart + batchSize, stockCodes.length);\n    const batch = stockCodes.slice(batchStart, batchEnd);\n\n    results.push({\n      json: {\n        batch_index: batchIndex,\n        batch_start: batchStart,\n        batch_end: batchEnd,\n        total_batches: Math.ceil(stockCodes.length / batchSize),\n        stocks: batch,\n        strategy_id: strategy.strategy_id,\n        strategy_name: strategy.strategy_name,\n        access_token: tokenData.token,\n        KIWOOM_APP_KEY: envVars.KIWOOM_APP_KEY,\n        SUPABASE_URL: envVars.SUPABASE_URL,\n        SUPABASE_ANON_KEY: envVars.SUPABASE_ANON_KEY\n      }\n    });\n  }\n}\n\nconsole.log(`âœ… Total batches created: ${results.length}`);\nreturn results;"
      },
      "id": "create-batches",
      "name": "ë°°ì¹˜ ìƒì„± (5ê°œì”©)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1250, 300]
    },
    {
      "parameters": {
        "batchSize": 1,
        "options": {}
      },
      "id": "loop-batches",
      "name": "ë°°ì¹˜ë³„ ë£¨í”„",
      "type": "n8n-nodes-base.splitInBatches",
      "typeVersion": 3,
      "position": [1450, 300]
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// ë°°ì¹˜ ë‚´ ì¢…ëª© ì²˜ë¦¬ (5ê°œì”©, 60ì´ˆ ê°„ê²©)\n// ============================================================================\n\nconst batch = $input.first().json;\nconst envVars = $('í™˜ê²½ë³€ìˆ˜ ì„¤ì •').first().json;\n\nconsole.log(`ğŸ“¦ ë°°ì¹˜ ${batch.batch_index + 1}/${batch.total_batches} ì²˜ë¦¬ ì¤‘ (ì¢…ëª© ${batch.batch_start + 1}-${batch.batch_end})`);\n\nconst results = [];\n\nfor (let i = 0; i < batch.stocks.length; i++) {\n  const stockCode = batch.stocks[i];\n  \n  // ì²« ë²ˆì§¸ ì¢…ëª©ì´ ì•„ë‹ˆë©´ 60ì´ˆ ëŒ€ê¸°\n  if (i > 0) {\n    console.log(`â±ï¸ 60ì´ˆ ëŒ€ê¸° ì¤‘...`);\n    await new Promise(resolve => setTimeout(resolve, 60000));\n  }\n\n  console.log(`ğŸ” [${batch.batch_start + i + 1}] ${stockCode} ì¡°íšŒ ì¤‘...`);\n\n  try {\n    // í‚¤ì›€ í˜¸ê°€ ì¡°íšŒ\n    const response = await fetch('https://mockapi.kiwoom.com/api/dostk/mrkcond', {\n      method: 'POST',\n      headers: {\n        'Content-Type': 'application/json;charset=UTF-8',\n        'authorization': `Bearer ${batch.access_token}`,\n        'cont-yn': 'N',\n        'next-key': '',\n        'api-id': 'ka10004',\n        'accept': 'application/json'\n      },\n      body: JSON.stringify({ stk_cd: stockCode })\n    });\n\n    const kiwoomData = await response.json();\n\n    const parsePrice = (price) => {\n      if (!price) return 0;\n      return parseFloat(String(price).replace(/[+\\-]/g, ''));\n    };\n\n    const selPrice = parsePrice(kiwoomData.sel_fpr_bid);\n    const buyPrice = parsePrice(kiwoomData.buy_fpr_bid);\n    const estimatedPrice = (selPrice + buyPrice) / 2;\n\n    // ì¢…ëª©ëª… ì¡°íšŒ\n    let stockName = stockCode;\n    try {\n      const metaResponse = await fetch(\n        `${batch.SUPABASE_URL}/rest/v1/stock_metadata?stock_code=eq.${stockCode}&select=stock_name`,\n        {\n          headers: {\n            'apikey': batch.SUPABASE_ANON_KEY,\n            'Authorization': `Bearer ${batch.SUPABASE_ANON_KEY}`\n          }\n        }\n      );\n      const metaData = await metaResponse.json();\n      if (metaData && metaData.length > 0 && metaData[0].stock_name) {\n        stockName = metaData[0].stock_name;\n      }\n    } catch (error) {\n      console.error('Failed to fetch stock name:', error);\n    }\n\n    // ì „ì¼ ì¢…ê°€ ì¡°íšŒ\n    let previousClose = estimatedPrice;\n    try {\n      const priceResponse = await fetch(\n        `${batch.SUPABASE_URL}/rest/v1/kw_price_daily?stock_code=eq.${stockCode}&select=close&order=trade_date.desc&limit=1`,\n        {\n          headers: {\n            'apikey': batch.SUPABASE_ANON_KEY,\n            'Authorization': `Bearer ${batch.SUPABASE_ANON_KEY}`\n          }\n        }\n      );\n      const priceData = await priceResponse.json();\n      if (priceData && priceData.length > 0) {\n        previousClose = parseFloat(priceData[0].close);\n      }\n    } catch (error) {\n      console.error('Failed to fetch previous close:', error);\n    }\n\n    const changePrice = estimatedPrice - previousClose;\n    const changeRate = previousClose > 0 ? ((changePrice / previousClose) * 100) : 0;\n\n    const selVolume = parseInt(String(kiwoomData.sel_fpr_req || 0).replace(/[+\\-]/g, '')) || 0;\n    const buyVolume = parseInt(String(kiwoomData.buy_fpr_req || 0).replace(/[+\\-]/g, '')) || 0;\n\n    // ì¢…ëª© ë§ˆìŠ¤í„° ì €ì¥\n    try {\n      await fetch(`${batch.SUPABASE_URL}/rest/v1/kw_stock_master`, {\n        method: 'POST',\n        headers: {\n          'apikey': batch.SUPABASE_ANON_KEY,\n          'Authorization': `Bearer ${batch.SUPABASE_ANON_KEY}`,\n          'Content-Type': 'application/json',\n          'Prefer': 'resolution=merge-duplicates'\n        },\n        body: JSON.stringify({\n          stock_code: stockCode,\n          stock_name: stockName,\n          market: 'KOSPI'\n        })\n      });\n    } catch (error) {\n      console.error('Failed to save stock master:', error);\n    }\n\n    // í˜„ì¬ê°€ ì €ì¥\n    try {\n      await fetch(`${batch.SUPABASE_URL}/rest/v1/kw_price_current`, {\n        method: 'POST',\n        headers: {\n          'apikey': batch.SUPABASE_ANON_KEY,\n          'Authorization': `Bearer ${batch.SUPABASE_ANON_KEY}`,\n          'Content-Type': 'application/json',\n          'Prefer': 'resolution=merge-duplicates'\n        },\n        body: JSON.stringify({\n          stock_code: stockCode,\n          stock_name: stockName,\n          current_price: estimatedPrice,\n          change_price: changePrice,\n          change_rate: changeRate,\n          volume: selVolume + buyVolume,\n          high_52w: selPrice,\n          low_52w: buyPrice,\n          market_cap: 0\n        })\n      });\n    } catch (error) {\n      console.error('Failed to save current price:', error);\n    }\n\n    results.push({\n      json: {\n        stock_code: stockCode,\n        stock_name: stockName,\n        current_price: estimatedPrice,\n        change_rate: changeRate,\n        success: true\n      }\n    });\n\n    console.log(`âœ… ${stockCode} (${stockName}) - ${estimatedPrice.toLocaleString()}ì›`);\n\n  } catch (error) {\n    console.error(`âŒ ${stockCode} ì²˜ë¦¬ ì‹¤íŒ¨:`, error.message);\n    results.push({\n      json: {\n        stock_code: stockCode,\n        error: error.message,\n        success: false\n      }\n    });\n  }\n}\n\nconsole.log(`âœ… ë°°ì¹˜ ${batch.batch_index + 1} ì™„ë£Œ: ${results.length}ê°œ ì¢…ëª© ì²˜ë¦¬`);\nreturn results;"
      },
      "id": "process-batch",
      "name": "ë°°ì¹˜ ë‚´ ì¢…ëª© ì²˜ë¦¬",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [1650, 200]
    },
    {
      "parameters": {},
      "id": "batch-complete",
      "name": "ëª¨ë“  ë°°ì¹˜ ì™„ë£Œ",
      "type": "n8n-nodes-base.noOp",
      "typeVersion": 1,
      "position": [1650, 400]
    }
  ],
  "connections": {
    "1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰": {
      "main": [[{"node": "í™˜ê²½ë³€ìˆ˜ ì„¤ì •", "type": "main", "index": 0}]]
    },
    "í™˜ê²½ë³€ìˆ˜ ì„¤ì •": {
      "main": [[{"node": "ì¥ì‹œê°„ ì²´í¬", "type": "main", "index": 0}]]
    },
    "ì¥ì‹œê°„ ì²´í¬": {
      "main": [[{"node": "í‚¤ì›€ í† í° ë°œê¸‰", "type": "main", "index": 0}]]
    },
    "í‚¤ì›€ í† í° ë°œê¸‰": {
      "main": [[{"node": "ìë™ë§¤ë§¤ ì „ëµ ì¡°íšŒ", "type": "main", "index": 0}]]
    },
    "ìë™ë§¤ë§¤ ì „ëµ ì¡°íšŒ": {
      "main": [[{"node": "ë°°ì¹˜ ìƒì„± (5ê°œì”©)", "type": "main", "index": 0}]]
    },
    "ë°°ì¹˜ ìƒì„± (5ê°œì”©)": {
      "main": [[{"node": "ë°°ì¹˜ë³„ ë£¨í”„", "type": "main", "index": 0}]]
    },
    "ë°°ì¹˜ë³„ ë£¨í”„": {
      "main": [
        [{"node": "ë°°ì¹˜ ë‚´ ì¢…ëª© ì²˜ë¦¬", "type": "main", "index": 0}],
        [{"node": "ëª¨ë“  ë°°ì¹˜ ì™„ë£Œ", "type": "main", "index": 0}]
      ]
    },
    "ë°°ì¹˜ ë‚´ ì¢…ëª© ì²˜ë¦¬": {
      "main": [[{"node": "ë°°ì¹˜ë³„ ë£¨í”„", "type": "main", "index": 0}]]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveExecutionProgress": true,
    "executionTimeout": 3600
  }
}
