# 워크플로우 B Rate Limiting 설정

## 📋 변경 사항 (2025-11-12)

### 문제점
키움 API에서 **429 Too Many Requests** 에러 발생:
- 여러 종목에 대해 동시에 토큰 발급 및 주문 실행
- 키움 API Rate Limit 초과

### 해결 방법
HTTP Request 노드에 **Batching** 옵션 추가

## 🔧 적용된 Rate Limiting 설정

### 1. 키움 토큰 발급 노드
```json
{
  "options": {
    "batching": {
      "batch": {
        "batchSize": 1,
        "batchInterval": 2000
      }
    }
  }
}
```
- **Batch Size**: 1 (한 번에 1개씩 처리)
- **Batch Interval**: 2000ms (각 요청 사이에 2초 대기)

### 2. 주문 실행 노드
```json
{
  "options": {
    "batching": {
      "batch": {
        "batchSize": 1,
        "batchInterval": 1000
      }
    }
  }
}
```
- **Batch Size**: 1 (한 번에 1개씩 처리)
- **Batch Interval**: 1000ms (각 요청 사이에 1초 대기)

## 📊 예상 동작

### Before (Rate Limiting 없음)
```
신호 1, 2, 3 생성
    ↓
토큰 발급 (동시에 3번) ❌ 429 Error
    ↓
주문 실행 실패
```

### After (Rate Limiting 적용)
```
신호 1, 2, 3 생성
    ↓
토큰 발급 1 (0초)
    ↓ 2초 대기
토큰 발급 2 (2초)
    ↓ 2초 대기
토큰 발급 3 (4초)
    ↓
주문 실행 1 (4초)
    ↓ 1초 대기
주문 실행 2 (5초)
    ↓ 1초 대기
주문 실행 3 (6초) ✅ Success
```

## 🔄 n8n에 워크플로우 업데이트 방법

### 방법 1: JSON 파일 Import (권장)
1. n8n 대시보드 접속
2. 워크플로우 B 열기
3. 우측 상단 **"..."** 메뉴 클릭
4. **"Import from File"** 선택
5. `auto-trading-workflow-b-v1.json` 파일 선택
6. **"Replace workflow"** 선택하여 기존 워크플로우 교체

### 방법 2: 수동 설정
1. n8n에서 워크플로우 B 열기
2. **"키움 토큰 발급"** 노드 클릭
3. **Parameters** → **Options** 섹션 열기
4. **"Add Option"** → **"Batching"** 선택
5. 다음 값 입력:
   - Batch Size: `1`
   - Batch Interval: `2000`
6. **"주문 실행"** 노드에도 동일하게 적용 (Batch Interval만 `1000`으로 설정)
7. 저장

## ⚠️ 주의사항

1. **워크플로우 실행 시간 증가**
   - 신호가 많을수록 전체 실행 시간이 길어집니다
   - 예: 10개 신호 = 약 30초 소요 (토큰 발급 20초 + 주문 실행 10초)

2. **시장가 주문 시 주의**
   - Rate Limiting으로 인해 주문 실행이 지연될 수 있습니다
   - 가격 변동성이 큰 종목의 경우 불리한 가격에 체결될 수 있습니다

3. **키움 API Rate Limit**
   - 현재 설정은 보수적인 값입니다
   - 필요시 Batch Interval을 줄일 수 있습니다 (최소 권장: 500ms)

## 📈 성능 최적화 제안

### 향후 개선 사항
1. **토큰 캐싱**: 한 번 발급받은 토큰을 여러 주문에서 재사용
2. **배치 주문 API**: 키움 API가 지원하는 경우 한 번에 여러 주문 전송
3. **신호 우선순위**: 중요한 신호를 먼저 처리하는 로직 추가

## 🧪 테스트 방법

1. n8n 워크플로우 B를 수동으로 실행
2. 실행 로그에서 각 노드의 실행 시간 확인
3. 키움 API 에러가 발생하지 않는지 확인
4. 모든 신호가 정상적으로 처리되는지 확인

## 📝 변경 이력

| 날짜 | 변경 내용 | 작성자 |
|------|----------|--------|
| 2025-11-12 | Rate Limiting 설정 추가 (토큰 발급: 2초, 주문 실행: 1초) | Claude Code |
