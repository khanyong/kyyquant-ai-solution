{
  "name": "ÏûêÎèôÎß§Îß§ Î™®ÎãàÌÑ∞ÎßÅ v23 (ÏßÄÌëú Í≥ÑÏÇ∞ API Ï†úÍ±∞)",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 5
            }
          ]
        }
      },
      "id": "schedule-1",
      "name": "5Î∂ÑÎßàÎã§ Ïã§Ìñâ",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [
        250,
        300
      ]
    },
    {
      "parameters": {
        "values": {
          "string": [
            {
              "name": "SUPABASE_URL",
              "value": "https://hznkyaomtrpzcayayayh.supabase.co"
            },
            {
              "name": "SUPABASE_ANON_KEY",
              "value": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imh6bmt5YW9tdHJwemNheWF5YXloIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1NTAwMDksImV4cCI6MjA3MjEyNjAwOX0.obZl3gnWisI-Eg8zWzestO7z3IQpFi6kViEJprsaJbs"
            },
            {
              "name": "KIWOOM_APP_KEY",
              "value": "S0FEQ8I3UYwgcEPepJrfO6NteTCziz4540NljbYIASU"
            },
            {
              "name": "KIWOOM_APP_SECRET",
              "value": "tBh2TG4i0nwvKMC5s_DCVSlnWec3pgvLEmxIqL2RDsA"
            },
            {
              "name": "BACKEND_URL",
              "value": "http://192.168.50.150:8000"
            }
          ]
        }
      },
      "id": "set-env-1",
      "name": "ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï",
      "type": "n8n-nodes-base.set",
      "typeVersion": 2,
      "position": [
        450,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "number": [
            {
              "value1": "={{new Date().getHours()}}",
              "operation": "largerEqual",
              "value2": 9
            },
            {
              "value1": "={{new Date().getHours()}}",
              "operation": "smallerEqual",
              "value2": 15
            },
            {
              "value1": "={{new Date().getDay()}}",
              "operation": "largerEqual",
              "value2": 1
            },
            {
              "value1": "={{new Date().getDay()}}",
              "operation": "smallerEqual",
              "value2": 5
            }
          ]
        }
      },
      "id": "market-check-1",
      "name": "Ïû•ÏãúÍ∞Ñ Ï≤¥ÌÅ¨",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        650,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mockapi.kiwoom.com/oauth2/token",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"grant_type\": \"client_credentials\",\n  \"appkey\": \"{{$node[\"ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï\"].json[\"KIWOOM_APP_KEY\"]}}\",\n  \"secretkey\": \"{{$node[\"ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï\"].json[\"KIWOOM_APP_SECRET\"]}}\"\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json;charset=UTF-8"
            }
          ]
        }
      },
      "id": "get-token-1",
      "name": "ÌÇ§ÏõÄ ÌÜ†ÌÅ∞ Î∞úÍ∏â",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        850,
        300
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{$node[\"ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï\"].json[\"SUPABASE_URL\"]}}/rest/v1/rpc/get_active_strategies_with_universe",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "authorization",
              "value": "={{\"Bearer \" + $node[\"ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï\"].json[\"SUPABASE_ANON_KEY\"]}}"
            },
            {
              "name": "apikey",
              "value": "={{$node[\"ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï\"].json[\"SUPABASE_ANON_KEY\"]}}"
            }
          ]
        }
      },
      "id": "get-strategies-1",
      "name": "ÏûêÎèôÎß§Îß§ Ï†ÑÎûµ Ï°∞Ìöå",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1050,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all();\nconst results = [];\n\nconst envVars = $('ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï').first().json;\nconst tokenData = $('ÌÇ§ÏõÄ ÌÜ†ÌÅ∞ Î∞úÍ∏â').first().json;\n\nfor (const item of items) {\n  const strategy = item.json;\n  let stockCodes = [];\n\n  // filtered_stocksÍ∞Ä jsonb ÌÉÄÏûÖÏù∏ Í≤ΩÏö∞ Ï≤òÎ¶¨\n  if (strategy.filtered_stocks) {\n    if (Array.isArray(strategy.filtered_stocks)) {\n      // Ïù¥ÎØ∏ Î∞∞Ïó¥Ïù∏ Í≤ΩÏö∞ (JavaScriptÏóêÏÑú ÌååÏã±Îê®)\n      stockCodes = strategy.filtered_stocks.filter(code => code && typeof code === 'string');\n    } else if (typeof strategy.filtered_stocks === 'object') {\n      // jsonb Í∞ùÏ≤¥Ïù∏ Í≤ΩÏö∞ Î∞∞Ïó¥Î°ú Î≥ÄÌôò\n      stockCodes = Object.values(strategy.filtered_stocks).filter(code => code && typeof code === 'string');\n    }\n  }\n\n  console.log(`üìä Strategy: ${strategy.strategy_name}, Stock count: ${stockCodes.length}`);\n\n  stockCodes.forEach(stockCode => {\n    results.push({\n      json: {\n        strategy_id: strategy.strategy_id,\n        strategy_name: strategy.strategy_name,\n        entry_conditions: strategy.entry_conditions,\n        exit_conditions: strategy.exit_conditions,\n        stock_code: stockCode,\n        access_token: tokenData.token,\n        KIWOOM_APP_KEY: envVars.KIWOOM_APP_KEY,\n        KIWOOM_APP_SECRET: envVars.KIWOOM_APP_SECRET,\n        SUPABASE_URL: envVars.SUPABASE_URL,\n        SUPABASE_ANON_KEY: envVars.SUPABASE_ANON_KEY,\n        BACKEND_URL: envVars.BACKEND_URL\n      }\n    });\n  });\n}\n\nconsole.log(`‚úÖ Total items created: ${results.length}`);\nreturn results;"
      },
      "id": "extract-stocks-1",
      "name": "Ï¢ÖÎ™© ÏΩîÎìú Ï∂îÏ∂ú",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1250,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://mockapi.kiwoom.com/api/dostk/mrkcond",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"stk_cd\": \"{{$json.stock_code}}\"\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json;charset=UTF-8"
            },
            {
              "name": "authorization",
              "value": "={{\"Bearer \" + $json.access_token}}"
            },
            {
              "name": "cont-yn",
              "value": "N"
            },
            {
              "name": "next-key",
              "value": ""
            },
            {
              "name": "api-id",
              "value": "ka10004"
            }
          ]
        },
        "options": {
          "batching": {
            "batch": {
              "batchSize": 1,
              "batchInterval": 6000
            }
          }
        }
      },
      "id": "get-price-1",
      "name": "ÌÇ§ÏõÄ Ìò∏Í∞Ä Ï°∞Ìöå",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        1450,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// ÌÇ§ÏõÄ Ìò∏Í∞Ä Ï°∞Ìöå Í≤∞Í≥ºÎ•º Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©\nconst kiwoomData = $input.item.json;\n\n// Ï¢ÖÎ™© ÏΩîÎìú Ï∂îÏ∂ú ÎÖ∏ÎìúÏùò Îç∞Ïù¥ÌÑ∞Îäî pairedItemÏúºÎ°ú Ï†ëÍ∑º\nconst originalItem = $input.item;\nconst originalData = $('Ï¢ÖÎ™© ÏΩîÎìú Ï∂îÏ∂ú').item(originalItem.pairedItem).json;\n\nconsole.log('üîÑ Îç∞Ïù¥ÌÑ∞ Î≥ëÌï© ÏãúÏûë');\nconsole.log('üìã Original stock_code:', originalData.stock_code);\nconsole.log('üìã Original strategy_id:', originalData.strategy_id);\nconsole.log('üìã Original strategy_name:', originalData.strategy_name);\n\n// ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ Î≥¥Ï°¥\nconst mergedData = {\n  _original_stock_code: originalData.stock_code,\n  _original_strategy_id: originalData.strategy_id,\n  _original_strategy_name: originalData.strategy_name,\n  _original_entry_conditions: originalData.entry_conditions,\n  _original_exit_conditions: originalData.exit_conditions,\n  _original_SUPABASE_URL: originalData.SUPABASE_URL,\n  _original_SUPABASE_ANON_KEY: originalData.SUPABASE_ANON_KEY,\n  _original_BACKEND_URL: originalData.BACKEND_URL,\n\n  // ÌÇ§ÏõÄ API ÏùëÎãµ Îç∞Ïù¥ÌÑ∞ Î≥ëÌï©\n  ...kiwoomData\n};\n\nconsole.log('‚úÖ Merged data keys:', Object.keys(mergedData));\nconsole.log('‚úÖ _original_stock_code:', mergedData._original_stock_code);\nconsole.log('‚úÖ _original_strategy_id:', mergedData._original_strategy_id);\n\nreturn mergedData;"
      },
      "id": "merge-data-1",
      "name": "Îç∞Ïù¥ÌÑ∞ Î≥ëÌï©",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1650,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "// Î≥ëÌï©Îêú Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ï†ïÎ≥¥ Ï∂îÏ∂ú\nconst item = $input.item.json;\nconst kiwoomData = item;\n\n// ÌôòÍ≤ΩÎ≥ÄÏàòÎ•º ÏßÅÏ†ë Ï∞∏Ï°∞\nconst envVars = $('ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï').first().json;\n\n// Ïù¥Ï†Ñ ÎÖ∏Îìú(Îç∞Ïù¥ÌÑ∞ Î≥ëÌï©)ÏóêÏÑú Ï∂îÍ∞ÄÌïú ÏõêÎ≥∏ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©\nconst strategy_id = kiwoomData._original_strategy_id || '';\nconst strategy_name = kiwoomData._original_strategy_name || '';\nconst entry_conditions = kiwoomData._original_entry_conditions;\nconst exit_conditions = kiwoomData._original_exit_conditions;\nconst stockCode = kiwoomData._original_stock_code || '';\nconst SUPABASE_URL = kiwoomData._original_SUPABASE_URL || envVars.SUPABASE_URL;\nconst SUPABASE_ANON_KEY = kiwoomData._original_SUPABASE_ANON_KEY || envVars.SUPABASE_ANON_KEY;\nconst BACKEND_URL = kiwoomData._original_BACKEND_URL || envVars.BACKEND_URL;\n\nconsole.log('üéØ Ï°∞Í±¥ Ï≤¥ÌÅ¨ ÏãúÏûë');\nconsole.log('üìã Stock code:', stockCode);\nconsole.log('üìã Strategy:', strategy_name);\n\n// Ìò∏Í∞Ä Îç∞Ïù¥ÌÑ∞ ÌååÏã± (Î∂ÄÌò∏ Ï†úÍ±∞ Î∞è Ïà´Ïûê Î≥ÄÌôò)\nconst parsePrice = (price) => {\n  if (!price) return 0;\n  return parseFloat(String(price).replace(/[+\\-]/g, ''));\n};\n\nconst selPrice = parsePrice(kiwoomData.sel_fpr_bid);\nconst buyPrice = parsePrice(kiwoomData.buy_fpr_bid);\nconst estimatedPrice = (selPrice + buyPrice) / 2;\n\n// ‚≠ê Ï¢ÖÎ™©Î™Ö Ï°∞Ìöå: stock_metadata ÌÖåÏù¥Î∏îÏóêÏÑú Í∞ÄÏ†∏Ïò§Í∏∞\nlet stockName = stockCode; // Í∏∞Î≥∏Í∞í: Ï¢ÖÎ™©ÏΩîÎìú\n\ntry {\n  const response = await fetch(\n    `${SUPABASE_URL}/rest/v1/stock_metadata?stock_code=eq.${stockCode}&select=stock_name`,\n    {\n      headers: {\n        'apikey': SUPABASE_ANON_KEY,\n        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`\n      }\n    }\n  );\n\n  const data = await response.json();\n  if (data && data.length > 0 && data[0].stock_name) {\n    stockName = data[0].stock_name;\n  }\n} catch (error) {\n  console.error('Failed to fetch stock name:', error);\n}\n\n// Í±∞ÎûòÎüâ Í≥ÑÏÇ∞ (Î¨∏ÏûêÏó¥ÏùÑ Ïà´ÏûêÎ°ú Î≥ÄÌôò)\nconst selVolume = parseInt(String(kiwoomData.sel_fpr_req || 0).replace(/[+\\-]/g, '')) || 0;\nconst buyVolume = parseInt(String(kiwoomData.buy_fpr_req || 0).replace(/[+\\-]/g, '')) || 0;\n\n// ‚≠ê‚≠ê‚≠ê ÏßÄÌëú Í∞ùÏ≤¥: Ìò∏Í∞Ä Îç∞Ïù¥ÌÑ∞Îßå ÏÇ¨Ïö© (Backend API Ï†úÍ±∞)\nconst indicators = {\n  close: estimatedPrice,\n  sel_price: selPrice,\n  buy_price: buyPrice,\n  volume: selVolume + buyVolume\n};\n\nconsole.log('üìà Indicators:', indicators);\n\n// Îß§Ïàò/Îß§ÎèÑ Ïã†Ìò∏Îäî Ï°∞Í±¥Ïù¥ ÏóÜÏúºÎØÄÎ°ú Ìï≠ÏÉÅ false\nconst buySignal = false;\nconst sellSignal = false;\n\nreturn {\n  strategy_id: strategy_id,\n  strategy_name: strategy_name,\n  stock_code: stockCode,\n  stock_name: stockName,\n  current_price: estimatedPrice,\n  indicators: indicators,\n  buy_signal: buySignal,\n  sell_signal: sellSignal,\n  signal_type: 'NONE',\n  signal_strength: 0,\n  timestamp: new Date().toISOString(),\n  SUPABASE_URL: SUPABASE_URL,\n  SUPABASE_ANON_KEY: SUPABASE_ANON_KEY,\n  BACKEND_URL: BACKEND_URL,\n  sel_price: selPrice,\n  buy_price: buyPrice,\n  volume: indicators.volume\n};"
      },
      "id": "check-conditions-1",
      "name": "Ï°∞Í±¥ Ï≤¥ÌÅ¨ Î∞è Ïã†Ìò∏ ÏÉùÏÑ±",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2050,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$json.SUPABASE_URL}}/rest/v1/kw_stock_master",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"stock_code\": {{JSON.stringify($json.stock_code)}},\n  \"stock_name\": {{JSON.stringify($json.stock_name)}},\n  \"market\": \"KOSPI\"\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$json.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "={{\"Bearer \" + $json.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates"
            }
          ]
        },
        "options": {}
      },
      "id": "save-stock-master",
      "name": "Ï¢ÖÎ™© ÎßàÏä§ÌÑ∞ Ï†ÄÏû•",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        2150,
        500
      ]
    },
    {
      "parameters": {
        "jsCode": "const item = $input.item.json;\nconst stockCode = item.stock_code;\nconst currentPrice = item.current_price;\n\n// SupabaseÏóêÏÑú Ïñ¥Ï†ú Ï¢ÖÍ∞Ä Ï°∞Ìöå\nconst supabaseUrl = item.SUPABASE_URL;\nconst supabaseKey = item.SUPABASE_ANON_KEY;\n\ntry {\n  // kw_price_dailyÏóêÏÑú ÏµúÍ∑º Ï¢ÖÍ∞Ä Ï°∞Ìöå (Ï†ÑÏùº Ï¢ÖÍ∞Ä)\n  const response = await fetch(\n    `${supabaseUrl}/rest/v1/kw_price_daily?stock_code=eq.${stockCode}&select=close&order=trade_date.desc&limit=1`,\n    {\n      headers: {\n        'apikey': supabaseKey,\n        'Authorization': `Bearer ${supabaseKey}`\n      }\n    }\n  );\n  \n  const data = await response.json();\n  const previousClose = data && data.length > 0 ? parseFloat(data[0].close) : currentPrice;\n  \n  // Îì±ÎùΩÍ∞Ä Î∞è Îì±ÎùΩÎ•† Í≥ÑÏÇ∞\n  const changePrice = currentPrice - previousClose;\n  const changeRate = previousClose > 0 ? ((changePrice / previousClose) * 100) : 0;\n  \n  return {\n    ...item,\n    previous_close: previousClose,\n    change_price: changePrice,\n    change_rate: changeRate\n  };\n} catch (error) {\n  console.error('Failed to fetch previous close:', error);\n  // ÏóêÎü¨ Ïãú Í∏∞Î≥∏Í∞í ÏÇ¨Ïö© (Îì±ÎùΩÍ∞Ä/Î•† = 0)\n  return {\n    ...item,\n    previous_close: currentPrice,\n    change_price: 0,\n    change_rate: 0\n  };\n}"
      },
      "id": "calc-price-change",
      "name": "Îì±ÎùΩÍ∞Ä/Î•† Í≥ÑÏÇ∞",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2250,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$json.SUPABASE_URL}}/rest/v1/kw_price_current",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"stock_code\": {{JSON.stringify($json.stock_code)}},\n  \"stock_name\": {{JSON.stringify($json.stock_name || $json.stock_code)}},\n  \"current_price\": {{$json.current_price}},\n  \"change_price\": {{$json.change_price}},\n  \"change_rate\": {{$json.change_rate}},\n  \"volume\": {{$json.volume || 0}},\n  \"high_52w\": {{$json.sel_price || 0}},\n  \"low_52w\": {{$json.buy_price || 0}},\n  \"market_cap\": 0\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$json.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "={{\"Bearer \" + $json.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "resolution=merge-duplicates"
            }
          ]
        },
        "options": {}
      },
      "id": "save-market-data",
      "name": "ÏãúÏû• Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        2450,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.signal_type}}",
              "operation": "notEqual",
              "value2": "NONE"
            }
          ]
        }
      },
      "id": "check-signal-1",
      "name": "Ïã†Ìò∏ ÏûàÏùå?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        2250,
        100
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$json.SUPABASE_URL}}/rest/v1/trading_signals",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"strategy_id\": {{JSON.stringify($json.strategy_id)}},\n  \"stock_code\": {{JSON.stringify($json.stock_code)}},\n  \"stock_name\": {{JSON.stringify($json.stock_name)}},\n  \"signal_type\": {{JSON.stringify($json.signal_type)}},\n  \"signal_strength\": {{$json.signal_strength}},\n  \"current_price\": {{$json.current_price}},\n  \"volume\": {{$json.indicators.volume || 0}},\n  \"conditions_met\": {{JSON.stringify($json.indicators)}}\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$json.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "={{\"Bearer \" + $json.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "id": "save-signal-1",
      "name": "Ïã†Ìò∏ Ï†ÄÏû•",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        2450,
        0
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$('Ï°∞Í±¥ Ï≤¥ÌÅ¨ Î∞è Ïã†Ìò∏ ÏÉùÏÑ±').item.json.signal_type}}",
              "operation": "equal",
              "value2": "BUY"
            }
          ]
        }
      },
      "id": "check-buy-signal",
      "name": "Îß§Ïàò Ïã†Ìò∏Îßå?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        2650,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "const signal = $('Ï°∞Í±¥ Ï≤¥ÌÅ¨ Î∞è Ïã†Ìò∏ ÏÉùÏÑ±').item.json;\n\n// Í≥ÑÏ¢å ÏûîÍ≥† (TODO: DBÏóêÏÑú Ï°∞Ìöå)\nconst availableCash = 10000000;\n\n// Í≥ÑÏ¢åÏùò 10%Î°ú Îß§Ïàò\nconst allocationPercentage = 0.10;\nconst maxBudget = availableCash * allocationPercentage;\n\nconst currentPrice = signal.current_price;\nconst quantity = Math.floor(maxBudget / currentPrice);\n\nif (quantity < 1) {\n  return {\n    json: {\n      skip: true,\n      reason: 'Ï£ºÎ¨∏ Í∞ÄÎä• ÏàòÎüâ Î∂ÄÏ°±',\n      stock_code: signal.stock_code,\n      current_price: currentPrice\n    }\n  };\n}\n\nreturn {\n  json: {\n    skip: false,\n    stock_code: signal.stock_code,\n    stock_name: signal.stock_name,\n    quantity: quantity,\n    price: 0,\n    order_type: 'buy',\n    current_price: currentPrice,\n    order_amount: currentPrice * quantity,\n    account_balance: availableCash,\n    strategy_id: signal.strategy_id,\n    strategy_name: signal.strategy_name,\n    signal_strength: signal.signal_strength,\n    SUPABASE_URL: signal.SUPABASE_URL,\n    SUPABASE_ANON_KEY: signal.SUPABASE_ANON_KEY,\n    BACKEND_URL: signal.BACKEND_URL\n  }\n};"
      },
      "id": "calc-quantity",
      "name": "Ï£ºÎ¨∏ ÏàòÎüâ Í≥ÑÏÇ∞",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2850,
        0
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$json.SUPABASE_URL}}/rest/v1/rpc/check_strategy_capital",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"p_strategy_id\": {{JSON.stringify($json.strategy_id)}},\n  \"p_order_amount\": {{$json.order_amount}},\n  \"p_account_balance\": {{$json.account_balance}}\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$json.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "={{\"Bearer \" + $json.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "Prefer",
              "value": "return=representation"
            }
          ]
        }
      },
      "id": "check-capital",
      "name": "ÏûêÍ∏à Í≤ÄÏ¶ù",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        3050,
        0
      ]
    },
    {
      "parameters": {
        "jsCode": "const validation = $input.item.json;\nconst orderData = $('Ï£ºÎ¨∏ ÏàòÎüâ Í≥ÑÏÇ∞').item.json;\n\nreturn {\n  json: {\n    ...orderData,\n    capital_validation: validation,\n    allowed: validation.allowed,\n    validation_reason: validation.reason\n  }\n};"
      },
      "id": "merge-validation",
      "name": "Í≤ÄÏ¶ù Í≤∞Í≥º Î≥ëÌï©",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3250,
        0
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.allowed}}",
              "operation": "equal",
              "value2": true
            },
            {
              "value1": "={{$json.skip}}",
              "operation": "notEqual",
              "value2": true
            }
          ]
        }
      },
      "id": "check-validation",
      "name": "ÏûêÍ∏à Í≤ÄÏ¶ù ÌÜµÍ≥º?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [
        3450,
        0
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$json.BACKEND_URL}}/api/order/buy",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"stock_code\": {{JSON.stringify($json.stock_code)}},\n  \"quantity\": {{$json.quantity}},\n  \"price\": {{$json.price}},\n  \"order_type\": {{JSON.stringify($json.order_type)}}\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "options": {
          "timeout": 30000
        }
      },
      "id": "execute-order",
      "name": "ÌÇ§ÏõÄ Ï£ºÎ¨∏ Ïã§Ìñâ",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        3650,
        -100
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$('Í≤ÄÏ¶ù Í≤∞Í≥º Î≥ëÌï©').item.json.SUPABASE_URL}}/rest/v1/orders",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"user_id\": \"f912da32-897f-4dbb-9242-3a438e9733a8\",\n  \"stock_code\": {{JSON.stringify($('Í≤ÄÏ¶ù Í≤∞Í≥º Î≥ëÌï©').item.json.stock_code)}},\n  \"order_type\": \"BUY\",\n  \"order_status\": {{JSON.stringify($json.status || 'completed')}},\n  \"order_price\": {{$('Í≤ÄÏ¶ù Í≤∞Í≥º Î≥ëÌï©').item.json.current_price}},\n  \"order_quantity\": {{$('Í≤ÄÏ¶ù Í≤∞Í≥º Î≥ëÌï©').item.json.quantity}},\n  \"executed_price\": {{$json.price || $('Í≤ÄÏ¶ù Í≤∞Í≥º Î≥ëÌï©').item.json.current_price}},\n  \"executed_quantity\": {{$json.status === 'success' ? $('Í≤ÄÏ¶ù Í≤∞Í≥º Î≥ëÌï©').item.json.quantity : 0}},\n  \"kiwoom_order_no\": {{JSON.stringify($json.order_no)}}\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$('Í≤ÄÏ¶ù Í≤∞Í≥º Î≥ëÌï©').item.json.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "={{\"Bearer \" + $('Í≤ÄÏ¶ù Í≤∞Í≥º Î≥ëÌï©').item.json.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "id": "save-order",
      "name": "Ï£ºÎ¨∏ Í∏∞Î°ù Ï†ÄÏû•",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        3850,
        -100
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{$json.SUPABASE_URL}}/rest/v1/trading_logs",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"log_type\": \"capital_validation_failed\",\n  \"strategy_id\": {{JSON.stringify($json.strategy_id)}},\n  \"stock_code\": {{JSON.stringify($json.stock_code)}},\n  \"message\": {{JSON.stringify(\"ÏûêÍ∏à Î∂ÄÏ°±: \" + $json.validation_reason)}},\n  \"metadata\": {{JSON.stringify($json.capital_validation)}},\n  \"created_at\": {{JSON.stringify($now)}}\n}",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "apikey",
              "value": "={{$json.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Authorization",
              "value": "={{\"Bearer \" + $json.SUPABASE_ANON_KEY}}"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        }
      },
      "id": "log-validation-failure",
      "name": "Í≤ÄÏ¶ù Ïã§Ìå® Î°úÍ∑∏",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [
        3650,
        100
      ]
    }
  ],
  "connections": {
    "5Î∂ÑÎßàÎã§ Ïã§Ìñâ": {
      "main": [
        [
          {
            "node": "ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÌôòÍ≤ΩÎ≥ÄÏàò ÏÑ§Ï†ï": {
      "main": [
        [
          {
            "node": "Ïû•ÏãúÍ∞Ñ Ï≤¥ÌÅ¨",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ïû•ÏãúÍ∞Ñ Ï≤¥ÌÅ¨": {
      "main": [
        [
          {
            "node": "ÌÇ§ÏõÄ ÌÜ†ÌÅ∞ Î∞úÍ∏â",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÌÇ§ÏõÄ ÌÜ†ÌÅ∞ Î∞úÍ∏â": {
      "main": [
        [
          {
            "node": "ÏûêÎèôÎß§Îß§ Ï†ÑÎûµ Ï°∞Ìöå",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÏûêÎèôÎß§Îß§ Ï†ÑÎûµ Ï°∞Ìöå": {
      "main": [
        [
          {
            "node": "Ï¢ÖÎ™© ÏΩîÎìú Ï∂îÏ∂ú",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ï¢ÖÎ™© ÏΩîÎìú Ï∂îÏ∂ú": {
      "main": [
        [
          {
            "node": "ÌÇ§ÏõÄ Ìò∏Í∞Ä Ï°∞Ìöå",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÌÇ§ÏõÄ Ìò∏Í∞Ä Ï°∞Ìöå": {
      "main": [
        [
          {
            "node": "Îç∞Ïù¥ÌÑ∞ Î≥ëÌï©",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Îç∞Ïù¥ÌÑ∞ Î≥ëÌï©": {
      "main": [
        [
          {
            "node": "Ï°∞Í±¥ Ï≤¥ÌÅ¨ Î∞è Ïã†Ìò∏ ÏÉùÏÑ±",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ï°∞Í±¥ Ï≤¥ÌÅ¨ Î∞è Ïã†Ìò∏ ÏÉùÏÑ±": {
      "main": [
        [
          {
            "node": "Ïã†Ìò∏ ÏûàÏùå?",
            "type": "main",
            "index": 0
          },
          {
            "node": "Ï¢ÖÎ™© ÎßàÏä§ÌÑ∞ Ï†ÄÏû•",
            "type": "main",
            "index": 0
          },
          {
            "node": "Îì±ÎùΩÍ∞Ä/Î•† Í≥ÑÏÇ∞",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ï¢ÖÎ™© ÎßàÏä§ÌÑ∞ Ï†ÄÏû•": {
      "main": [
        []
      ]
    },
    "Îì±ÎùΩÍ∞Ä/Î•† Í≥ÑÏÇ∞": {
      "main": [
        [
          {
            "node": "ÏãúÏû• Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ïã†Ìò∏ ÏûàÏùå?": {
      "main": [
        [
          {
            "node": "Ïã†Ìò∏ Ï†ÄÏû•",
            "type": "main",
            "index": 0
          },
          {
            "node": "Îß§Ïàò Ïã†Ìò∏Îßå?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Îß§Ïàò Ïã†Ìò∏Îßå?": {
      "main": [
        [
          {
            "node": "Ï£ºÎ¨∏ ÏàòÎüâ Í≥ÑÏÇ∞",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ï£ºÎ¨∏ ÏàòÎüâ Í≥ÑÏÇ∞": {
      "main": [
        [
          {
            "node": "ÏûêÍ∏à Í≤ÄÏ¶ù",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÏûêÍ∏à Í≤ÄÏ¶ù": {
      "main": [
        [
          {
            "node": "Í≤ÄÏ¶ù Í≤∞Í≥º Î≥ëÌï©",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Í≤ÄÏ¶ù Í≤∞Í≥º Î≥ëÌï©": {
      "main": [
        [
          {
            "node": "ÏûêÍ∏à Í≤ÄÏ¶ù ÌÜµÍ≥º?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÏûêÍ∏à Í≤ÄÏ¶ù ÌÜµÍ≥º?": {
      "main": [
        [
          {
            "node": "ÌÇ§ÏõÄ Ï£ºÎ¨∏ Ïã§Ìñâ",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Í≤ÄÏ¶ù Ïã§Ìå® Î°úÍ∑∏",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "ÌÇ§ÏõÄ Ï£ºÎ¨∏ Ïã§Ìñâ": {
      "main": [
        [
          {
            "node": "Ï£ºÎ¨∏ Í∏∞Î°ù Ï†ÄÏû•",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1",
    "saveExecutionProgress": true,
    "executionTimeout": 1800
  }
}