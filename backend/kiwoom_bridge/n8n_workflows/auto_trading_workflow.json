{
  "name": "키움 자동매매 워크플로우",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "field": "minutes",
              "minutesInterval": 1
            }
          ]
        }
      },
      "id": "schedule-trigger",
      "name": "1분마다 실행",
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.1,
      "position": [250, 300]
    },
    {
      "parameters": {
        "url": "http://kiwoom-bridge:8001/api/market/current-price",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "stock_code",
              "value": "005930"
            }
          ]
        },
        "options": {}
      },
      "id": "get-price",
      "name": "현재가 조회",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [450, 300]
    },
    {
      "parameters": {
        "mode": "runOnceForEachItem",
        "jsCode": "// 매매 신호 생성 로직\nconst currentPrice = $input.item.json.data.output.stck_prpr;\nconst previousClose = $input.item.json.data.output.stck_sdpr;\n\n// 간단한 예시: 전일 종가 대비 -2% 이하면 매수\nconst changeRate = ((currentPrice - previousClose) / previousClose) * 100;\n\nif (changeRate <= -2) {\n  return {\n    signal: 'buy',\n    stock_code: '005930',\n    price: currentPrice,\n    reason: `전일 대비 ${changeRate.toFixed(2)}% 하락`\n  };\n} else if (changeRate >= 3) {\n  return {\n    signal: 'sell',\n    stock_code: '005930',\n    price: currentPrice,\n    reason: `전일 대비 ${changeRate.toFixed(2)}% 상승`\n  };\n}\n\nreturn {\n  signal: 'hold',\n  stock_code: '005930',\n  price: currentPrice,\n  reason: '신호 없음'\n};"
      },
      "id": "trading-signal",
      "name": "매매 신호 생성",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [650, 300]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{ $json.signal }}",
              "operation": "notEqual",
              "value2": "hold"
            }
          ]
        }
      },
      "id": "check-signal",
      "name": "신호 확인",
      "type": "n8n-nodes-base.if",
      "typeVersion": 1,
      "position": [850, 300]
    },
    {
      "parameters": {
        "url": "http://kiwoom-bridge:8001/api/trading/order",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "user_id",
              "value": "={{ $env.USER_ID }}"
            },
            {
              "name": "stock_code",
              "value": "={{ $json.stock_code }}"
            },
            {
              "name": "order_type",
              "value": "={{ $json.signal }}"
            },
            {
              "name": "quantity",
              "value": "1"
            },
            {
              "name": "price",
              "value": "0"
            },
            {
              "name": "order_method",
              "value": "01"
            }
          ]
        },
        "options": {}
      },
      "id": "place-order",
      "name": "주문 실행",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1050, 250]
    },
    {
      "parameters": {
        "url": "={{ $env.DISCORD_WEBHOOK_URL }}",
        "method": "POST",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {
              "name": "content",
              "value": "🤖 **자동매매 알림**\n\n📊 종목: {{ $json.stock_code }}\n💹 신호: {{ $json.signal === 'buy' ? '매수' : '매도' }}\n💰 가격: {{ $json.price }}원\n📝 사유: {{ $json.reason }}\n⏰ 시간: {{ $now.format('YYYY-MM-DD HH:mm:ss') }}"
            }
          ]
        },
        "options": {}
      },
      "id": "send-notification",
      "name": "디스코드 알림",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.1,
      "position": [1250, 250]
    }
  ],
  "connections": {
    "schedule-trigger": {
      "main": [
        [
          {
            "node": "get-price",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "get-price": {
      "main": [
        [
          {
            "node": "trading-signal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "trading-signal": {
      "main": [
        [
          {
            "node": "check-signal",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "check-signal": {
      "main": [
        [
          {
            "node": "place-order",
            "type": "main",
            "index": 0
          }
        ],
        []
      ]
    },
    "place-order": {
      "main": [
        [
          {
            "node": "send-notification",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "meta": {
    "templateId": "kiwoom-auto-trading"
  },
  "pinData": {}
}