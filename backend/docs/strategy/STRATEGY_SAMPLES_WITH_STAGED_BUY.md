# 백테스트 전략 샘플 (분할 매수/매도 포함)

UI에서 직접 설정할 수 있는 전략 샘플들입니다. **분할 매수 및 분할 매도** 기능이 포함되어 있습니다.

---

## 🎯 분할 매수/매도 전략 개념

### 분할 매수 (Staged Buy)
여러 단계에 걸쳐 나누어 매수하는 전략입니다.

**예시**: 초기 자본 1,000만원
- **1단계** (RSI < 40): 50% 투자 → 500만원 매수
- **2단계** (RSI < 35): 남은 자금의 30% → 150만원 추가 매수
- **3단계** (RSI < 30): 남은 자금의 20% → 70만원 추가 매수
- **총 투자**: 720만원 (초기 자본의 72%)

### 분할 매도 (Staged Sell)
목표 수익률 도달 시 단계별로 나누어 매도하는 전략입니다.

**예시**: 보유 수량 1,000주
- **1단계** (3% 도달): 50% 매도 → 500주 매도
- **2단계** (5% 도달): 30% 매도 → 150주 매도 (남은 500주의 30%)
- **3단계** (10% 도달): 20% 매도 → 70주 매도 (남은 350주의 20%)

---

## 샘플 1: 기본 분할 매수 전략

### 📊 전략 개요
- **성격**: 하락 시 평단가 낮추기
- **매수**: RSI 단계별 하락 시 분할 매수
- **매도**: 단계별 익절
- **효과**: 평단가 최적화, 리스크 분산

### ✅ UI 설정 방법

**1. 전략 모드 선택**
```
매수/매도 조건 섹션에서:
☑ "3단계 전략" 활성화
```

**2. 매수 조건 - 3단계 설정**
```
▼ 1단계 활성화, 투자 비율: 50%
  조건 1: RSI < 40
  조건 결합: AND (모든 조건 만족 필요)

▼ 2단계 활성화, 투자 비율: 30%
  조건 1: RSI < 35
  조건 결합: AND

▼ 3단계 비활성 또는:
  투자 비율: 20%
  조건 1: RSI < 30
```

**투자 비율 해석:**
- 1단계 50%: 전체 자본의 50%
- 2단계 30%: 남은 자본(50%)의 30% = 전체의 15%
- 3단계 20%: 남은 자본(35%)의 20% = 전체의 7%
- **총 투자**: 72%

**3. 매도 조건 - 단계별 목표**
```
목표 수익률 설정:
☑ 단계별 목표 활성화

1단계: 목표 3%, 매도 50%, ☑ 손절→본전
2단계: 목표 5%, 매도 30%, ☑ 손절→1단계가
3단계: 목표 10%, 매도 20%, ☑ 손절→2단계가
```

**4. 손절 설정**
```
☑ 손절 라인 사용
손절 라인: 3%
☑ 동적 손절
```

### 📄 JSON 설정 (개발자용)

```json
{
  "name": "기본 분할 매수 전략",
  "config": {
    "indicators": [
      {"name": "rsi", "params": {"period": 14}}
    ],
    "useStageBasedStrategy": true,
    "buyStageStrategy": {
      "stages": [
        {
          "stage": 1,
          "enabled": true,
          "positionPercent": 50,
          "passAllRequired": true,
          "conditions": [
            {"left": "rsi", "operator": "<", "right": 40}
          ]
        },
        {
          "stage": 2,
          "enabled": true,
          "positionPercent": 30,
          "passAllRequired": true,
          "conditions": [
            {"left": "rsi", "operator": "<", "right": 35}
          ]
        },
        {
          "stage": 3,
          "enabled": true,
          "positionPercent": 20,
          "passAllRequired": true,
          "conditions": [
            {"left": "rsi", "operator": "<", "right": 30}
          ]
        }
      ]
    },
    "sellStageStrategy": {
      "stages": [
        {
          "stage": 1,
          "enabled": true,
          "positionPercent": 100,
          "passAllRequired": false,
          "conditions": [
            {"left": "rsi", "operator": ">", "right": 70}
          ]
        }
      ]
    },
    "targetProfit": {
      "mode": "staged",
      "staged": {
        "enabled": true,
        "stages": [
          {"stage": 1, "targetProfit": 3, "exitRatio": 50, "dynamicStopLoss": true},
          {"stage": 2, "targetProfit": 5, "exitRatio": 30, "dynamicStopLoss": true},
          {"stage": 3, "targetProfit": 10, "exitRatio": 20, "dynamicStopLoss": true}
        ]
      }
    },
    "stopLoss": {
      "enabled": true,
      "value": 3
    }
  }
}
```

### 예상 결과
- 하락장에서 낮은 가격에 추가 매수 → 평단가 개선
- 상승장에서 단계별 익절 → 수익 보호
- 동적 손절로 수익 실현 후 본전 이상 보장

---

## 샘플 2: 볼린저 밴드 분할 매수

### 📊 전략 개요
- **성격**: 변동성 돌파 전략
- **매수**: 볼린저 하단 돌파 시 분할 매수
- **매도**: 볼린저 상단 도달 또는 목표 수익
- **효과**: 과매도 구간 포착, 평균 회귀 수익

### UI 설정 방법

**1. 지표 추가**
```
- RSI (기간: 14)
- Bollinger Bands (기간: 20, 표준편차: 2)
```

**2. 매수 조건 - 3단계**
```
▼ 1단계 (40% 투자)
  조건 1: close < bollinger_lower
  조건 2: RSI < 45
  결합: AND

▼ 2단계 (40% 추가)
  조건 1: close < bollinger_lower
  조건 2: RSI < 35
  결합: AND

▼ 3단계 비활성
```

**3. 매도 조건**
```
시그널 매도:
  조건 1: close > bollinger_upper OR RSI > 70
```

**4. 목표 수익률**
```
단계별 목표:
- 1단계: 2%, 50% 매도
- 2단계: 4%, 30% 매도
- 3단계: 7%, 20% 매도
```

### 예상 결과
- 과매도 구간에서 분할 진입
- 볼린저 밴드 평균 회귀 효과 극대화
- 안정적인 수익 실현

---

## 샘플 3: MACD + 골든크로스 분할 진입

### 📊 전략 개요
- **성격**: 추세 추종 + 분할 진입
- **매수**: 골든크로스 시작 시 분할 매수
- **매도**: 추세 전환 또는 목표 수익
- **효과**: 추세 확인 후 점진적 진입

### UI 설정 방법

**1. 지표 추가**
```
- SMA (기간: 5)
- SMA (기간: 20)
- MACD (12, 26, 9)
```

**2. 매수 조건 - 3단계**
```
▼ 1단계 (30% 투자)
  조건 1: sma_5 > sma_20
  조건 2: macd > signal
  결합: AND

▼ 2단계 (50% 추가) - 추세 강화 시
  조건 1: sma_5 cross_above sma_20
  조건 2: macd > signal
  결합: AND

▼ 3단계 비활성
```

**3. 매도 조건**
```
시그널 매도:
  조건 1: sma_5 cross_below sma_20
  조건 2: macd < signal
  결합: OR
```

**4. 목표 수익률**
```
단순 목표: 8%
손절: -4%
```

### 예상 결과
- 추세 시작 시 안전하게 진입
- 추세 강화 시 포지션 확대
- 큰 상승 포착 가능

---

## 샘플 4: 단순 테스트용 (기존 방식)

### 📊 전략 개요
- **성격**: 기존 단일 매수 방식
- **매수**: 한 번에 매수
- **매도**: 단일 목표 익절
- **용도**: 기본 동작 확인

### UI 설정 방법

**1. 전략 모드**
```
☐ 3단계 전략 비활성화 (기존 방식 사용)
```

**2. 매수 조건**
```
조건 1: RSI < 30
```

**3. 매도 조건**
```
조건 1: RSI > 70
```

**4. 목표 수익률**
```
단순 목표: 5%
손절: -3%
```

### 예상 결과
- 명확한 진입/청산
- 검증 용이

---

## 📊 투자 비율 계산 예시

### 초기 자본: 10,000,000원

**시나리오 1: 1단계만 실행**
```
1단계 50%: 5,000,000원 투자
남은 자금: 5,000,000원
총 투자: 50%
```

**시나리오 2: 1단계 + 2단계 실행**
```
1단계 50%: 5,000,000원 투자
남은 자금: 5,000,000원

2단계 30% (남은 자금의): 1,500,000원 투자
남은 자금: 3,500,000원
총 투자: 65% (5,000,000 + 1,500,000)
```

**시나리오 3: 전 단계 실행**
```
1단계 50%: 5,000,000원
2단계 30%: 1,500,000원
3단계 20%: 700,000원 (3,500,000의 20%)
총 투자: 72% (7,200,000원)
```

---

## 🎯 추천 테스트 순서

1. **샘플 4** (단순 테스트) → 기본 기능 확인
2. **샘플 1** (기본 분할 매수) → 분할 매수 동작 확인
3. **샘플 2** (볼린저 분할) → 복합 조건 + 분할 매수
4. **샘플 3** (MACD 분할) → 추세 전략 + 분할 매수

---

## 💡 백테스트 실행 팁

### 추천 설정
```
종목: 005930 (삼성전자)
기간: 최근 6개월
초기 자금: 10,000,000원
수수료: 0.15%
슬리피지: 0.1%
```

### 확인 포인트

**분할 매수 전략:**
1. ✅ 여러 단계의 매수가 순차적으로 실행되는지
2. ✅ 각 단계별 투자 비율이 정확한지
3. ✅ 평단가가 동적으로 계산되는지
4. ✅ 매수 이유에 `stage_1_buy`, `stage_2_buy` 표시 확인

**분할 매도 전략:**
1. ✅ 목표 수익률 도달 시 부분 매도 실행
2. ✅ 매도 비율 (50%, 30%, 20%) 정확한지
3. ✅ 동적 손절선이 단계별로 상향 조정되는지
4. ✅ 매도 이유에 `stage_1_target`, `stage_2_target` 표시

### 결과 분석

**거래 내역 확인:**
```
매수 예시:
- 2025-08-15: stage_1_buy (RSI < 40), 5,000,000원
- 2025-08-20: stage_2_buy (RSI < 35), 1,500,000원
→ 총 6,500,000원 투자, 평단가 계산

매도 예시:
- 2025-09-01: stage_1_target (3.2% >= 3%), 50% 매도
- 2025-09-05: stage_2_target (5.3% >= 5%), 30% 매도
→ 수익 보호 + 추가 상승 여력
```

---

## 🔍 문제 발생 시 체크리스트

### 분할 매수가 안 되는 경우
- [ ] "3단계 전략" 활성화했는지
- [ ] `useStageBasedStrategy: true` 설정 확인 (JSON 설정 시)
- [ ] 각 단계의 조건이 순차적으로 엄격한지 (예: 40 → 35 → 30)
- [ ] 단계별 `enabled: true` 확인

### 투자 비율이 이상한 경우
- [ ] `positionPercent` 값이 올바른지 (0-100 범위)
- [ ] 남은 자금 계산 로직 이해: 2단계는 남은 자금의 N%

### 단계별 매도가 안 되는 경우
- [ ] `targetProfit.mode: 'staged'` 설정 확인
- [ ] `exitRatio` 값 확인 (0-100)
- [ ] `dynamicStopLoss` 체크박스 확인

---

## 📝 전체 설정 예시 (샘플 1 완전판)

```json
{
  "name": "기본 분할 매수 전략 (완전판)",
  "config": {
    "indicators": [
      {"name": "rsi", "params": {"period": 14}}
    ],
    "useStageBasedStrategy": true,
    "buyStageStrategy": {
      "stages": [
        {
          "stage": 1,
          "enabled": true,
          "positionPercent": 50,
          "passAllRequired": true,
          "conditions": [
            {"left": "rsi", "operator": "<", "right": 40}
          ]
        },
        {
          "stage": 2,
          "enabled": true,
          "positionPercent": 30,
          "passAllRequired": true,
          "conditions": [
            {"left": "rsi", "operator": "<", "right": 35}
          ]
        }
      ]
    },
    "sellStageStrategy": {
      "stages": [
        {
          "stage": 1,
          "enabled": true,
          "positionPercent": 100,
          "passAllRequired": false,
          "conditions": [
            {"left": "rsi", "operator": ">", "right": 70}
          ]
        }
      ]
    },
    "targetProfit": {
      "mode": "staged",
      "staged": {
        "enabled": true,
        "stages": [
          {"stage": 1, "targetProfit": 3, "exitRatio": 50, "dynamicStopLoss": true},
          {"stage": 2, "targetProfit": 5, "exitRatio": 30, "dynamicStopLoss": true},
          {"stage": 3, "targetProfit": 10, "exitRatio": 20, "dynamicStopLoss": true}
        ],
        "combineWith": "OR"
      }
    },
    "stopLoss": {
      "enabled": true,
      "value": 3
    }
  }
}
```

---

## ✅ 구현 완료 기능

- ✅ 단계별 분할 매수 (최대 3단계)
- ✅ 남은 자금 기반 투자 비율 계산
- ✅ 평단가 동적 계산
- ✅ 단계별 분할 매도 (목표 수익률)
- ✅ 동적 손절선 (단계별 상향 조정)
- ✅ 매수/매도 이유 추적
- ✅ 중복 매수/매도 방지

UI에서 이 설정들을 직접 입력하면 분할 매수/매도가 정확히 실행됩니다! 🎉
