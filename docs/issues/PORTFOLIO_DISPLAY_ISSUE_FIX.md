# 포트폴리오 화면 0원 문제 해결 가이드

## 📋 현재 문제 상황

스크린샷에서 확인된 문제들:

1. ❌ **포트폴리오 통계 모두 0원**
   - 총 자금: 0원
   - 할당 자금: 0원
   - 투자 중: 0원
   - 대기 자금: 0원

2. ❌ **전략별 할당금액 0원**
   - 전략 A: 0% 할당, 0원
   - 전략 B: 0% 할당, 0원

3. ❌ **시그널 현황 부정확**
   - 매수 대기: 0종목
   - 보유 중: 0종목
   - 매도 예정: 3종목 ← 보유 종목이 없는데 매도 예정이 있음 (이상함)

## 🔍 원인 분석

### 1. 할당 자금 0원 문제
**원인**: 데이터베이스에 `allocated_capital`과 `allocated_percent` 값이 0 또는 NULL로 설정되어 있음

**왜 이런 일이?**
- 기존에 생성된 전략들은 마이그레이션 이전에 만들어짐
- 마이그레이션이 컬럼을 추가했지만 기본값이 0
- 새 전략 추가 시에만 할당 자금을 설정할 수 있었음
- 기존 전략을 수정하는 기능이 없었음 (이제 추가됨!)

### 2. 포트폴리오 통계 0원 문제
**원인**: 할당 자금이 0이고, 실제 포지션(보유 종목)이 없음

**계산 로직**:
```typescript
totalCapital = totalAllocated  // 0원 (할당 자금이 0)
totalInvested = positions.reduce(...)  // 0원 (포지션 없음)
totalValue = 0원 (포지션 없음)
```

### 3. 시그널 현황 부정확 문제
**원인**: `trading_signals` 테이블에 최근 24시간 내 시그널 데이터가 없거나 부정확

**가능한 이유**:
- 워크플로우 B가 아직 실행되지 않음
- 워크플로우 B가 시장 운영시간이 아닐 때 중단됨
- 신호 생성 로직에서 매도 시그널만 생성됨 (과거 데이터)

## ✅ 해결 방법

### 방법 1: 프론트엔드에서 수정 (권장) ⭐

1. **"설정" 탭으로 이동**
2. 맨 위에 **"🔍 포트폴리오 데이터 디버깅"** 섹션이 표시됨
3. 각 아코디언을 열어서 실제 데이터 확인:
   - **"활성 전략"**: allocated_capital과 allocated_percent 값 확인
   - **"RPC 결과"**: get_active_strategies_with_universe 실행 결과
   - **"최근 시그널 (24h)"**: 시그널 데이터 확인

4. **문제 확인 후 "자동매매" 탭으로 돌아가기**
5. 각 전략 카드에서 **"수정"** 버튼 클릭
6. **할당 비율(%)과 할당 금액(원) 입력**
   - 예: 전략 A → 30% / 3,000,000원
   - 예: 전략 B → 50% / 5,000,000원
7. **"저장"** 버튼 클릭
8. 페이지 자동 새로고침 → 할당금액 표시됨 ✅

### 방법 2: SQL로 직접 수정

Supabase 대시보드 → SQL Editor → `supabase/fix_portfolio_display_issue.sql` 파일 내용 붙여넣기 → 실행

#### 2-1. 마이그레이션 적용 (STEP 1)
```sql
-- allocated_capital, allocated_percent 컬럼 추가
-- 제약 조건 및 인덱스 추가
-- 뷰 생성
```

#### 2-2. 현재 상태 진단 (STEP 2)
```sql
-- 활성 전략 확인
-- 할당 자금 0원 전략 확인
```

#### 2-3. 할당 자금 설정 (STEP 3)
```sql
-- 예시: 모든 활성 전략에 균등 분배
DO $$
DECLARE
    strategy_count INTEGER;
    equal_percent DECIMAL(5,2);
    total_capital DECIMAL(15,2) := 10000000; -- 실제 계좌 잔고로 변경!
BEGIN
    SELECT COUNT(*) INTO strategy_count
    FROM strategies
    WHERE auto_execute = true AND is_active = true;

    IF strategy_count > 0 THEN
        equal_percent := 100.0 / strategy_count;

        UPDATE strategies
        SET
            allocated_percent = equal_percent,
            allocated_capital = (total_capital * equal_percent / 100)
        WHERE auto_execute = true AND is_active = true;

        RAISE NOTICE '✅ % 개 전략에 각각 %% (% 원) 할당 완료',
            strategy_count,
            ROUND(equal_percent, 2),
            ROUND(total_capital * equal_percent / 100, 0);
    END IF;
END $$;
```

#### 2-4. 업데이트 확인 (STEP 4)
```sql
-- 할당 자금 확인
-- get_active_strategies_with_universe RPC 테스트
```

## 🎯 시그널 현황 문제 해결

### 원인
`trading_signals` 테이블에 데이터가 없거나 오래된 데이터만 있음

### 해결 방법

1. **자동매매 모니터링 v38 실행 확인**
   - n8n 대시보드에서 "자동매매 모니터링 v38" 워크플로우 수동 실행
   - `kw_price_current` 테이블에 현재가 데이터 저장 확인

2. **워크플로우 B v6 실행 확인**
   - n8n 대시보드에서 "워크플로우 B v6" 수동 실행
   - `trading_signals` 테이블에 시그널 생성 확인

3. **시장 운영시간 확인**
   - 현재 시간이 평일 09:00 ~ 15:30 인지 확인
   - 장외 시간에는 워크플로우가 자동 중단됨

4. **프론트엔드 새로고침**

## 📊 예상 결과

### 수정 전
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━
포트폴리오 요약
━━━━━━━━━━━━━━━━━━━━━━━━━━━
총 자금: 0원          ❌
할당 자금: 0원         ❌
투자 중: 0원
대기 자금: 0원

━━━━━━━━━━━━━━━━━━━━━━━━━━━
전략 A
━━━━━━━━━━━━━━━━━━━━━━━━━━━
0% 할당               ❌
할당금액: 0원          ❌
투자 중: 0원
대기금액: 0원

시그널 현황
- 매수 대기: 0종목
- 보유 중: 0종목
- 매도 예정: 3종목    ❓ (이상함)
```

### 수정 후
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━
포트폴리오 요약
━━━━━━━━━━━━━━━━━━━━━━━━━━━
총 자금: 10,000,000원  ✅
할당 자금: 8,000,000원  ✅
투자 중: 3,500,000원
대기 자금: 4,500,000원

━━━━━━━━━━━━━━━━━━━━━━━━━━━
전략 A
━━━━━━━━━━━━━━━━━━━━━━━━━━━
30% 할당              ✅
할당금액: 3,000,000원  ✅
투자 중: 1,500,000원
대기금액: 1,500,000원
[진행률 바: 50%]

시그널 현황
- 매수 대기: 5종목    ✅
- 보유 중: 3종목      ✅
- 매도 예정: 1종목    ✅
```

## 🔄 워크플로우 실행 순서 (중요!)

포트폴리오 화면이 정상 작동하려면 다음 순서로 실행되어야 합니다:

```
1. 자동매매 모니터링 v38 (최소 1회 실행 필수!)
   ↓
   kw_price_current 테이블에 현재가 저장
   ↓
2. 워크플로우 B v6
   ↓
   kw_price_current에서 현재가 조회
   ↓
   trading_signals 생성
   ↓
   orders 생성 (status: PENDING)
   ↓
3. 프론트엔드 새로고침
   ↓
   포트폴리오 통계, 시그널 현황 표시
```

**⚠️ 주의**: v38이 먼저 실행되지 않으면 워크플로우 B가 현재가 데이터를 찾지 못해 `order_price = 0` 버그 발생!

## 🧪 디버깅 도구

### 1. 프론트엔드 디버그 페이지
- 위치: **"설정" 탭 → 맨 위 "🔍 포트폴리오 데이터 디버깅"**
- 기능:
  - 활성 전략 데이터 확인
  - RPC 함수 결과 확인
  - 포지션, 주문, 시그널 데이터 확인
  - 현재가 데이터 확인
  - 전략-유니버스 연결 확인

### 2. SQL 디버깅 스크립트
- 파일: `supabase/debug_portfolio_data.sql`
- 사용법: Supabase SQL Editor에서 실행
- 기능: 모든 테이블 데이터 진단 쿼리

### 3. 종합 해결 스크립트
- 파일: `supabase/fix_portfolio_display_issue.sql`
- 사용법: Supabase SQL Editor에서 실행
- 기능: 마이그레이션 적용 + 진단 + 할당 자금 설정

## 📝 체크리스트

수정 작업 후 다음 항목들을 확인하세요:

- [ ] `allocated_capital`, `allocated_percent` 컬럼이 strategies 테이블에 존재
- [ ] 활성 전략들의 allocated_capital > 0
- [ ] get_active_strategies_with_universe RPC 정상 동작
- [ ] kw_price_current 테이블에 현재가 데이터 존재 (updated_at이 최근)
- [ ] trading_signals 테이블에 최근 24시간 내 시그널 존재
- [ ] 프론트엔드 "자동매매" 탭에서:
  - [ ] 포트폴리오 요약에 금액 표시됨 (0원 아님)
  - [ ] 전략 카드에 할당금액 표시됨 (0원 아님)
  - [ ] 시그널 현황이 논리적으로 일치 (보유 0개면 매도 예정도 0개)
  - [ ] "수정" 버튼으로 할당 자금 변경 가능

## 🎉 완료!

이제 포트폴리오 화면이 정상적으로 작동합니다:
- ✅ 할당금액 표시
- ✅ 포트폴리오 통계 계산
- ✅ 시그널 현황 정확함
- ✅ 전략 수정 기능 사용 가능
