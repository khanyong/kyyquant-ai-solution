# KYY Quant AI Solution 회원가입 절차 안내

## 📝 회원가입 프로세스

### 1. 사용자 입장에서의 회원가입 절차

#### 1.1 회원가입 페이지 접속
1. 메인 페이지 상단의 "로그인" 버튼 클릭
2. 로그인 다이얼로그에서 "회원가입" 탭 선택

#### 1.2 회원가입 정보 입력
- **이메일**: 유효한 이메일 주소 (인증 메일 수신용)
- **비밀번호**: 최소 6자 이상
- **이름**: 사용자 실명 또는 닉네임
- **키움계좌 ID**: 키움증권 계좌 ID (선택사항)

#### 1.3 이메일 인증
1. 회원가입 후 입력한 이메일로 인증 메일 발송
2. 이메일 내 인증 링크 클릭하여 이메일 인증 완료
3. 인증 완료 후 로그인 가능

#### 1.4 승인 대기
- 관리자 승인이 필요한 경우, 승인 대기 상태
- 승인 완료 후 모든 기능 사용 가능

---

## 🔧 기술적 구현 상세

### 2. 데이터베이스 구조

#### 2.1 관련 테이블
- **auth.users**: Supabase Auth에서 관리하는 사용자 인증 정보
- **public.profiles**: 사용자 프로필 및 추가 정보
- **public.user_roles**: 사용자 역할 관리
- **public.roles**: 시스템 역할 정의

#### 2.2 회원가입 시 데이터 플로우
```
1. 사용자 정보 입력
   ↓
2. Supabase Auth 회원가입 API 호출
   ↓
3. auth.users 테이블에 사용자 생성
   ↓
4. 트리거 함수 자동 실행 (handle_new_user)
   ↓
5. profiles 테이블에 프로필 자동 생성
   ↓
6. 기본 역할(trial) 자동 할당
   ↓
7. 이메일 인증 메일 발송
```

### 3. 백엔드 구현

#### 3.1 인증 서비스 (auth.ts)
```typescript
// 회원가입 함수
authService.signUpWithEmail(
  email: string,
  password: string,
  name?: string,
  kiwoomId?: string
)
```

**주요 기능:**
- Supabase Auth를 통한 사용자 생성
- 메타데이터(이름, 키움ID) 저장
- 프로필 생성 확인 및 수동 생성 백업
- 에러 처리 및 로깅

#### 3.2 데이터베이스 트리거
```sql
-- auth.users 테이블에 새 사용자 생성 시 자동 실행
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW
  EXECUTE FUNCTION public.handle_new_user();
```

**트리거 함수 역할:**
- profiles 테이블에 사용자 프로필 자동 생성
- 기본 역할(trial) 할당
- 이메일 인증 상태 설정

### 4. 프론트엔드 구현

#### 4.1 회원가입 컴포넌트 (LoginDialog.tsx)
```typescript
const handleEmailSignUp = async () => {
  // 1. 입력값 검증
  // 2. authService.signUpWithEmail 호출
  // 3. 성공/실패 처리
  // 4. 사용자 피드백 표시
}
```

**UI 구성:**
- Material-UI 다이얼로그
- 폼 검증 및 에러 표시
- 로딩 상태 관리
- 성공 메시지 표시

### 5. 보안 설정

#### 5.1 Row Level Security (RLS)
- profiles 테이블: 사용자는 자신의 프로필만 수정 가능
- user_roles 테이블: 회원가입 시 역할 할당 허용
- 관리자 권한으로만 다른 사용자 정보 접근 가능

#### 5.2 이메일 인증
- 이메일 인증 전까지 제한된 기능만 사용 가능
- 인증 리다이렉트 URL: `https://kyyquant-ai-solution.vercel.app/auth/callback`

### 6. 역할 시스템

#### 6.1 기본 역할
- **trial**: 신규 가입자 기본 역할 (체험 회원)
- **standard**: 일반 회원
- **premium**: 프리미엄 회원
- **admin**: 관리자

#### 6.2 권한 관리
각 역할별 권한이 JSON 형태로 저장되며, 기능 접근 제한에 사용됨

---

## 🚨 문제 해결 가이드

### 7. 일반적인 문제와 해결 방법

#### 7.1 프로필이 생성되지 않는 문제
**원인**: RLS 정책 또는 트리거 함수 권한 문제
**해결**: 
```sql
-- fix-profile-creation-simple.sql 실행
-- SECURITY DEFINER 권한으로 트리거 함수 재생성
```

#### 7.2 이메일 인증 메일이 오지 않는 경우
**확인 사항:**
- 스팸 메일함 확인
- Supabase 대시보드에서 이메일 설정 확인
- 이메일 템플릿 설정 확인

#### 7.3 회원가입 후 로그인이 안 되는 경우
**확인 사항:**
- 이메일 인증 완료 여부
- profiles 테이블에 데이터 생성 여부
- 관리자 승인 상태 확인

### 8. 관리자 작업

#### 8.1 신규 가입자 승인
```sql
UPDATE profiles 
SET approval_status = 'approved' 
WHERE id = 'user_id';
```

#### 8.2 사용자 역할 변경
```sql
SELECT assign_role_to_user(
  'user_id', 
  'premium', 
  'admin_id'
);
```

---

## 📞 지원 연락처

기술 지원이 필요한 경우:
- GitHub Issues: [프로젝트 저장소](https://github.com/khanyong/kyyquant-ai-solution)
- 관리자 문의: 시스템 관리자에게 연락

---

*최종 업데이트: 2024년 8월*