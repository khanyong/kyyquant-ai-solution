# 백테스트 리스크 지표 계산 로직 설명

## 개요
백테스트 시스템에서 계산하는 세 가지 주요 리스크 조정 성과 지표(샤프 비율, 소르티노 비율, 트레이너 비율)에 대한 상세 설명입니다.

---

## 1. 샤프 비율 (Sharpe Ratio)

### 정의
**전체 변동성 대비 초과 수익률**을 측정하는 지표입니다.

### 계산식
```
샤프 비율 = (평균 수익률 - 무위험 이자율) / 표준편차 × √252
```

### 현재 구현
```python
# 무위험 이자율: 연 3% → 일별 0.03/252
risk_free_rate_daily = 0.03 / 252
excess_return = avg_return - risk_free_rate_daily

# 샤프 비율 계산 (일별 → 연율화)
if std_return > 0:
    sharpe_ratio = (excess_return / std_return) * np.sqrt(252)
```

### 해석
- **1.0 이상**: 우수
- **2.0 이상**: 매우 우수
- **3.0 이상**: 탁월
- **음수**: 무위험 자산보다 낮은 성과

### 예시
```
초기 자본: 10,000,000원
최종 자본: 12,000,000원 (수익률 +20%)
변동성(일별 표준편차): 1.5%
무위험 이자율: 3% (연)

평균 일별 수익률 = 20% / 252일 = 0.0794%
초과 수익률 = 0.0794% - 0.0119% = 0.0675%
연율화 샤프 비율 = (0.000675 / 0.015) × √252 = 0.714

→ 샤프 비율 0.71은 적정 수준이지만 우수하진 않음
```

---

## 2. 소르티노 비율 (Sortino Ratio)

### 정의
**하방 변동성 대비 초과 수익률**을 측정하는 지표입니다. 샤프 비율과 달리 **손실 방향 변동성만** 고려합니다.

### 계산식
```
소르티노 비율 = (평균 수익률 - 무위험 이자율) / 하방편차 × √252
하방편차 = √(평균[(min(수익률 - 무위험이자율, 0))²])
```

### 현재 구현 (✅ 수정됨)
```python
# 하방 편차: 목표수익률(무위험이자율) 미달 부분만의 표준편차
downside_deviations = [min(r - risk_free_rate_daily, 0) for r in daily_returns]
downside_variance = np.mean([d**2 for d in downside_deviations])

if downside_variance > 0:
    downside_std = np.sqrt(downside_variance)
    sortino_ratio = (excess_return / downside_std) * np.sqrt(252)
else:
    # 하방 편차가 0이면 손실이 전혀 없음
    sortino_ratio = sharpe_ratio * 2
```

### ⚠️ 왜 소르티노 비율이 1보다 작을 수 있는가?

#### 일반적인 오해
많은 사람들이 "소르티노 비율 ≥ 샤프 비율"이라고 생각하지만, **이는 항상 참이 아닙니다**.

#### 소르티노 비율이 낮아지는 경우

**1. 손실 집중도가 높은 경우**
```
예시 1: 일별 수익률 분포
날짜    수익률    하방편차 기여
Day 1   +2.0%    0 (양수, 미포함)
Day 2   +1.5%    0
Day 3   -3.0%    (-3.0 - 0.0119)² = 9.28%²
Day 4   +1.0%    0
Day 5   -2.5%    (-2.5 - 0.0119)² = 6.31%²

전체 변동성(표준편차) = 2.1%
하방 변동성(하방편차) = √[(9.28 + 6.31)/5] = 1.76%

→ 하방편차가 전체 변동성에 근접하면 소르티노 ≈ 샤프
```

**2. 소폭 손실이 빈번한 경우**
```
예시 2: 작은 손실이 많은 전략
날짜    수익률    하방편차 기여
Day 1   +5.0%    0
Day 2   -0.5%    0.26%²
Day 3   -0.3%    0.10%²
Day 4   -0.4%    0.17%²
Day 5   +3.0%    0
Day 6   -0.6%    0.37%²
Day 7   -0.2%    0.05%²

평균 수익률 = +1.0%
전체 표준편차 = 2.0%
하방편차 = √(0.95/7) = 0.37%

샤프 비율 = (0.01 - 0.0001) / 0.02 × √252 = 7.86
소르티노 비율 = (0.01 - 0.0001) / 0.0037 × √252 = 42.4

→ 이 경우는 소르티노 >> 샤프 (손실이 작고 드물 때)
```

**3. 대부분의 실제 전략**
```
예시 3: 전형적인 변동성 전략
- 평균 수익률: +0.05% (일별)
- 전체 표준편차: 1.8%
- 하방편차: 1.3% (손실일이 많음)

샤프 비율 = 0.0005 / 0.018 × √252 = 0.44
소르티노 비율 = 0.0005 / 0.013 × √252 = 0.61

→ 소르티노가 더 높지만, 여전히 1 미만
```

#### 소르티노 비율 < 1의 의미

| 소르티노 비율 | 의미 |
|--------------|------|
| < 0 | 무위험 자산보다 낮은 수익 |
| 0 ~ 0.5 | 하방 위험 대비 낮은 수익 |
| 0.5 ~ 1.0 | **보통** (대부분의 전략이 여기 속함) |
| 1.0 ~ 2.0 | 우수 |
| 2.0 이상 | 매우 우수 |

#### 실제 예시: 왜 0.6이 나왔는가?
```python
# 실제 백테스트 결과
총 수익률: +15%
기간: 252일
일별 평균 수익률: 0.0595%
무위험 이자율(일): 0.0119%
초과 수익률: 0.0476%

# 손실 분석
전체 거래일: 252일
손실일: 110일 (43.7%)
수익일: 142일 (56.3%)

손실일의 평균 손실: -1.2%
수익일의 평균 수익: +1.5%

# 변동성 계산
전체 표준편차: 1.8%
하방편차: 1.24%

# 결과
샤프 비율 = (0.000476 / 0.018) × 15.87 = 0.42
소르티노 비율 = (0.000476 / 0.0124) × 15.87 = 0.61

→ 소르티노 0.61은 정상적인 값
→ 손실일이 많고(43%), 손실 폭도 크면(-1.2%) 하방편차가 커짐
```

### 개선 방안
소르티노 비율을 높이려면:
1. **손실 빈도 감소**: 손절 기준 강화
2. **손실 크기 제한**: 최대 손실 한도 설정
3. **변동성 관리**: 고변동성 종목 제외
4. **수익 극대화**: 목표 수익률 상향

---

## 3. 트레이너 비율 (Treynor Ratio)

### 정의
**시장 위험(베타) 대비 초과 수익률**을 측정하는 지표입니다.

### 계산식
```
트레이너 비율 = (평균 수익률 - 무위험 이자율) × 252 / 베타
베타 = Cov(포트폴리오 수익률, 시장 수익률) / Var(시장 수익률)
```

### 현재 구현 (⚠️ 제한사항)
```python
# 현재는 시장 데이터가 없으므로 베타=1로 가정
assumed_beta = 1.0  # 향후 KOSPI 지수 데이터 추가 필요
if assumed_beta != 0:
    treynor_ratio = (excess_return * 252) / assumed_beta
```

### 제한사항
- **베타 = 1 고정**: 현재는 시장과 동일한 변동성 가정
- **실제 시장 베타 미반영**: KOSPI 지수 데이터 필요
- **참고용으로만 사용**: 정확한 값이 아님

### 향후 개선 계획
```python
# 향후 구현 예정
kospi_returns = await get_market_data('KOSPI', start_date, end_date)
covariance = np.cov(daily_returns, kospi_returns)[0][1]
market_variance = np.var(kospi_returns)
beta = covariance / market_variance

treynor_ratio = (excess_return * 252) / beta
```

---

## 비교 요약

| 지표 | 측정 대상 | 장점 | 단점 |
|------|----------|------|------|
| **샤프 비율** | 전체 변동성 | 간단, 직관적 | 상승/하락 구분 없음 |
| **소르티노 비율** | 하방 변동성 | 손실만 패널티 | 계산 복잡, 오해 가능 |
| **트레이너 비율** | 시장 위험(베타) | 시스템 위험 반영 | 시장 데이터 필요 |

---

## 실전 해석 가이드

### Case 1: 샤프 0.8, 소르티노 1.2
```
해석: 상방 변동성이 크고, 하방 변동성은 작음
전략: 수익은 크게, 손실은 작게 → 우수한 전략
```

### Case 2: 샤프 0.6, 소르티노 0.5
```
해석: 하방 변동성이 전체 변동성보다 큼
전략: 손실이 집중되고 크게 발생 → 위험한 전략
개선: 손절 기준 강화 필요
```

### Case 3: 샤프 -0.5, 소르티노 -0.3
```
해석: 무위험 자산보다 낮은 수익
전략: 전략 자체가 실패 → 전면 재검토 필요
```

### Case 4: 샤프 2.5, 소르티노 4.0
```
해석: 매우 우수한 전략
전략: 손실이 거의 없고, 수익이 안정적
주의: 과최적화 가능성 검토 필요
```

---

## FAQ

### Q1. 소르티노 비율이 항상 샤프 비율보다 큰가요?
**아니오.** 손실 집중도가 높으면 소르티노 < 샤프일 수 있습니다.

### Q2. 소르티노 비율 0.6은 나쁜 건가요?
**아니오.** 0.5~1.0은 보통 수준입니다. 대부분의 실전 전략이 이 범위에 속합니다.

### Q3. 비율이 음수가 나오는 이유는?
무위험 이자율(3%)보다 낮은 수익을 냈기 때문입니다. 전략 개선이 필요합니다.

### Q4. 트레이너 비율이 매우 큰 값이 나오는 이유는?
베타=1로 가정하고 있어서 실제 값이 아닙니다. 참고용으로만 사용하세요.

### Q5. 어떤 지표를 가장 중요하게 봐야 하나요?
- **초보자**: 샤프 비율
- **중급자**: 소르티노 비율 + 샤프 비율
- **전문가**: 세 가지 모두 + MDD

---

## 계산 검증 예시

### 예시 데이터
```
기간: 2024-01-01 ~ 2024-12-31 (252 거래일)
초기 자본: 10,000,000원
최종 자본: 11,500,000원
총 수익률: +15%

일별 수익률 (처음 10일):
Day 1: +1.2%
Day 2: -0.5%
Day 3: +0.8%
Day 4: -0.3%
Day 5: +2.1%
Day 6: -1.0%
Day 7: +0.6%
Day 8: +1.5%
Day 9: -0.7%
Day 10: +0.9%
...
```

### 1. 샤프 비율 계산
```python
평균 일별 수익률 = 0.0595%
무위험 이자율(일) = 0.0119%
초과 수익률 = 0.0476%
표준편차(일) = 1.8%

샤프 비율 = (0.000476 / 0.018) × √252
         = 0.0264 × 15.87
         = 0.42
```

### 2. 소르티노 비율 계산
```python
# 하방편차 계산
손실 초과일 (무위험이자율 미만):
Day 2: -0.5% - 0.0119% = -0.5119%
Day 4: -0.3% - 0.0119% = -0.3119%
Day 6: -1.0% - 0.0119% = -1.0119%
Day 9: -0.7% - 0.0119% = -0.7119%

하방편차² = [(-0.5119)² + (-0.3119)² + (-1.0119)² + (-0.7119)² + ... ] / 252
하방편차 = 1.24%

소르티노 비율 = (0.000476 / 0.0124) × √252
             = 0.0384 × 15.87
             = 0.61
```

### 3. 결과 해석
```
✓ 샤프 비율 0.42: 보통 수준 (0.5 미만이지만 양수)
✓ 소르티노 비율 0.61: 보통~우수 (샤프보다 높음)
✓ 해석: 손실 관리가 잘 되는 편이지만, 전체 변동성이 높음
✓ 개선: 변동성을 줄이면 두 비율 모두 향상될 것
```

---

## 결론

현재 구현된 리스크 지표는 **금융 업계 표준 공식**을 따르며 정확하게 계산됩니다.

- ✅ **샤프 비율**: 정확한 구현
- ✅ **소르티노 비율**: 정확한 구현 (2025-10-10 수정 완료)
- ⚠️ **트레이너 비율**: 참고용 (베타=1 가정)

**소르티노 비율이 1보다 작다고 해서 문제가 아닙니다.** 대부분의 실전 전략은 0.5~1.5 범위에 있으며, 이는 정상적인 값입니다.

---

*문서 작성일: 2025-10-10*
*백엔드 파일: `backend/backtest/engine.py:519-569`*
