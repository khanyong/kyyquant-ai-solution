# 전략별 자금 할당 실행 프로세스

## 🎯 전체 흐름도

```
1. DB 마이그레이션 실행
   ↓
2. 계좌 잔고 확인
   ↓
3. 전략별 자금 할당 설정
   ↓
4. 할당 비율 검증
   ↓
5. 전략 활성화 및 모니터링
```

---

## 📝 단계별 실행 가이드

### ✅ 단계 1: 데이터베이스 마이그레이션 (최초 1회)

**1-1. Supabase 대시보드 접속**
```
https://supabase.com/dashboard/project/YOUR_PROJECT_ID
```

**1-2. SQL Editor 열기**
- 좌측 메뉴: **SQL Editor** 클릭
- **New query** 버튼 클릭

**1-3. 마이그레이션 SQL 실행**

다음 SQL을 복사해서 붙여넣고 **RUN** 버튼 클릭:

```sql
-- 전략별 자금 할당 기능 추가
ALTER TABLE strategies
ADD COLUMN IF NOT EXISTS allocated_capital DECIMAL(15, 2) DEFAULT 0,
ADD COLUMN IF NOT EXISTS allocated_percent DECIMAL(5, 2) DEFAULT 0;

COMMENT ON COLUMN strategies.allocated_capital IS '전략에 할당된 자금 (원)';
COMMENT ON COLUMN strategies.allocated_percent IS '전체 계좌 잔고 대비 할당 비율 (%)';

ALTER TABLE strategies
ADD CONSTRAINT check_allocated_percent
CHECK (allocated_percent >= 0 AND allocated_percent <= 100);

ALTER TABLE strategies
ADD CONSTRAINT check_allocated_capital
CHECK (allocated_capital >= 0);

CREATE INDEX IF NOT EXISTS idx_strategies_active_allocated
ON strategies(user_id, is_active, allocated_percent)
WHERE is_active = true;

CREATE OR REPLACE VIEW strategy_capital_allocation AS
SELECT
  user_id,
  COUNT(*) as total_strategies,
  COUNT(*) FILTER (WHERE is_active = true) as active_strategies,
  SUM(allocated_capital) FILTER (WHERE is_active = true) as total_allocated_capital,
  SUM(allocated_percent) FILTER (WHERE is_active = true) as total_allocated_percent,
  100 - COALESCE(SUM(allocated_percent) FILTER (WHERE is_active = true), 0) as remaining_percent
FROM strategies
GROUP BY user_id;

COMMENT ON VIEW strategy_capital_allocation IS '사용자별 전략 자금 할당 현황';
```

**1-4. 실행 결과 확인**
```
Success. No rows returned
```
위 메시지가 나오면 성공!

---

### ✅ 단계 2: 계좌 잔고 확인

**2-1. 키움증권 계좌 잔고 조회**

앱 실행 → **계좌 연동** 탭:

```
┌─────────────────────────────────────────┐
│ 💳 키움증권 계좌 연동                    │
├─────────────────────────────────────────┤
│ 계좌번호: 1234567890                     │
│ 예수금:   10,000,000원                   │  ← 이 금액이 총 사용 가능 자금
│ 출금가능: 10,000,000원                   │
└─────────────────────────────────────────┘
```

**중요:** 예수금 또는 출금가능금액이 총 사용 가능 자금입니다.

**2-2. 자금 할당 계획 수립**

예시: 총 10,000,000원

| 전략        | 할당 방식 | 할당 값    | 실제 금액     | 비고          |
|------------|----------|-----------|--------------|--------------|
| RSI 전략    | 비율     | 30%       | 3,000,000원  | 보수적        |
| 골든크로스   | 비율     | 50%       | 5,000,000원  | 주력 전략     |
| 볼린저밴드   | 비율     | 20%       | 2,000,000원  | 분산 투자     |
| **합계**    | -        | **100%**  | **10,000,000원** | -        |

---

### ✅ 단계 3: 전략별 자금 할당 설정

**3-1. 앱 실행 → 자동매매 탭**

```
┌────────────────────────────────────────────┐
│  홈  │  모니터링  │  [자동매매]  │  설정  │
└────────────────────────────────────────────┘
```

**3-2. 전략 생성 또는 수정**

**신규 전략 생성:**
```
[+ 새 전략 만들기] 버튼 클릭
```

**기존 전략 수정:**
```
전략 목록에서 [편집] 아이콘 클릭
```

**3-3. 리스크 관리 섹션으로 스크롤**

전략 설정 화면 아래로 스크롤하면:

```
┌──────────────────────────────────────────────┐
│ 리스크 관리                                   │
├──────────────────────────────────────────────┤
│ 손절 (%)              [====|====]  5%         │
│ 익절 (%)              [========|==] 10%       │
│ 포지션 크기 (%)       [======|====] 20%       │
│ ☐ 트레일링 스탑                               │
├──────────────────────────────────────────────┤
│ 💰 전략별 자금 할당                           │  ← 여기!
├──────────────────────────────────────────────┤
│ 할당 자금 (원)        할당 비율 (%)           │
│ [    0          ] 원  [    30      ] %       │  ← 여기서 설정
└──────────────────────────────────────────────┘

ℹ️ 자금 할당 방식:
• 할당 자금: 정확한 금액 지정 (예: 3,000,000원)
• 할당 비율: 계좌 잔고의 일정 비율 (예: 30%)
• 포지션 크기는 할당된 자금 내에서 계산됩니다
```

**3-4. 자금 할당 입력**

**방법 A: 비율로 입력 (권장)**
```
할당 자금 (원):  [    0          ] 원  (비워둠)
할당 비율 (%):   [    30         ] %   (입력)
```

**방법 B: 고정 금액 입력**
```
할당 자금 (원):  [ 3,000,000    ] 원  (입력)
할당 비율 (%):   [    0         ] %   (비워둠)
```

**3-5. 전략 저장**
```
[💾 전략 저장] 버튼 클릭
```

---

### ✅ 단계 4: 여러 전략에 자금 할당

**4-1. 전략 A (RSI 전략) - 30% 할당**
```
전략 이름: RSI 역전 전략
할당 비율: 30%
포지션 크기: 10%  (할당 자금의 10%)
최대 포지션: 3개

→ 계산:
  - 할당 자금: 10,000,000 × 30% = 3,000,000원
  - 종목당 투자: 3,000,000 × 10% = 300,000원
  - 최대 투자: 300,000 × 3 = 900,000원
```

**4-2. 전략 B (골든크로스) - 50% 할당**
```
전략 이름: 골든크로스 전략
할당 비율: 50%
포지션 크기: 20%
최대 포지션: 5개

→ 계산:
  - 할당 자금: 10,000,000 × 50% = 5,000,000원
  - 종목당 투자: 5,000,000 × 20% = 1,000,000원
  - 최대 투자: 1,000,000 × 5 = 5,000,000원
```

**4-3. 전략 C (볼린저밴드) - 20% 할당**
```
전략 이름: 볼린저밴드 전략
할당 비율: 20%
포지션 크기: 25%
최대 포지션: 2개

→ 계산:
  - 할당 자금: 10,000,000 × 20% = 2,000,000원
  - 종목당 투자: 2,000,000 × 25% = 500,000원
  - 최대 투자: 500,000 × 2 = 1,000,000원
```

---

### ✅ 단계 5: 할당 비율 검증

**5-1. 모니터링 탭에서 확인**

```
┌────────────────────────────────────────────┐
│  홈  │  [모니터링]  │  자동매매  │  설정  │
└────────────────────────────────────────────┘
```

스크롤 내리면:

```
┌─────────────────────────────────────────────┐
│ n8n 워크플로우 활동                          │
├─────────────────────────────────────────────┤
│ ...                                         │
├─────────────────────────────────────────────┤
│ 💰 전략별 자금 할당                          │  ← 여기서 확인
├─────────────────────────────────────────────┤
│ ┌──────────────────┐ ┌──────────────────┐  │
│ │ RSI 역전 전략    │ │ 골든크로스       │  │
│ │ 3,000,000원 30% │ │ 5,000,000원 50%  │  │
│ └──────────────────┘ └──────────────────┘  │
│ ┌──────────────────┐                       │
│ │ 볼린저밴드       │                       │
│ │ 2,000,000원 20% │                       │
│ └──────────────────┘                       │
└─────────────────────────────────────────────┘
```

**5-2. 총합 확인**

개발자 도구 콘솔에서 확인 (F12):

```javascript
// Supabase에서 직접 조회
const { data } = await supabase
  .from('strategy_capital_allocation')
  .select('*')

console.log(data)
// {
//   total_strategies: 3,
//   active_strategies: 3,
//   total_allocated_percent: 100,  ← 총 할당 비율
//   remaining_percent: 0           ← 남은 비율
// }
```

**5-3. 할당 오류 확인**

만약 총합이 100%를 초과하면:

```
❌ 오류: 전체 할당 비율이 110%로 100%를 초과합니다.

→ 해결: 각 전략의 할당 비율을 조정하세요
```

---

### ✅ 단계 6: 전략 활성화

**6-1. 자동매매 탭에서 전략 활성화**

```
┌────────────────────────────────────────────┐
│ 전략 목록                                   │
├────────────────────────────────────────────┤
│ RSI 역전 전략        [🟢 활성화]           │
│ 할당: 30% (3,000,000원)                    │
├────────────────────────────────────────────┤
│ 골든크로스          [⚪ 비활성]  ← 클릭     │
│ 할당: 50% (5,000,000원)                    │
└────────────────────────────────────────────┘
```

**6-2. n8n 워크플로우 확인**

n8n 대시보드에서 워크플로우가 전략별 할당 자금을 읽어오는지 확인:

```javascript
// n8n Function 노드
const strategy = $input.item.json

// 할당 자금 계산
let allocatedCapital = 0
if (strategy.allocated_capital > 0) {
  allocatedCapital = strategy.allocated_capital
} else if (strategy.allocated_percent > 0) {
  const accountBalance = 10000000  // 계좌 잔고
  allocatedCapital = accountBalance * strategy.allocated_percent / 100
}

// 주문 금액 계산
const orderAmount = allocatedCapital * strategy.positionSize / 100

console.log(`전략: ${strategy.name}`)
console.log(`할당 자금: ${allocatedCapital}원`)
console.log(`주문 금액: ${orderAmount}원`)
```

---

### ✅ 단계 7: 실시간 모니터링

**7-1. 모니터링 탭 확인**

```
┌─────────────────────────────────────────────┐
│ 실시간 매매 신호                             │
├─────────────────────────────────────────────┤
│ 종목    신호  전략          현재가  거래량   │
├─────────────────────────────────────────────┤
│ 삼성전자 BUY  RSI 역전      75,000  1.2M    │
│         (할당: 3,000,000원 중 300,000원 사용) │  ← 할당 자금 내 사용
├─────────────────────────────────────────────┤
│ SK하이닉스 BUY 골든크로스   130,000 800K    │
│         (할당: 5,000,000원 중 1,000,000원 사용)│
└─────────────────────────────────────────────┘
```

---

## 🔍 자주 묻는 질문

### Q1. 잔고는 어디서 나눌 수 있나요?

**A:** 잔고는 **각 전략을 만들거나 수정할 때** 나눕니다.

위치: **자동매매 탭** → **전략 편집** → **리스크 관리 섹션** → **💰 전략별 자금 할당**

### Q2. 비율과 금액 중 어떤 걸 사용해야 하나요?

**A:** **비율(%) 사용을 권장**합니다.

이유:
- 계좌 잔고가 변해도 자동으로 비율 유지
- 여러 전략 간 균형 유지 쉬움
- 총합 100% 계산이 직관적

### Q3. 100%를 다 할당하지 않아도 되나요?

**A:** 네, 80-100% 사이를 권장합니다.

- 100%: 모든 자금 활용 (적극적)
- 80%: 20% 현금 보유 (보수적)
- 50% 이하: 너무 보수적, 자금 유휴

### Q4. 전략이 3개인데 각각 50%씩 할당하면?

**A:** ❌ 오류 발생

```
총 할당: 50% + 50% + 50% = 150%
→ "전체 할당 비율이 150%로 100%를 초과합니다" 에러
```

해결: 각 33.3%로 조정

### Q5. 할당 자금이 부족하면 어떻게 되나요?

**A:** 해당 전략은 매수 신호를 생성하지 않습니다.

예:
```
전략: RSI 역전
할당 자금: 500,000원
매수 신호: 삼성전자 (700,000원 필요)

→ 자금 부족으로 주문 스킵
→ 로그: "할당 자금 부족: 필요 700,000원 / 가용 500,000원"
```

### Q6. 실시간으로 할당을 변경할 수 있나요?

**A:** 네, 언제든 변경 가능합니다.

```
1. 자동매매 탭 → 전략 편집
2. 할당 비율 수정
3. 저장
4. 다음 신호부터 새 할당 비율 적용
```

---

## ⚠️ 주의사항

1. **총 할당 비율 > 100% 금지**
   - 각 전략 할당 비율 합이 100% 이하여야 함

2. **단일 전략에 과도 집중 지양**
   - 한 전략에 50% 이상 집중 시 리스크 증가

3. **활성화된 전략만 체크**
   - 비활성 전략의 할당은 무시됨

4. **계좌 잔고 변동 고려**
   - 잔고가 줄면 할당 자금도 자동 감소 (비율 모드)

---

## 📊 실전 예시

### 시나리오: 10,000,000원 보유

**설정:**

| 전략          | 할당    | 포지션 크기 | 최대 포지션 |
|--------------|--------|-----------|-----------|
| RSI 역전      | 30%    | 10%       | 3개       |
| 골든크로스     | 40%    | 20%       | 5개       |
| 볼린저밴드     | 20%    | 25%       | 2개       |
| **미할당**    | 10%    | -         | -         |

**계산:**

```
RSI 역전:
  - 할당: 3,000,000원
  - 종목당: 300,000원
  - 최대: 900,000원

골든크로스:
  - 할당: 4,000,000원
  - 종목당: 800,000원
  - 최대: 4,000,000원

볼린저밴드:
  - 할당: 2,000,000원
  - 종목당: 500,000원
  - 최대: 1,000,000원

현금 보유: 1,000,000원
```

**최대 동시 사용 자금:**
```
900,000 + 4,000,000 + 1,000,000 = 5,900,000원
```

안전 마진 41% 확보! ✅

---

## 🎓 추천 전략 조합

### 보수형 (리스크 낮음)
```
전략 A (가치투자): 40%
전략 B (배당주):   30%
전략 C (안전자산): 20%
현금 보유:         10%
```

### 균형형 (중간 리스크)
```
전략 A (장기):     35%
전략 B (중기):     35%
전략 C (단기):     20%
현금 보유:         10%
```

### 공격형 (리스크 높음)
```
전략 A (성장주):   40%
전략 B (모멘텀):   40%
전략 C (스윙):     15%
현금 보유:          5%
```

---

더 궁금한 점이 있으시면 말씀해주세요!
