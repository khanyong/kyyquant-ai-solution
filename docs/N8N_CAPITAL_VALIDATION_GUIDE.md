# n8n ì›Œí¬í”Œë¡œìš° ìê¸ˆ ê²€ì¦ í†µí•© ê°€ì´ë“œ

## ğŸ¯ ëª©ì 

ì „ëµë³„ë¡œ í• ë‹¹ëœ ìê¸ˆì„ ì´ˆê³¼í•˜ì§€ ì•Šë„ë¡ ë§¤ìˆ˜ ì „ ìë™ ê²€ì¦í•˜ëŠ” ì‹œìŠ¤í…œ êµ¬ì¶•

---

## ğŸ“‹ ì „ì²´ ì›Œí¬í”Œë¡œìš° êµ¬ì¡°

```
1. ë§¤ìˆ˜ ì‹ í˜¸ ë°œìƒ (ê¸°ì¡´)
   â†“
2. ğŸ†• ì „ëµ ìê¸ˆ ê²€ì¦ (ìƒˆë¡œ ì¶”ê°€)
   â†“
3-A. âœ… ìê¸ˆ ì¶©ë¶„ â†’ ë§¤ìˆ˜ ì§„í–‰
   â†“
3-B. âŒ ìê¸ˆ ë¶€ì¡± â†’ ì£¼ë¬¸ ìŠ¤í‚µ (ë¡œê·¸ ê¸°ë¡)
```

---

## ğŸ› ï¸ êµ¬í˜„ ë‹¨ê³„

### Step 1: Supabase Function ë…¸ë“œ ì¶”ê°€

ì›Œí¬í”Œë¡œìš°ì—ì„œ ë§¤ìˆ˜ ì‹ í˜¸ ë‹¤ìŒì— **Supabase** ë…¸ë“œ ì¶”ê°€:

**ë…¸ë“œ ì´ë¦„:** `ìê¸ˆ ê²€ì¦`

**ì„¤ì •:**
- **Operation:** `Invoke a Postgres function (rpc)`
- **Function:** `check_strategy_capital`
- **Parameters:**

```json
{
  "p_strategy_id": "{{ $json.strategy_id }}",
  "p_order_amount": "{{ $json.order_amount }}",
  "p_account_balance": "{{ $json.account_balance }}"
}
```

**Parameters ì„¤ëª…:**
- `p_strategy_id`: í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ì „ëµ ID
- `p_order_amount`: ë§¤ìˆ˜í•˜ë ¤ëŠ” ê¸ˆì•¡ (ì¢…ëª©ê°€ê²© Ã— ìˆ˜ëŸ‰)
- `p_account_balance`: í˜„ì¬ ê³„ì¢Œ ì”ê³  (í‚¤ì›€ì¦ê¶Œ ì˜ˆìˆ˜ê¸ˆ)

---

### Step 2: Function ë…¸ë“œë¡œ ê²€ì¦ ê²°ê³¼ ì²˜ë¦¬

**ë…¸ë“œ ì´ë¦„:** `ê²€ì¦ ê²°ê³¼ í™•ì¸`

**Code:**

```javascript
// ì´ì „ ë…¸ë“œì—ì„œ ì „ë‹¬ë°›ì€ ê²€ì¦ ê²°ê³¼
const checkResult = $input.item.json

// ë§¤ìˆ˜ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
if (!checkResult.allowed) {
  // âŒ ìê¸ˆ ë¶€ì¡± - ì£¼ë¬¸ ìŠ¤í‚µ
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
  console.log('âŒ ë§¤ìˆ˜ ë¶ˆê°€ - ìê¸ˆ ë¶€ì¡±')
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
  console.log('ì „ëµ:', checkResult.strategy_name)
  console.log('ì‚¬ìœ :', checkResult.reason)
  console.log('ì´ í• ë‹¹:', checkResult.total_allocated?.toLocaleString(), 'ì›')
  console.log('ì‚¬ìš© ì¤‘:', checkResult.capital_in_use?.toLocaleString(), 'ì›')
  console.log('ê°€ìš© ìê¸ˆ:', checkResult.available_capital?.toLocaleString(), 'ì›')
  console.log('ì£¼ë¬¸ ê¸ˆì•¡:', checkResult.order_amount?.toLocaleString(), 'ì›')
  console.log('ë¶€ì¡± ê¸ˆì•¡:', checkResult.shortfall?.toLocaleString(), 'ì›')
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')

  // ìŠ¤í‚µ ì²˜ë¦¬ (ë‹¤ìŒ ë…¸ë“œë¡œ ì „ë‹¬í•˜ì§€ ì•ŠìŒ)
  return {
    json: {
      skipped: true,
      reason: checkResult.reason,
      strategy_name: checkResult.strategy_name,
      shortfall: checkResult.shortfall
    }
  }
}

// âœ… ìê¸ˆ ì¶©ë¶„ - ë§¤ìˆ˜ ì§„í–‰
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
console.log('âœ… ë§¤ìˆ˜ ê°€ëŠ¥')
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')
console.log('ì „ëµ:', checkResult.strategy_name)
console.log('ì´ í• ë‹¹:', checkResult.total_allocated?.toLocaleString(), 'ì›')
console.log('ì‚¬ìš© ì¤‘:', checkResult.capital_in_use?.toLocaleString(), 'ì›')
console.log('ê°€ìš© ìê¸ˆ:', checkResult.available_capital?.toLocaleString(), 'ì›')
console.log('ì£¼ë¬¸ ê¸ˆì•¡:', checkResult.order_amount?.toLocaleString(), 'ì›')
console.log('ì£¼ë¬¸ í›„ ì”ì•¡:', checkResult.remaining_after_order?.toLocaleString(), 'ì›')
console.log('í™œì„± í¬ì§€ì…˜:', checkResult.active_positions, 'ê°œ')
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”')

// ë§¤ìˆ˜ ì§„í–‰ (ì›ë˜ ë°ì´í„°ì— ê²€ì¦ ì •ë³´ ì¶”ê°€)
return {
  json: {
    ...checkResult,
    proceed_to_buy: true,
    original_data: $input.item.json
  }
}
```

---

### Step 3: IF ë…¸ë“œë¡œ ë¶„ê¸° ì²˜ë¦¬

**ë…¸ë“œ ì´ë¦„:** `ë§¤ìˆ˜ ì§„í–‰ ì—¬ë¶€`

**ì„¤ì •:**
- **Conditions:**
  - `{{ $json.proceed_to_buy }}` **equals** `true`

**ì—°ê²°:**
- **True â†’ í‚¤ì›€ ë§¤ìˆ˜ API ë…¸ë“œ**
- **False â†’ ìŠ¤í‚µ ë¡œê·¸ ê¸°ë¡ ë…¸ë“œ**

---

### Step 4: ìŠ¤í‚µ ë¡œê·¸ ê¸°ë¡ (ì„ íƒ)

ìê¸ˆ ë¶€ì¡±ìœ¼ë¡œ ìŠ¤í‚µëœ ê²½ìš° ë¡œê·¸ ì €ì¥:

**ë…¸ë“œ ì´ë¦„:** `ìŠ¤í‚µ ë¡œê·¸ ì €ì¥`

**Supabase Insert:**

```json
{
  "table": "trading_logs",
  "records": {
    "strategy_id": "{{ $json.strategy_id }}",
    "event_type": "order_skipped",
    "reason": "insufficient_capital",
    "details": {
      "strategy_name": "{{ $json.strategy_name }}",
      "shortfall": "{{ $json.shortfall }}",
      "available_capital": "{{ $json.available_capital }}",
      "order_amount": "{{ $json.order_amount }}"
    },
    "created_at": "{{ $now }}"
  }
}
```

---

## ğŸ” ì „ì²´ ë…¸ë“œ êµ¬ì„± ì˜ˆì‹œ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ë§¤ìˆ˜ ì‹ í˜¸ ë°œìƒ                                    â”‚
â”‚    (ê¸°ì¡´ ì‹ í˜¸ ìƒì„± ë¡œì§)                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. ì£¼ë¬¸ ê¸ˆì•¡ ê³„ì‚°                                    â”‚
â”‚    Function ë…¸ë“œ                                     â”‚
â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚    const price = $json.current_price                â”‚
â”‚    const quantity = 10                              â”‚
â”‚    const orderAmount = price * quantity             â”‚
â”‚    return { ...data, order_amount: orderAmount }    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ğŸ†• ìê¸ˆ ê²€ì¦                                      â”‚
â”‚    Supabase RPC ë…¸ë“œ                                 â”‚
â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚    Function: check_strategy_capital                 â”‚
â”‚    Params: {                                        â”‚
â”‚      p_strategy_id,                                 â”‚
â”‚      p_order_amount,                                â”‚
â”‚      p_account_balance                              â”‚
â”‚    }                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. ê²€ì¦ ê²°ê³¼ í™•ì¸                                    â”‚
â”‚    Function ë…¸ë“œ                                     â”‚
â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚    if (!checkResult.allowed) {                      â”‚
â”‚      return { skipped: true, ... }                  â”‚
â”‚    }                                                â”‚
â”‚    return { proceed_to_buy: true, ... }             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. ë§¤ìˆ˜ ì§„í–‰ ì—¬ë¶€                                    â”‚
â”‚    IF ë…¸ë“œ                                           â”‚
â”‚    â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚
â”‚    Condition: proceed_to_buy == true                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â†“ True                   â†“ False
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6-A. í‚¤ì›€ ë§¤ìˆ˜    â”‚   â”‚ 6-B. ìŠ¤í‚µ ë¡œê·¸ ì €ì¥        â”‚
â”‚      API í˜¸ì¶œ     â”‚   â”‚      (Supabase Insert)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ’¡ ì‹¤ì œ ì‚¬ìš© ì˜ˆì‹œ

### ì˜ˆì‹œ 1: ìê¸ˆ ì¶©ë¶„ - ë§¤ìˆ˜ ì§„í–‰

**ì…ë ¥ ë°ì´í„°:**
```json
{
  "strategy_id": "abc-123",
  "stock_code": "005930",
  "stock_name": "ì‚¼ì„±ì „ì",
  "current_price": 75000,
  "quantity": 10,
  "order_amount": 750000,
  "account_balance": 10000000
}
```

**ê²€ì¦ ê²°ê³¼:**
```json
{
  "allowed": true,
  "strategy_name": "ê³¨ë“ í¬ë¡œìŠ¤",
  "total_allocated": 3000000,
  "capital_in_use": 1500000,
  "available_capital": 1500000,
  "order_amount": 750000,
  "remaining_after_order": 750000,
  "active_positions": 2
}
```

**ë¡œê·¸ ì¶œë ¥:**
```
âœ… ë§¤ìˆ˜ ê°€ëŠ¥
ì „ëµ: ê³¨ë“ í¬ë¡œìŠ¤
ì´ í• ë‹¹: 3,000,000 ì›
ì‚¬ìš© ì¤‘: 1,500,000 ì›
ê°€ìš© ìê¸ˆ: 1,500,000 ì›
ì£¼ë¬¸ ê¸ˆì•¡: 750,000 ì›
ì£¼ë¬¸ í›„ ì”ì•¡: 750,000 ì›
í™œì„± í¬ì§€ì…˜: 2 ê°œ
```

**ê²°ê³¼:** í‚¤ì›€ ë§¤ìˆ˜ API í˜¸ì¶œ â†’ ë§¤ìˆ˜ ì²´ê²°

---

### ì˜ˆì‹œ 2: ìê¸ˆ ë¶€ì¡± - ì£¼ë¬¸ ìŠ¤í‚µ

**ì…ë ¥ ë°ì´í„°:**
```json
{
  "strategy_id": "abc-123",
  "stock_code": "000660",
  "stock_name": "SKí•˜ì´ë‹‰ìŠ¤",
  "current_price": 150000,
  "quantity": 20,
  "order_amount": 3000000,
  "account_balance": 10000000
}
```

**ê²€ì¦ ê²°ê³¼:**
```json
{
  "allowed": false,
  "reason": "í• ë‹¹ ìê¸ˆ ë¶€ì¡±",
  "strategy_name": "ê³¨ë“ í¬ë¡œìŠ¤",
  "total_allocated": 3000000,
  "capital_in_use": 2500000,
  "available_capital": 500000,
  "order_amount": 3000000,
  "shortfall": 2500000
}
```

**ë¡œê·¸ ì¶œë ¥:**
```
âŒ ë§¤ìˆ˜ ë¶ˆê°€ - ìê¸ˆ ë¶€ì¡±
ì „ëµ: ê³¨ë“ í¬ë¡œìŠ¤
ì‚¬ìœ : í• ë‹¹ ìê¸ˆ ë¶€ì¡±
ì´ í• ë‹¹: 3,000,000 ì›
ì‚¬ìš© ì¤‘: 2,500,000 ì›
ê°€ìš© ìê¸ˆ: 500,000 ì›
ì£¼ë¬¸ ê¸ˆì•¡: 3,000,000 ì›
ë¶€ì¡± ê¸ˆì•¡: 2,500,000 ì›
```

**ê²°ê³¼:** ì£¼ë¬¸ ìŠ¤í‚µ â†’ ë¡œê·¸ë§Œ ê¸°ë¡

---

## ğŸ”§ ê³„ì¢Œ ì”ê³  ê°€ì ¸ì˜¤ê¸°

n8nì—ì„œ í‚¤ì›€ì¦ê¶Œ ê³„ì¢Œ ì”ê³ ë¥¼ ê°€ì ¸ì˜¤ëŠ” ë°©ë²•:

### ë°©ë²• 1: Supabaseì—ì„œ ì¡°íšŒ

```javascript
// kw_account_balance í…Œì´ë¸”ì—ì„œ ìµœì‹  ì”ê³  ì¡°íšŒ
const { data } = await $supabase
  .from('kw_account_balance')
  .select('deposited_amount')
  .order('updated_at', { ascending: false })
  .limit(1)
  .single()

const accountBalance = data?.deposited_amount || 0

return {
  json: {
    ...originalData,
    account_balance: accountBalance
  }
}
```

### ë°©ë²• 2: í‚¤ì›€ API ì§ì ‘ í˜¸ì¶œ

```javascript
// í‚¤ì›€ Open API ì„œë²„ì— HTTP ìš”ì²­
const response = await fetch('http://localhost:8001/api/kiwoom/balance')
const data = await response.json()

const accountBalance = data.deposited_amount || 0

return {
  json: {
    ...originalData,
    account_balance: accountBalance
  }
}
```

---

## âš™ï¸ ì„¤ì • íŒ

### 1. ë¹„ìœ¨ ëª¨ë“œ vs ê³ ì • ê¸ˆì•¡ ëª¨ë“œ

**ë¹„ìœ¨ ëª¨ë“œ (ê¶Œì¥):**
```javascript
// ê³„ì¢Œ ì”ê³ ì˜ 30%ë¥¼ ì´ ì „ëµì— í• ë‹¹
{
  allocated_percent: 30,
  allocated_capital: 0
}
```
â†’ ê³„ì¢Œ ì”ê³ ê°€ ë³€í•´ë„ ìë™ìœ¼ë¡œ ë¹„ìœ¨ ìœ ì§€

**ê³ ì • ê¸ˆì•¡ ëª¨ë“œ:**
```javascript
// ì •í™•íˆ 3,000,000ì›ë§Œ ì‚¬ìš©
{
  allocated_capital: 3000000,
  allocated_percent: 0
}
```
â†’ ê³„ì¢Œ ì”ê³  ë³€ë™ ë¬´ê´€, ê³ ì • ê¸ˆì•¡ ì‚¬ìš©

### 2. í• ë‹¹ ì—†ìŒ (ë¬´ì œí•œ)

```javascript
{
  allocated_capital: 0,
  allocated_percent: 0
}
```
â†’ ìê¸ˆ ê²€ì¦ í†µê³¼, ê³„ì¢Œ ì”ê³  ì „ì²´ ì‚¬ìš© ê°€ëŠ¥

---

## ğŸ“Š ëª¨ë‹ˆí„°ë§

### UIì—ì„œ ì‹¤ì‹œê°„ í™•ì¸

ì•±ì˜ **ëª¨ë‹ˆí„°ë§** íƒ­ ë˜ëŠ” **ìë™ë§¤ë§¤** íƒ­ì— `StrategyCapitalStatus` ì»´í¬ë„ŒíŠ¸ ì¶”ê°€:

```tsx
import StrategyCapitalStatus from '@/components/StrategyCapitalStatus'

// ëª¨ë‹ˆí„°ë§ í˜ì´ì§€ì— ì¶”ê°€
<StrategyCapitalStatus />
```

**í‘œì‹œ ë‚´ìš©:**
- ì „ëµë³„ ì´ í• ë‹¹ ìê¸ˆ
- í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ìê¸ˆ
- ê°€ìš© ìê¸ˆ
- ì‚¬ìš©ë¥  (%)
- í™œì„± í¬ì§€ì…˜ ê°œìˆ˜
- ì´ ì†ìµ

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. ë™ì‹œ ë§¤ìˆ˜ ì²˜ë¦¬

ì—¬ëŸ¬ ì‹ í˜¸ê°€ ë™ì‹œì— ë°œìƒí•˜ë©´ ê²½ìŸ ì¡°ê±´(race condition) ë°œìƒ ê°€ëŠ¥:

```
ì‹œê°„ T:
  - ì‹ í˜¸ A: ê°€ìš© ìê¸ˆ 1,000,000ì› í™•ì¸ â†’ í†µê³¼
  - ì‹ í˜¸ B: ê°€ìš© ìê¸ˆ 1,000,000ì› í™•ì¸ â†’ í†µê³¼

ì‹œê°„ T+1:
  - ì‹ í˜¸ A ë§¤ìˆ˜ ì²´ê²° â†’ ê°€ìš© ìê¸ˆ 0ì›
  - ì‹ í˜¸ B ë§¤ìˆ˜ ì²´ê²° ì‹œë„ â†’ ì‹¤íŒ¨! (ìê¸ˆ ë¶€ì¡±)
```

**í•´ê²°ì±…:**
- n8n ì›Œí¬í”Œë¡œìš°ì— **Queue ëª¨ë“œ** ì„¤ì •
- ë˜ëŠ” DB ë ˆë²¨ ë½ ì‚¬ìš© (ê³ ê¸‰)

### 2. ê³„ì¢Œ ì”ê³  ë™ê¸°í™”

ê³„ì¢Œ ì”ê³ ëŠ” ìµœì‹  ìƒíƒœì—¬ì•¼ ì •í™•í•œ ê²€ì¦ ê°€ëŠ¥:

```javascript
// ì”ê³  ìºì‹œ ì‹œê°„ ì²´í¬ (5ë¶„ ì´ë‚´ë§Œ ì‚¬ìš©)
const balanceAge = Date.now() - balanceUpdatedAt
if (balanceAge > 5 * 60 * 1000) {
  // 5ë¶„ ì´ˆê³¼ â†’ ìµœì‹  ì”ê³  ë‹¤ì‹œ ì¡°íšŒ
  await refreshBalance()
}
```

### 3. ìŠ¬ë¦¬í”¼ì§€ ê³ ë ¤

ì‹¤ì œ ì²´ê²°ê°€ëŠ” ì˜ˆìƒê°€ì™€ ë‹¤ë¥¼ ìˆ˜ ìˆìŒ:

```javascript
// ìŠ¬ë¦¬í”¼ì§€ 2% ì—¬ìœ  ë‘ê¸°
const bufferRate = 1.02
const safeOrderAmount = orderAmount * bufferRate

const checkResult = await check_strategy_capital(
  strategyId,
  safeOrderAmount,  // ì—¬ìœ ìˆê²Œ ê²€ì¦
  accountBalance
)
```

---

## ğŸ“ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### ì‹œë‚˜ë¦¬ì˜¤ 1: ì •ìƒ ë§¤ìˆ˜

```
1. ì „ëµ A (30% í• ë‹¹, ì”ê³  10,000,000ì› â†’ 3,000,000ì›)
2. í˜„ì¬ ì‚¬ìš© ì¤‘: 1,000,000ì›
3. ê°€ìš©: 2,000,000ì›
4. ë§¤ìˆ˜ ì‹œë„: 1,500,000ì›
5. ê²°ê³¼: âœ… í†µê³¼ (1,500,000 < 2,000,000)
```

### ì‹œë‚˜ë¦¬ì˜¤ 2: ìê¸ˆ ë¶€ì¡±

```
1. ì „ëµ A (30% í• ë‹¹ â†’ 3,000,000ì›)
2. í˜„ì¬ ì‚¬ìš© ì¤‘: 2,800,000ì›
3. ê°€ìš©: 200,000ì›
4. ë§¤ìˆ˜ ì‹œë„: 1,500,000ì›
5. ê²°ê³¼: âŒ ì°¨ë‹¨ (1,500,000 > 200,000)
```

### ì‹œë‚˜ë¦¬ì˜¤ 3: ë§¤ë„ í›„ ìê¸ˆ ì¦ê°€

```
1. ì „ëµ A ê°€ìš© ìê¸ˆ: 200,000ì›
2. í¬ì§€ì…˜ ë§¤ë„ (+1,500,000ì› íšŒìˆ˜)
3. ì „ëµ A ê°€ìš© ìê¸ˆ: 1,700,000ì›
4. ìƒˆ ë§¤ìˆ˜ ì‹œë„: 1,500,000ì›
5. ê²°ê³¼: âœ… í†µê³¼ (ìë™ ë°˜ì˜ë¨)
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

- [ì „ëµë³„ ìê¸ˆ ê´€ë¦¬ ì‹œìŠ¤í…œ ì„¤ê³„](./STRATEGY_CAPITAL_MANAGEMENT.md)
- [ìê¸ˆ í• ë‹¹ ê°€ì´ë“œ](./CAPITAL_ALLOCATION_GUIDE.md)
- [Supabase RPC Functions](https://supabase.com/docs/guides/database/functions)

---

êµ¬í˜„ í›„ ì˜ë¬¸ì‚¬í•­ì´ ìˆìœ¼ë©´ ì–¸ì œë“ ì§€ ë¬¸ì˜í•˜ì„¸ìš”!
